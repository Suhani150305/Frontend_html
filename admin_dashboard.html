
<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* --- FIX CHECKBOX LAYOUT --- */
    .modal-content input[type="checkbox"] {
        width: auto !important;
        display: inline-block !important;
        margin: 0 10px 0 0 !important;
        height: auto !important;
        transform: scale(1.2);
        cursor: pointer;
    }
    .checkbox-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 15px;
        color: #334155;
        cursor: pointer;
    }
    .checkbox-row label { cursor: pointer; width: 100%; }

    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <i class="fas fa-university"></i> EduAchieve
  </div>

  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)">
      <i class="fas fa-chart-line"></i> Dashboard
    </button>
    <button class="menu-item" onclick="switchTab('faculty', this)">
      <i class="fas fa-chalkboard-teacher"></i> Faculty List
    </button>
    <button class="menu-item" onclick="switchTab('students', this)">
      <i class="fas fa-user-graduate"></i> Students
    </button>
    <button class="menu-item" onclick="switchTab('allocations', this)">
      <i class="fas fa-link"></i> Allocations
    </button>
    <button class="menu-item" onclick="switchTab('security', this)">
      <i class="fas fa-shield-alt"></i> Security
    </button>
  </div>

  <button class="menu-item logout-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Logout
  </button>

  <button class="menu-item logout-btn" onclick="resetSystem()">
    <i class="fas fa-trash"></i> Reset System
  </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item (Unassigned Students)</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option>
          <option value="CE">CE</option>
          <option value="IT">IT</option>
          <option value="CSBS">CSBS</option>
          <option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">
          <i class="fas fa-redo"></i> Clear
        </button>
        <button class="btn btn-primary" onclick="openFacultyModal()">
          + Add Faculty
        </button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Dept</th>
          <th>Assigned Roles</th>
          <th>Notify</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="facultyList">
        <tr><td colspan="5">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Departments</option>
          <option value="CE">CE</option>
          <option value="IT">IT</option>
          <option value="CSBS">CSBS</option>
          <option value="AI">AI</option>
        </select>

        <select id="studentFilterSem" onchange="renderStudents()">
          <option value="all">All Semesters</option>
          <option value="1">Sem 1</option>
          <option value="2">Sem 2</option>
          <option value="3">Sem 3</option>
          <option value="4">Sem 4</option>
          <option value="5">Sem 5</option>
          <option value="6">Sem 6</option>
          <option value="7">Sem 7</option>
          <option value="8">Sem 8</option>
        </select>

        <button class="btn btn-secondary" onclick="clearStudentFilters()">
          <i class="fas fa-redo"></i> Clear
        </button>

        <button class="btn btn-primary" onclick="openStudentModal()">
          + Add Student
        </button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Roll No</th>
          <th>Sem</th>
          <th>Dept</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentList">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">
          <i class="fas fa-print"></i> Print PDF
        </button>

        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option>
          <option value="CE">CE</option>
          <option value="IT">IT</option>
          <option value="CSBS">CSBS</option>
          <option value="AI">AI</option>
        </select>

        <select id="allocFilterSem" onchange="renderAllocations()">
          <option value="all">All Semesters</option>
          <option value="1">Sem 1</option>
          <option value="2">Sem 2</option>
          <option value="3">Sem 3</option>
          <option value="4">Sem 4</option>
          <option value="5">Sem 5</option>
          <option value="6">Sem 6</option>
          <option value="7">Sem 7</option>
          <option value="8">Sem 8</option>
        </select>
        
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">
          <i class="fas fa-magic"></i> Auto-Allocate
        </button>

        <button class="btn btn-primary" onclick="openAllocationModal()">
          + Assign
        </button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Student</th>
          <th>Roll No</th>
          <th>Sem</th>
          <th>Proctor</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="allocationList">
        <tr><td colspan="5">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2>Security</h2>
    <p>Admin-only actions enabled.</p>
  </div>
</div>

</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    
    <select id="fDept">
        <option value="" disabled selected>Select Department</option>
        <option value="CE">CE</option>
        <option value="IT">IT</option>
        <option value="CSBS">CSBS</option>
        <option value="AI">AI</option>
    </select>
    
    <label style="display:block; margin-top:15px; margin-bottom:10px; font-weight:600; color:#475569;">Assign Roles:</label>
    
    <div class="checkbox-row">
        <input type="checkbox" id="fRoleHOD"> 
        <label for="fRoleHOD">Head of Dept (HOD)</label>
    </div>
    
    <div class="checkbox-row">
        <input type="checkbox" id="fRoleCoord"> 
        <label for="fRoleCoord">Achievement Coordinator</label>
    </div>
    
    <div class="checkbox-row">
        <input type="checkbox" id="fRoleProctor"> 
        <label for="fRoleProctor">Proctor</label>
    </div>

    <div class="modal-btns">
      <button class="btn btn-primary" onclick="saveFaculty()">Save</button>
      <button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name">
    <input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem">
      <option value="1">Sem 1</option><option value="2">Sem 2</option>
      <option value="3">Sem 3</option><option value="4">Sem 4</option>
      <option value="5">Sem 5</option><option value="6">Sem 6</option>
      <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <select id="sDept">
      <option value="CE">CE</option><option value="IT">IT</option>
      <option value="CSBS">CSBS</option><option value="AI">AI</option>
    </select>
    <select id="sStatus">
      <option value="Enrolled">Enrolled</option>
      <option value="On Leave">On Leave</option>
      <option value="Graduated">Graduated</option>
    </select>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="saveStudent()">Save</button>
      <button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label> <input type="text" id="editSName">
    <label>Roll No</label> <input type="text" id="editSRoll">
    <label>Semester</label>
    <select id="editSSem">
      <option value="1">Sem 1</option><option value="2">Sem 2</option>
      <option value="3">Sem 3</option><option value="4">Sem 4</option>
      <option value="5">Sem 5</option><option value="6">Sem 6</option>
      <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <label>Department</label>
    <select id="editSDept">
      <option value="CE">CE</option><option value="IT">IT</option>
      <option value="CSBS">CSBS</option><option value="AI">AI</option>
    </select>
    <label>Status</label>
    <select id="editSStatus">
      <option value="Enrolled">Enrolled</option>
      <option value="On Leave">On Leave</option>
      <option value="Graduated">Graduated</option>
    </select>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="updateStudent()">Update</button>
      <button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor</h3>
    
    <label>Student</label>
    <select id="allocStudent"></select>
    
    <label>Proctor</label>
    <select id="allocFaculty"></select>
    
    <div class="modal-btns">
      <button id="btnAssignProctor" class="btn btn-primary" onclick="saveAllocation()">Assign</button>
      <button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button>
    </div>
  </div>
</div>


<script>
/* ================= TAB SWITCH ================= */
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");

  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

/* ================= DASHBOARD ================= */
async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());

  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

/* ================= FACULTY ================= */
let allFaculty = [];

async function loadFaculty() {
  try {
      const res = await fetch("http://localhost:5000/faculty");
      allFaculty = await res.json();
      renderFaculty();
  } catch (e) {
      console.error("Error loading faculty:", e);
  }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch")?.value.toLowerCase() || "";
  const dept = document.getElementById("facultyFilterDept")?.value || "all";
  const body = document.getElementById("facultyList");
  body.innerHTML = "";

  const filtered = allFaculty.filter(f => {
    const matchName = f.name.toLowerCase().includes(search);
    const matchDept = dept === "all" || (f.dept && f.dept === dept);
    return matchName && matchDept;
  });

  if (filtered.length === 0) {
    body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`;
    return;
  }

  filtered.forEach(f => {
    // Generate Role Badges
    let roles = [];
    const r = f.roles || { proctor: f.isProctor || false, hod: false, coordinator: false };
    
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push('<span class="status-pill status-proctor">Proctor</span>');
    
    // Default Role
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';

    body.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${f.dept}</td>
        <td>${roleDisplay}</td>
        <td style="display:flex; gap:12px; align-items:center;">
          <a href="mailto:${f.email || 'admin@eduachieve.com'}?subject=Proctor Assignment" title="Send Email">
            <i class="fas fa-envelope" style="color:#4e73df;"></i>
          </a>
          <a href="https://wa.me/919999999999" target="_blank" title="Send WhatsApp">
            <i class="fab fa-whatsapp" style="color:#25D366;"></i>
          </a>
        </td>
        <td>
          <button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

function clearFacultyFilters() {
  document.getElementById("facultySearch").value = "";
  document.getElementById("facultyFilterDept").value = "all";
  renderFaculty();
}

async function deleteFaculty(id) {
  if (!confirm("Delete this faculty?")) return;
  await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" });
  loadFaculty();
}

/* ================= FACULTY MODAL & SAVING ================= */
function openFacultyModal() {
  document.getElementById("facultyModal").style.display = "flex";
}
function closeFacultyModal() {
  document.getElementById("facultyModal").style.display = "none";
}

async function saveFaculty() {
  const nameInput = document.getElementById("fName");
  const deptInput = document.getElementById("fDept");
  
  const name = nameInput.value.trim();
  const dept = deptInput.value;

  if(!name || !dept) {
      alert("Please fill in Name and select a Department");
      return;
  }
  
  const roles = {
      hod: document.getElementById("fRoleHOD").checked,
      coordinator: document.getElementById("fRoleCoord").checked,
      proctor: document.getElementById("fRoleProctor").checked
  };

  try {
      const res = await fetch("http://localhost:5000/faculty", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, dept, roles })
      });
      
      const data = await res.json();

      if(res.ok) {
          // Clear form and reload
          nameInput.value = "";
          deptInput.value = "";
          document.getElementById("fRoleHOD").checked = false;
          document.getElementById("fRoleCoord").checked = false;
          document.getElementById("fRoleProctor").checked = false;
          
          closeFacultyModal();
          loadFaculty(); 
      } else {
          // ALERT THE ACTUAL ERROR FROM THE SERVER
          alert("Server Error: " + (data.message || "Unknown Error"));
      }
  } catch(e) {
      console.error(e);
      alert("Failed to connect to server. Is it running?");
  }
}

/* ================= STUDENTS ================= */
let allStudents = [];
let currentEditId = null;

async function loadStudents() {
  try {
    const res = await fetch("http://localhost:5000/students");
    allStudents = await res.json();
    renderStudents();
  } catch (err) {
    console.error("Failed to load students", err);
  }
}

async function saveStudent() {
  const name = document.getElementById("sName").value.trim();
  const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value;
  const dept = document.getElementById("sDept").value;
  const status = document.getElementById("sStatus").value;

  if (!name || !rollNo) {
    alert("Name and Roll No required");
    return;
  }

  await fetch("http://localhost:5000/students", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, rollNo, sem, dept, status })
  });

  closeStudentModal();
  loadStudents();
}

function renderStudents() {
  const search = document.getElementById("studentSearch")?.value.toLowerCase() || "";
  const dept = document.getElementById("studentFilterDept")?.value || "all";
  const sem = document.getElementById("studentFilterSem")?.value || "all";
  const body = document.getElementById("studentList");
  
  if (!body) return;
  body.innerHTML = "";

  const filtered = allStudents.filter(s => {
    const matchSearch = s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search);
    const matchDept = dept === "all" || s.dept === dept;
    const matchSem = sem === "all" || String(s.sem) === sem;
    return matchSearch && matchDept && matchSem;
  });

  if (filtered.length === 0) {
    body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`;
    return;
  }

  filtered.forEach(s => {
    body.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.rollNo}</td>
        <td>${s.sem}</td>
        <td>${s.dept}</td>
        <td>${s.status || "Enrolled"}</td>
        <td>
          <button class="btn btn-sm" style="background-color: #f59e0b; color: white; margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button>
          <button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

function clearStudentFilters() {
  document.getElementById("studentSearch").value = "";
  document.getElementById("studentFilterDept").value = "all";
  document.getElementById("studentFilterSem").value = "all";
  renderStudents();
}

async function deleteStudent(id) {
  if (!confirm("Delete this student?")) return;
  await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" });
  loadStudents();
}

/* ================= STUDENT MODALS ================= */
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }

function openEditStudentModal(id) {
  const student = allStudents.find(s => s._id === id);
  if (!student) return;
  currentEditId = id;

  document.getElementById("editSName").value = student.name;
  document.getElementById("editSRoll").value = student.rollNo;
  document.getElementById("editSSem").value = student.sem;
  document.getElementById("editSDept").value = student.dept;
  document.getElementById("editSStatus").value = student.status || "Enrolled";

  document.getElementById("editStudentModal").style.display = "flex";
}

function closeEditStudentModal() {
  document.getElementById("editStudentModal").style.display = "none";
  currentEditId = null;
}

async function updateStudent() {
  const name = document.getElementById("editSName").value;
  const rollNo = document.getElementById("editSRoll").value;
  const sem = document.getElementById("editSSem").value;
  const dept = document.getElementById("editSDept").value;
  const status = document.getElementById("editSStatus").value;

  await fetch(`http://localhost:5000/students/${currentEditId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, rollNo, sem, dept, status })
  });

  closeEditStudentModal();
  loadStudents();
}

/* ================= ALLOCATIONS ================= */

function getProctorName(id) {
  const faculty = allFaculty.find(f => f._id === id);
  return faculty ? `${faculty.name} (${faculty.dept})` : "Unknown";
}

async function loadAllocations() {
  const sRes = await fetch("http://localhost:5000/students");
  allStudents = await sRes.json();
  const fRes = await fetch("http://localhost:5000/faculty");
  allFaculty = await fRes.json();
  renderAllocations();
}

function renderAllocations() {
  const dept = document.getElementById("allocFilterDept").value;
  const sem = document.getElementById("allocFilterSem").value;
  const body = document.getElementById("allocationList");
  body.innerHTML = "";

  const allocated = allStudents.filter(s => {
    const hasProctor = s.proctorId !== null && s.proctorId !== undefined;
    const matchDept = dept === "all" || s.dept === dept;
    const matchSem = sem === "all" || String(s.sem) === sem;
    return hasProctor && matchDept && matchSem;
  });

  if (allocated.length === 0) {
    body.innerHTML = `<tr><td colspan="5">No allocations found</td></tr>`;
    return;
  }

  allocated.forEach(s => {
    body.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.rollNo}</td>
        <td>${s.sem}</td>
        <td style="font-weight:bold; color:#4e73df;">${getProctorName(s.proctorId)}</td>
        <td>
          <button class="btn btn-sm btn-dark" onclick="unassignProctor('${s._id}')">Remove</button>
        </td>
      </tr>`;
  });
}

function openAllocationModal() {
  const studentSelect = document.getElementById("allocStudent");
  const facultySelect = document.getElementById("allocFaculty");
  const btn = document.getElementById("btnAssignProctor");

  const unassigned = allStudents.filter(s => !s.proctorId);
  
  studentSelect.innerHTML = "";
  if(unassigned.length === 0) {
      studentSelect.innerHTML = `<option>All students assigned</option>`;
      btn.disabled = true;
      btn.style.opacity = "0.6";
  } else {
      btn.disabled = false;
      btn.style.opacity = "1";
      studentSelect.innerHTML = unassigned.map(s => `<option value="${s._id}">${s.name} (${s.rollNo})</option>`).join("");
  }

  // Filter only Faculty who have the 'proctor' role
  facultySelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor)
    .map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");

  document.getElementById("allocationModal").style.display = "flex";
}

function closeAllocationModal() {
  document.getElementById("allocationModal").style.display = "none";
}

async function saveAllocation() {
  const studentId = document.getElementById("allocStudent").value;
  const facultyId = document.getElementById("allocFaculty").value;

  await fetch("http://localhost:5000/allocate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ studentId, facultyId })
  });

  closeAllocationModal();
  loadAllocations();
}

async function unassignProctor(studentId) {
    if(!confirm("Remove this proctor assignment?")) return;
    await fetch("http://localhost:5000/allocate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ studentId, facultyId: null })
    });
    loadAllocations();
}

async function autoAllocate() {
    const unassigned = allStudents.filter(s => !s.proctorId);
    const proctors = allFaculty.filter(f => f.roles && f.roles.proctor);

    if(unassigned.length === 0) { alert("No students to allocate!"); return; }
    if(proctors.length === 0) { alert("No active proctors available!"); return; }

    if(!confirm(`Auto-assign ${unassigned.length} students to ${proctors.length} proctors?`)) return;

    for(let i = 0; i < unassigned.length; i++) {
        const student = unassigned[i];
        const proctor = proctors[i % proctors.length];
        await fetch("http://localhost:5000/allocate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ studentId: student._id, facultyId: proctor._id })
        });
    }
    alert("Auto-allocation complete!");
    loadAllocations();
}

/* ================= LOGOUT / RESET ================= */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}
function resetSystem() {
  alert("System reset (demo)");
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  loadDashboard();
});
</script>

</body>
</html-->

<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Checkbox fixes */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    
    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearStudentFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Student</th><th>Roll No</th><th>Sem</th><th>Proctor</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card" style="max-width: 500px;">
    <h2><i class="fas fa-user-shield"></i> Account Security</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Admin can reset the password for any user (Student or Faculty) in case they forget it.</p>
    <label style="display:block; margin-bottom:5px; font-weight:600;">Username (Email)</label>
    <input type="text" id="secUsername" placeholder="Enter user email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #cbd5e1; border-radius:6px;">
    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
    <input type="password" id="secNewPwd" placeholder="Enter new password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:6px;">
    <button class="btn btn-primary" onclick="resetUserPassword()" style="width:100%; padding:12px;">Reset Password</button>
  </div>
</div>

</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem"><option value="1">Sem 1</option><option value="3">Sem 3</option><option value="5">Sem 5</option><option value="7">Sem 7</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label><select id="editSSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor</h3>
    <label>Student</label><select id="allocStudent"></select>
    <label>Proctor</label><select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS ---
let allFaculty = [];
let currentEditFacultyId = null;

async function loadFaculty() {
  try { const res = await fetch("http://localhost:5000/faculty"); allFaculty = await res.json(); renderFaculty(); } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    let roles = []; const r = f.roles || { proctor: f.isProctor || false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push('<span class="status-pill status-proctor">Proctor</span>');
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    
    body.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${f.dept}</td>
        <td>${roleDisplay}</td>
        <td><i class="fas fa-envelope" style="color:#4e73df;"></i></td>
        <td>
          <button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button>
          <button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim();
  const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); }
  else { alert("Server Error"); }
}

// --- FACULTY EDIT FUNCTIONS ---
function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id;
  document.getElementById("editFName").value = f.name;
  document.getElementById("editFDept").value = f.dept || "CE";
  
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod;
  document.getElementById("editFRoleCoord").checked = r.coordinator;
  document.getElementById("editFRoleProctor").checked = r.proctor;
  
  document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() {
  document.getElementById("editFacultyModal").style.display = "none";
  currentEditFacultyId = null;
}

// Note: This requires a PUT endpoint on the server. If server.js doesn't have one, adding it there is needed. 
// Assuming for now user just wants UI, but functional needs backend support. 
// I will include the fetch call assuming standard REST convention or user will ask to fix server next.
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim();
  const dept = document.getElementById("editFDept").value;
  const roles = {
      hod: document.getElementById("editFRoleHOD").checked,
      coordinator: document.getElementById("editFRoleCoord").checked,
      proctor: document.getElementById("editFRoleProctor").checked
  };

  // We are using POST to overwrite for simplicity if PUT isn't set up, or standard PUT if available.
  // Based on previous interactions, the server might not have PUT for faculty.
  // IMPORTANT: You might need to add app.put('/faculty/:id', ...) to server.js if this fails.
  // For now, I will try a PUT request.
  
  try {
      const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, {
        method: "PUT", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, dept, roles })
      });
      
      if(res.ok) {
          closeEditFacultyModal();
          loadFaculty();
      } else {
          alert("Update failed. (Check if server supports PUT /faculty/:id)");
      }
  } catch(e) {
      console.error(e);
      alert("Server connection error.");
  }
}


// --- STUDENT FUNCTIONS ---
let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }
async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase();
  const dept = document.getElementById("studentFilterDept").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => {
    body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
  });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

// --- ALLOCATION FUNCTIONS ---
function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name} (${f.dept})` : "Unknown"; }
async function loadAllocations() { const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); renderAllocations(); }
function renderAllocations() {
  const dept = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const allocated = allStudents.filter(s => s.proctorId && (dept === "all" || s.dept === dept));
  if (allocated.length === 0) { body.innerHTML = `<tr><td colspan="5">No allocations found</td></tr>`; return; }
  allocated.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td style="font-weight:bold;color:#4e73df;">${getProctorName(s.proctorId)}</td><td><button class="btn btn-sm btn-dark" onclick="unassignProctor('${s._id}')">Remove</button></td></tr>`; });
}
function openAllocationModal() {
  const sSelect = document.getElementById("allocStudent"); const fSelect = document.getElementById("allocFaculty"); const btn = document.getElementById("btnAssignProctor");
  const unassigned = allStudents.filter(s => !s.proctorId);
  sSelect.innerHTML = unassigned.length === 0 ? `<option>All students assigned</option>` : unassigned.map(s => `<option value="${s._id}">${s.name} (${s.rollNo})</option>`).join("");
  btn.disabled = unassigned.length === 0; btn.style.opacity = unassigned.length === 0 ? "0.6" : "1";
  fSelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveAllocation() { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: document.getElementById("allocStudent").value, facultyId: document.getElementById("allocFaculty").value }) }); closeAllocationModal(); loadAllocations(); }
async function unassignProctor(studentId) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId, facultyId: null }) }); loadAllocations(); } }
async function autoAllocate() {
  const unassigned = allStudents.filter(s => !s.proctorId); const proctors = allFaculty.filter(f => f.roles && f.roles.proctor);
  if(unassigned.length === 0 || proctors.length === 0) { alert("Cannot auto-allocate."); return; }
  if(!confirm(`Auto-assign ${unassigned.length} students?`)) return;
  for(let i=0; i<unassigned.length; i++) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: unassigned[i]._id, facultyId: proctors[i % proctors.length]._id }) }); }
  alert("Done!"); loadAllocations();
}

// --- SECURITY FUNCTION ---
async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->




<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Checkbox fixes */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    
    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearStudentFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Student</th><th>Roll No</th><th>Sem</th><th>Proctor</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card" style="max-width: 500px;">
    <h2><i class="fas fa-user-shield"></i> Account Security</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Admin can reset the password for any user (Student or Faculty) in case they forget it.</p>
    <label style="display:block; margin-bottom:5px; font-weight:600;">Username (Email)</label>
    <input type="text" id="secUsername" placeholder="Enter user email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #cbd5e1; border-radius:6px;">
    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
    <input type="password" id="secNewPwd" placeholder="Enter new password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:6px;">
    <button class="btn btn-primary" onclick="resetUserPassword()" style="width:100%; padding:12px;">Reset Password</button>
  </div>
</div>

</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    
    <select id="sSem">
        <option value="1">Sem 1</option>
        <option value="2">Sem 2</option>
        <option value="3">Sem 3</option>
        <option value="4">Sem 4</option>
        <option value="5">Sem 5</option>
        <option value="6">Sem 6</option>
        <option value="7">Sem 7</option>
        <option value="8">Sem 8</option>
    </select>
    
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    
    <label>Semester</label>
    <select id="editSSem">
        <option value="1">Sem 1</option>
        <option value="2">Sem 2</option>
        <option value="3">Sem 3</option>
        <option value="4">Sem 4</option>
        <option value="5">Sem 5</option>
        <option value="6">Sem 6</option>
        <option value="7">Sem 7</option>
        <option value="8">Sem 8</option>
    </select>
    
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor</h3>
    <label>Student</label><select id="allocStudent"></select>
    <label>Proctor</label><select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS ---
let allFaculty = [];
let currentEditFacultyId = null;

async function loadFaculty() {
  try { const res = await fetch("http://localhost:5000/faculty"); allFaculty = await res.json(); renderFaculty(); } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    let roles = []; const r = f.roles || { proctor: f.isProctor || false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push('<span class="status-pill status-proctor">Proctor</span>');
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    
    body.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${f.dept}</td>
        <td>${roleDisplay}</td>
        <td><i class="fas fa-envelope" style="color:#4e73df;"></i></td>
        <td>
          <button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button>
          <button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim();
  const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); }
  else { alert("Server Error"); }
}

// --- FACULTY EDIT FUNCTIONS ---
function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id;
  document.getElementById("editFName").value = f.name;
  document.getElementById("editFDept").value = f.dept || "CE";
  
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod;
  document.getElementById("editFRoleCoord").checked = r.coordinator;
  document.getElementById("editFRoleProctor").checked = r.proctor;
  
  document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() {
  document.getElementById("editFacultyModal").style.display = "none";
  currentEditFacultyId = null;
}

async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim();
  const dept = document.getElementById("editFDept").value;
  const roles = {
      hod: document.getElementById("editFRoleHOD").checked,
      coordinator: document.getElementById("editFRoleCoord").checked,
      proctor: document.getElementById("editFRoleProctor").checked
  };

  try {
      const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, {
        method: "PUT", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, dept, roles })
      });
      if(res.ok) { closeEditFacultyModal(); loadFaculty(); } 
      else { alert("Update failed."); }
  } catch(e) { console.error(e); alert("Server connection error."); }
}

// --- STUDENT FUNCTIONS ---
let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }
async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase();
  const dept = document.getElementById("studentFilterDept").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => {
    body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
  });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

// --- ALLOCATION FUNCTIONS ---
function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name} (${f.dept})` : "Unknown"; }
async function loadAllocations() { const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); renderAllocations(); }
function renderAllocations() {
  const dept = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const allocated = allStudents.filter(s => s.proctorId && (dept === "all" || s.dept === dept));
  if (allocated.length === 0) { body.innerHTML = `<tr><td colspan="5">No allocations found</td></tr>`; return; }
  allocated.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td style="font-weight:bold;color:#4e73df;">${getProctorName(s.proctorId)}</td><td><button class="btn btn-sm btn-dark" onclick="unassignProctor('${s._id}')">Remove</button></td></tr>`; });
}
function openAllocationModal() {
  const sSelect = document.getElementById("allocStudent"); const fSelect = document.getElementById("allocFaculty"); const btn = document.getElementById("btnAssignProctor");
  const unassigned = allStudents.filter(s => !s.proctorId);
  sSelect.innerHTML = unassigned.length === 0 ? `<option>All students assigned</option>` : unassigned.map(s => `<option value="${s._id}">${s.name} (${s.rollNo})</option>`).join("");
  btn.disabled = unassigned.length === 0; btn.style.opacity = unassigned.length === 0 ? "0.6" : "1";
  fSelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveAllocation() { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: document.getElementById("allocStudent").value, facultyId: document.getElementById("allocFaculty").value }) }); closeAllocationModal(); loadAllocations(); }
async function unassignProctor(studentId) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId, facultyId: null }) }); loadAllocations(); } }
async function autoAllocate() {
  const unassigned = allStudents.filter(s => !s.proctorId); const proctors = allFaculty.filter(f => f.roles && f.roles.proctor);
  if(unassigned.length === 0 || proctors.length === 0) { alert("Cannot auto-allocate."); return; }
  if(!confirm(`Auto-assign ${unassigned.length} students?`)) return;
  for(let i=0; i<unassigned.length; i++) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: unassigned[i]._id, facultyId: proctors[i % proctors.length]._id }) }); }
  alert("Done!"); loadAllocations();
}

// --- SECURITY FUNCTION ---
async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Checkbox fixes */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    
    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }

    /* Student Count Badge inside Proctor Pill */
    .count-badge {
        background: rgba(0,0,0,0.15);
        color: #064e3b;
        padding: 1px 6px;
        border-radius: 10px;
        margin-left: 5px;
        font-size: 10px;
    }

    /* Notify Icons */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearStudentFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Student</th><th>Roll No</th><th>Sem</th><th>Proctor</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card" style="max-width: 500px;">
    <h2><i class="fas fa-user-shield"></i> Account Security</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Admin can reset the password for any user (Student or Faculty) in case they forget it.</p>
    <label style="display:block; margin-bottom:5px; font-weight:600;">Username (Email)</label>
    <input type="text" id="secUsername" placeholder="Enter user email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #cbd5e1; border-radius:6px;">
    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
    <input type="password" id="secNewPwd" placeholder="Enter new password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:6px;">
    <button class="btn btn-primary" onclick="resetUserPassword()" style="width:100%; padding:12px;">Reset Password</button>
  </div>
</div>

</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option>
        <option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option>
        <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label>
    <select id="editSSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option>
        <option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option>
        <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor</h3>
    <label>Student</label><select id="allocStudent"></select>
    <label>Proctor</label><select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS ---
let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    // 1. Calculate Student Count
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;

    // 2. Generate List String
    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => {
            listString += `${index + 1}. ${s.name} (${s.rollNo})\n`;
        });
    } else {
        listString = "No students assigned yet.";
    }

    // 3. WhatsApp Link
    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    
    // 4. Email Link
    // Note: %0D%0A is newline for mailto
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;

    // 5. Generate Roles
    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) {
        roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    }
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    
    body.innerHTML += `
      <tr>
        <td>${f.name}</td>
        <td>${f.dept}</td>
        <td>${roleDisplay}</td>
        <td>
            <a href="${whatsappLink}" target="_blank" title="WhatsApp List" style="text-decoration:none;">
                <i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i>
            </a>
            <a href="${mailLink}" title="Email List" style="text-decoration:none;">
                <i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i>
            </a>
        </td>
        <td>
          <button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button>
          <button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button>
        </td>
      </tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim();
  const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); }
  else { alert("Server Error"); }
}

function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id;
  document.getElementById("editFName").value = f.name;
  document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod;
  document.getElementById("editFRoleCoord").checked = r.coordinator;
  document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim();
  const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

// --- STUDENT FUNCTIONS ---
let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }
async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase();
  const dept = document.getElementById("studentFilterDept").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => {
    body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
  });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

// --- ALLOCATION FUNCTIONS ---
function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name} (${f.dept})` : "Unknown"; }
async function loadAllocations() { const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); renderAllocations(); }
function renderAllocations() {
  const dept = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const allocated = allStudents.filter(s => s.proctorId && (dept === "all" || s.dept === dept));
  if (allocated.length === 0) { body.innerHTML = `<tr><td colspan="5">No allocations found</td></tr>`; return; }
  allocated.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td style="font-weight:bold;color:#4e73df;">${getProctorName(s.proctorId)}</td><td><button class="btn btn-sm btn-dark" onclick="unassignProctor('${s._id}')">Remove</button></td></tr>`; });
}
function openAllocationModal() {
  const sSelect = document.getElementById("allocStudent"); const fSelect = document.getElementById("allocFaculty"); const btn = document.getElementById("btnAssignProctor");
  const unassigned = allStudents.filter(s => !s.proctorId);
  sSelect.innerHTML = unassigned.length === 0 ? `<option>All students assigned</option>` : unassigned.map(s => `<option value="${s._id}">${s.name} (${s.rollNo})</option>`).join("");
  btn.disabled = unassigned.length === 0; btn.style.opacity = unassigned.length === 0 ? "0.6" : "1";
  fSelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveAllocation() { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: document.getElementById("allocStudent").value, facultyId: document.getElementById("allocFaculty").value }) }); closeAllocationModal(); loadAllocations(); }
async function unassignProctor(studentId) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId, facultyId: null }) }); loadAllocations(); } }
async function autoAllocate() {
  const unassigned = allStudents.filter(s => !s.proctorId); const proctors = allFaculty.filter(f => f.roles && f.roles.proctor);
  if(unassigned.length === 0 || proctors.length === 0) { alert("Cannot auto-allocate."); return; }
  if(!confirm(`Auto-assign ${unassigned.length} students?`)) return;
  for(let i=0; i<unassigned.length; i++) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: unassigned[i]._id, facultyId: proctors[i % proctors.length]._id }) }); }
  alert("Done!"); loadAllocations();
}

// --- SECURITY FUNCTION ---
async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->

<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Checkbox fixes */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    
    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }

    /* Student Count Badge inside Proctor Pill */
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }

    /* Notify Icons */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>

        <select id="studentFilterSem" onchange="renderStudents()">
          <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option>
        </select>

        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()">
            <i class="fas fa-file-csv"></i> Upload CSV
        </button>

        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Student</th><th>Roll No</th><th>Sem</th><th>Proctor</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card" style="max-width: 500px;">
    <h2><i class="fas fa-user-shield"></i> Account Security</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Admin can reset the password for any user (Student or Faculty) in case they forget it.</p>
    <label style="display:block; margin-bottom:5px; font-weight:600;">Username (Email)</label>
    <input type="text" id="secUsername" placeholder="Enter user email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #cbd5e1; border-radius:6px;">
    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
    <input type="password" id="secNewPwd" placeholder="Enter new password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:6px;">
    <button class="btn btn-primary" onclick="resetUserPassword()" style="width:100%; padding:12px;">Reset Password</button>
  </div>
</div>

</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:13px; color:#64748b;">
            1. Select Dept & Sem below.<br>
            2. CSV must have 2 columns: <b>Name</b> and <b>Roll No</b> (in any order).
        </p>
        
        <label>Select Department</label>
        <select id="csvDept">
            <option value="" disabled selected>Choose Dept</option>
            <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>

        <label>Select Semester</label>
        <select id="csvSem">
            <option value="" disabled selected>Choose Sem</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
        </select>

        <label>Choose CSV File</label>
        <input type="file" id="csvFile" accept=".csv">

        <div class="modal-btns">
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload & Save</button>
            <button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option>
        <option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option>
        <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label>
    <select id="editSSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option>
        <option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option>
        <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor</h3>
    <label>Student</label><select id="allocStudent"></select>
    <label>Proctor</label><select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS ---
let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;

    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => { listString += `${index + 1}. ${s.name} (${s.rollNo})\n`; });
    } else { listString = "No students assigned yet."; }

    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;

    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    
    body.innerHTML += `<tr><td>${f.name}</td><td>${f.dept}</td><td>${roleDisplay}</td><td><a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a><a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a></td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td></tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim(); const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); } else { alert("Server Error"); }
}

function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id; document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod; document.getElementById("editFRoleCoord").checked = r.coordinator; document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim(); const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

// --- STUDENT FUNCTIONS (SMART CSV) ---
let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }

// CSV MODAL
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function processCSVUpload() {
    const dept = document.getElementById("csvDept").value;
    const sem = document.getElementById("csvSem").value;
    const fileInput = document.getElementById("csvFile");
    const file = fileInput.files[0];

    if(!dept || !sem) { alert("Please select both Department and Semester."); return; }
    if(!file) { alert("Please select a CSV file."); return; }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;
        const rows = text.split('\n').map(r => r.trim()).filter(r => r);
        let studentsToUpload = [];
        
        // Auto-detect header row
        let startIndex = 0;
        if(rows[0] && (rows[0].toLowerCase().includes('name') || rows[0].toLowerCase().includes('roll'))) {
            startIndex = 1;
        }

        for(let i=startIndex; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let val1 = cols[0]?.trim();
                let val2 = cols[1]?.trim();
                
                let studentName, studentRoll;

                // --- SMART DETECTION LOGIC ---
                // If col 0 looks like a number (Roll No) and col 1 is text (Name) -> Swap them
                // Numeric check regex: Contains mostly digits
                const isVal1Number = /^\d+$/.test(val1); // Is strictly digits
                const isVal2Number = /^\d+$/.test(val2); 

                if (isVal1Number && !isVal2Number) {
                    // Col 0 is Roll, Col 1 is Name
                    studentRoll = val1;
                    studentName = val2;
                } else {
                    // Default: Col 0 is Name, Col 1 is Roll (or we assume standard format)
                    studentName = val1;
                    studentRoll = val2;
                }

                if(studentName && studentRoll) {
                    studentsToUpload.push({
                        name: studentName,
                        rollNo: studentRoll,
                        sem: sem,
                        dept: dept,
                        status: 'Enrolled'
                    });
                }
            }
        }

        if(studentsToUpload.length > 0) {
            if(confirm(`Ready to upload ${studentsToUpload.length} students?`)) {
                const res = await fetch('http://localhost:5000/students/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentsToUpload)
                });
                const data = await res.json();
                alert(data.message);
                closeCSVModal();
                loadStudents();
                
                document.getElementById("csvDept").value = "";
                document.getElementById("csvSem").value = "";
                fileInput.value = "";
            }
        } else {
            alert("No valid data found in CSV.");
        }
    };
    reader.readAsText(file);
}

async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase();
  const dept = document.getElementById("studentFilterDept").value;
  const sem = document.getElementById("studentFilterSem").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => {
    body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
  });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; document.getElementById("studentFilterSem").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

// --- ALLOCATION FUNCTIONS ---
function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name} (${f.dept})` : "Unknown"; }
async function loadAllocations() { const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); renderAllocations(); }
function renderAllocations() {
  const dept = document.getElementById("allocFilterDept").value;
  const sem = document.getElementById("allocFilterSem").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const allocated = allStudents.filter(s => s.proctorId && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  if (allocated.length === 0) { body.innerHTML = `<tr><td colspan="5">No allocations found</td></tr>`; return; }
  allocated.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td style="font-weight:bold;color:#4e73df;">${getProctorName(s.proctorId)}</td><td><button class="btn btn-sm btn-dark" onclick="unassignProctor('${s._id}')">Remove</button></td></tr>`; });
}
function openAllocationModal() {
  const sSelect = document.getElementById("allocStudent"); const fSelect = document.getElementById("allocFaculty"); const btn = document.getElementById("btnAssignProctor");
  const unassigned = allStudents.filter(s => !s.proctorId);
  sSelect.innerHTML = unassigned.length === 0 ? `<option>All students assigned</option>` : unassigned.map(s => `<option value="${s._id}">${s.name} (${s.rollNo})</option>`).join("");
  btn.disabled = unassigned.length === 0; btn.style.opacity = unassigned.length === 0 ? "0.6" : "1";
  fSelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveAllocation() { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: document.getElementById("allocStudent").value, facultyId: document.getElementById("allocFaculty").value }) }); closeAllocationModal(); loadAllocations(); }
async function unassignProctor(studentId) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId, facultyId: null }) }); loadAllocations(); } }
async function autoAllocate() {
  const unassigned = allStudents.filter(s => !s.proctorId); const proctors = allFaculty.filter(f => f.roles && f.roles.proctor);
  if(unassigned.length === 0 || proctors.length === 0) { alert("Cannot auto-allocate."); return; }
  if(!confirm(`Auto-assign ${unassigned.length} students?`)) return;
  for(let i=0; i<unassigned.length; i++) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: unassigned[i]._id, facultyId: proctors[i % proctors.length]._id }) }); }
  alert("Done!"); loadAllocations();
}

// --- SECURITY FUNCTION ---
async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Checkbox fixes */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    
    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }

    /* Student Count Badge inside Proctor Pill */
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }

    /* Notify Icons */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <select id="studentFilterSem" onchange="renderStudents()">
          <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option>
        </select>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Student</th><th>Roll No</th><th>Sem</th><th>Proctor</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card" style="max-width: 500px;">
    <h2><i class="fas fa-user-shield"></i> Account Security</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Admin can reset the password for any user (Student or Faculty) in case they forget it.</p>
    <label style="display:block; margin-bottom:5px; font-weight:600;">Username (Email)</label>
    <input type="text" id="secUsername" placeholder="Enter user email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #cbd5e1; border-radius:6px;">
    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
    <input type="password" id="secNewPwd" placeholder="Enter new password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:6px;">
    <button class="btn btn-primary" onclick="resetUserPassword()" style="width:100%; padding:12px;">Reset Password</button>
  </div>
</div>

</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:13px; color:#64748b;">Select Class & Upload CSV (Columns: Name, Roll No)</p>
        <label>Select Department</label><select id="csvDept"><option value="" disabled selected>Choose Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <label>Select Semester</label><select id="csvSem"><option value="" disabled selected>Choose Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile" accept=".csv">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label><select id="editSSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor to Class</h3>
    
    <label>Select Department</label>
    <select id="allocDept">
        <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
    </select>

    <label>Select Semester</label>
    <select id="allocSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    
    <label>Select Proctor</label>
    <select id="allocFaculty"></select>
    
    <div class="modal-btns">
        <button class="btn btn-primary" onclick="saveClassAllocation()">Assign Class</button>
        <button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS ---
let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;

    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => { listString += `${index + 1}. ${s.name} (${s.rollNo})\n`; });
    } else { listString = "No students assigned yet."; }

    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;

    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    
    body.innerHTML += `<tr><td>${f.name}</td><td>${f.dept}</td><td>${roleDisplay}</td><td><a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a><a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a></td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td></tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim(); const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); } else { alert("Server Error"); }
}

function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id; document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod; document.getElementById("editFRoleCoord").checked = r.coordinator; document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim(); const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

// --- STUDENT FUNCTIONS (SMART CSV) ---
let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }

// CSV MODAL
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function processCSVUpload() {
    const dept = document.getElementById("csvDept").value;
    const sem = document.getElementById("csvSem").value;
    const fileInput = document.getElementById("csvFile");
    const file = fileInput.files[0];

    if(!dept || !sem) { alert("Please select both Department and Semester."); return; }
    if(!file) { alert("Please select a CSV file."); return; }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;
        const rows = text.split('\n').map(r => r.trim()).filter(r => r);
        let studentsToUpload = [];
        
        let startIndex = 0;
        if(rows[0] && (rows[0].toLowerCase().includes('name') || rows[0].toLowerCase().includes('roll'))) { startIndex = 1; }

        for(let i=startIndex; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let val1 = cols[0]?.trim(); let val2 = cols[1]?.trim();
                let studentName, studentRoll;
                const isVal1Number = /^\d+$/.test(val1);
                const isVal2Number = /^\d+$/.test(val2);
                if (isVal1Number && !isVal2Number) { studentRoll = val1; studentName = val2; } 
                else { studentName = val1; studentRoll = val2; }

                if(studentName && studentRoll) {
                    studentsToUpload.push({ name: studentName, rollNo: studentRoll, sem: sem, dept: dept, status: 'Enrolled' });
                }
            }
        }

        if(studentsToUpload.length > 0) {
            if(confirm(`Ready to upload ${studentsToUpload.length} students?`)) {
                const res = await fetch('http://localhost:5000/students/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentsToUpload) });
                const data = await res.json();
                alert(data.message);
                closeCSVModal();
                loadStudents();
                document.getElementById("csvDept").value = ""; document.getElementById("csvSem").value = ""; fileInput.value = "";
            }
        } else { alert("No valid data found in CSV."); }
    };
    reader.readAsText(file);
}

async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase();
  const dept = document.getElementById("studentFilterDept").value;
  const sem = document.getElementById("studentFilterSem").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => {
    body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
  });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; document.getElementById("studentFilterSem").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

// --- ALLOCATION FUNCTIONS (NEW CLASS BASED) ---
function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name} (${f.dept})` : "Unknown"; }
async function loadAllocations() { const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); renderAllocations(); }
function renderAllocations() {
  const dept = document.getElementById("allocFilterDept").value;
  const sem = document.getElementById("allocFilterSem").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const allocated = allStudents.filter(s => s.proctorId && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  if (allocated.length === 0) { body.innerHTML = `<tr><td colspan="5">No allocations found</td></tr>`; return; }
  allocated.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td style="font-weight:bold;color:#4e73df;">${getProctorName(s.proctorId)}</td><td><button class="btn btn-sm btn-dark" onclick="unassignProctor('${s._id}')">Remove</button></td></tr>`; });
}

// OPEN CLASS ASSIGN MODAL
function openAllocationModal() {
  const facultySelect = document.getElementById("allocFaculty");
  facultySelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }

// SAVE CLASS ALLOCATION
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value;
    const sem = document.getElementById("allocSem").value;
    const facultyId = document.getElementById("allocFaculty").value;

    if(!dept || !sem || !facultyId) { alert("Please select Department, Semester and Proctor."); return; }

    if(confirm(`Assign ALL students in ${dept} Sem ${sem} to selected proctor?`)) {
        const res = await fetch("http://localhost:5000/allocate/class", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dept, sem, facultyId })
        });
        const data = await res.json();
        alert(data.message);
        closeAllocationModal();
        loadAllocations();
    }
}

async function unassignProctor(studentId) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId, facultyId: null }) }); loadAllocations(); } }
async function autoAllocate() {
  const unassigned = allStudents.filter(s => !s.proctorId); const proctors = allFaculty.filter(f => f.roles && f.roles.proctor);
  if(unassigned.length === 0 || proctors.length === 0) { alert("Cannot auto-allocate."); return; }
  if(!confirm(`Auto-assign ${unassigned.length} students?`)) return;
  for(let i=0; i<unassigned.length; i++) { await fetch("http://localhost:5000/allocate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ studentId: unassigned[i]._id, facultyId: proctors[i % proctors.length]._id }) }); }
  alert("Done!"); loadAllocations();
}

// --- SECURITY FUNCTION ---
async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Checkbox fixes */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    
    /* Role Badges */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }

    /* Student Count Badge inside Proctor Pill */
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }

    /* Notify Icons */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>

        <select id="studentFilterSem" onchange="renderStudents()">
          <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option>
        </select>

        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations (By Class)</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Proctor Name</th>
          <th>Department</th>
          <th>Semester</th>
          <th>Assigned Students</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="allocationList">
        <tr><td colspan="5">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card" style="max-width: 500px;">
    <h2><i class="fas fa-user-shield"></i> Account Security</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Admin can reset the password for any user (Student or Faculty) in case they forget it.</p>
    <label style="display:block; margin-bottom:5px; font-weight:600;">Username (Email)</label>
    <input type="text" id="secUsername" placeholder="Enter user email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #cbd5e1; border-radius:6px;">
    <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
    <input type="password" id="secNewPwd" placeholder="Enter new password" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #cbd5e1; border-radius:6px;">
    <button class="btn btn-primary" onclick="resetUserPassword()" style="width:100%; padding:12px;">Reset Password</button>
  </div>
</div>

</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:13px; color:#64748b;">Select Class & Upload CSV (Columns: Name, Roll No)</p>
        <label>Select Department</label><select id="csvDept"><option value="" disabled selected>Choose Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <label>Select Semester</label><select id="csvSem"><option value="" disabled selected>Choose Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile" accept=".csv">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option>
        <option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option>
        <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label><select id="editSSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor to Class</h3>
    <label>Select Department</label>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Select Semester</label>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Select Proctor</label>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveClassAllocation()">Assign Class</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS ---
let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;

    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => { listString += `${index + 1}. ${s.name} (${s.rollNo})\n`; });
    } else { listString = "No students assigned yet."; }

    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;

    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    
    body.innerHTML += `<tr><td>${f.name}</td><td>${f.dept}</td><td>${roleDisplay}</td><td><a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a><a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a></td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td></tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim(); const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); } else { alert("Server Error"); }
}

function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id; document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod; document.getElementById("editFRoleCoord").checked = r.coordinator; document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim(); const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

// --- STUDENT FUNCTIONS ---
let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }

// CSV MODAL
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function processCSVUpload() {
    const dept = document.getElementById("csvDept").value;
    const sem = document.getElementById("csvSem").value;
    const fileInput = document.getElementById("csvFile");
    const file = fileInput.files[0];

    if(!dept || !sem) { alert("Please select both Department and Semester."); return; }
    if(!file) { alert("Please select a CSV file."); return; }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;
        const rows = text.split('\n').map(r => r.trim()).filter(r => r);
        let studentsToUpload = [];
        
        let startIndex = 0;
        if(rows[0] && (rows[0].toLowerCase().includes('name') || rows[0].toLowerCase().includes('roll'))) { startIndex = 1; }

        for(let i=startIndex; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let val1 = cols[0]?.trim(); let val2 = cols[1]?.trim();
                let studentName, studentRoll;
                const isVal1Number = /^\d+$/.test(val1);
                const isVal2Number = /^\d+$/.test(val2);
                if (isVal1Number && !isVal2Number) { studentRoll = val1; studentName = val2; } 
                else { studentName = val1; studentRoll = val2; }

                if(studentName && studentRoll) {
                    studentsToUpload.push({ name: studentName, rollNo: studentRoll, sem: sem, dept: dept, status: 'Enrolled' });
                }
            }
        }

        if(studentsToUpload.length > 0) {
            if(confirm(`Ready to upload ${studentsToUpload.length} students?`)) {
                const res = await fetch('http://localhost:5000/students/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentsToUpload) });
                const data = await res.json();
                alert(data.message);
                closeCSVModal();
                loadStudents();
                document.getElementById("csvDept").value = ""; document.getElementById("csvSem").value = ""; fileInput.value = "";
            }
        } else { alert("No valid data found in CSV."); }
    };
    reader.readAsText(file);
}

async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim();
  const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase();
  const dept = document.getElementById("studentFilterDept").value;
  const sem = document.getElementById("studentFilterSem").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => {
    body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
  });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; document.getElementById("studentFilterSem").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

// --- ALLOCATION FUNCTIONS (NEW: CLASS WISE) ---
function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name}` : "Unknown"; }

async function loadAllocations() { 
  const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); 
  const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); 
  renderAllocations(); 
}

function renderAllocations() {
  const deptFilter = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";

  // Group students by Proctor + Dept + Sem
  const groupings = {};

  allStudents.forEach(s => {
      if(s.proctorId) {
          const key = `${s.proctorId}-${s.dept}-${s.sem}`;
          if(!groupings[key]) {
              groupings[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 };
          }
          groupings[key].count++;
      }
  });

  // Convert groupings object to array
  const groupsArray = Object.values(groupings);

  // Filter based on dropdown
  const filteredGroups = groupsArray.filter(g => deptFilter === "all" || g.dept === deptFilter);

  if (filteredGroups.length === 0) { body.innerHTML = `<tr><td colspan="5">No active class allocations found</td></tr>`; return; }

  filteredGroups.forEach(g => { 
    body.innerHTML += `
      <tr>
        <td style="font-weight:bold;color:#4e73df;">${getProctorName(g.proctorId)}</td>
        <td>${g.dept}</td>
        <td>Sem ${g.sem}</td>
        <td><span class="status-pill status-coord" style="color:black;">${g.count} Students</span></td>
        <td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.proctorId}', '${g.dept}', '${g.sem}')">Remove</button></td>
      </tr>`; 
  });
}

function openAllocationModal() {
  const facultySelect = document.getElementById("allocFaculty");
  facultySelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }

async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value;
    const sem = document.getElementById("allocSem").value;
    const facultyId = document.getElementById("allocFaculty").value;

    if(!dept || !sem || !facultyId) { alert("Please select Department, Semester and Proctor."); return; }

    if(confirm(`Assign ALL students in ${dept} Sem ${sem} to selected proctor?`)) {
        await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId }) });
        closeAllocationModal();
        loadAllocations();
    }
}

async function unassignClass(proctorId, dept, sem) {
    if(!confirm(`Remove proctor from ${dept} Sem ${sem}?`)) return;
    
    // We reuse the allocate/class endpoint but pass facultyId as null
    await fetch("http://localhost:5000/allocate/class", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dept, sem, facultyId: null })
    });
    
    loadAllocations();
}

async function autoAllocate() {
  alert("Auto-allocation is disabled in Class Mode. Please assign classes manually.");
}

// --- SECURITY FUNCTION ---
async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* ... [Keep existing CSS] ... */
    /* Add this for Security Table */
    .sec-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .sec-table th, .sec-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
    .sec-table th { background: #f8fafc; color: #64748b; }
    
    /* Re-adding previous essential CSS for completeness */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        
        <select id="studentFilterDept" onchange="renderStudents()">
          <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>

        <select id="studentFilterSem" onchange="renderStudents()">
          <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option>
        </select>

        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()">
          <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
    <p style="color: #64748b; margin-bottom: 20px;">View and Manage Login Credentials for all users.</p>
    
    <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #e2e8f0;">
        <h4 style="margin-top:0;">Emergency Password Override</h4>
        <input type="text" id="secUsername" placeholder="Username" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
        <input type="text" id="secNewPwd" placeholder="New Password" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
        <button class="btn btn-sm btn-primary" onclick="resetUserPassword()">Update</button>
    </div>

    <table class="sec-table">
        <thead>
            <tr>
                <th>Username (Roll/Name)</th>
                <th>Role</th>
                <th>Current Password</th>
            </tr>
        </thead>
        <tbody id="credentialList">
            <tr><td colspan="3">Loading credentials...</td></tr>
        </tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:13px; color:#64748b;">Select Class & Upload CSV (Columns: Name, Roll No)</p>
        <label>Select Department</label><select id="csvDept"><option value="" disabled selected>Choose Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <label>Select Semester</label><select id="csvSem"><option value="" disabled selected>Choose Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile" accept=".csv">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <select id="sSem">
        <option value="1">Sem 1</option><option value="2">Sem 2</option>
        <option value="3">Sem 3</option><option value="4">Sem 4</option>
        <option value="5">Sem 5</option><option value="6">Sem 6</option>
        <option value="7">Sem 7</option><option value="8">Sem 8</option>
    </select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label><select id="editSSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor to Class</h3>
    <label>Select Department</label>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Select Semester</label>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Select Proctor</label>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveClassAllocation()">Assign Class</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
// [Keep ALL previous JavaScript logic here]
// I will just add the new logic for the Security Table

function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials(); // NEW FUNCTION
}

// --- NEW CREDENTIAL LOADER ---
async function loadCredentials() {
    const list = document.getElementById("credentialList");
    list.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    
    try {
        const res = await fetch("http://localhost:5000/users");
        const users = await res.json();
        list.innerHTML = "";
        
        users.forEach(u => {
            // Hide admin password for slight safety
            const pwdDisplay = u.role === 'admin' ? '********' : u.password;
            list.innerHTML += `
                <tr>
                    <td style="font-weight:bold;">${u.username}</td>
                    <td><span class="status-pill status-${u.role === 'admin' ? 'hod' : 'proctor'}">${u.role.toUpperCase()}</span></td>
                    <td style="font-family:monospace; color:#2563eb;">${pwdDisplay}</td>
                </tr>
            `;
        });
    } catch(e) {
        list.innerHTML = "<tr><td colspan='3' style='color:red'>Error loading credentials.</td></tr>";
    }
}

// [Include the rest of the JS for Dashboard, Faculty, Students, Allocations, CSV, etc.]
async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  filtered.forEach(f => {
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;
    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => { listString += `${index + 1}. ${s.name} (${s.rollNo})\n`; });
    } else { listString = "No students assigned yet."; }
    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;
    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    body.innerHTML += `<tr><td>${f.name}</td><td>${f.dept}</td><td>${roleDisplay}</td><td><a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a><a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a></td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td></tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }
async function saveFaculty() {
  const name = document.getElementById("fName").value.trim(); const dept = document.getElementById("fDept").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); } else { alert("Server Error"); }
}
function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id; document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod; document.getElementById("editFRoleCoord").checked = r.coordinator; document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim(); const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value;
    const file = document.getElementById("csvFile").files[0];
    if(!dept || !sem) { alert("Please select both Department and Semester."); return; }
    if(!file) { alert("Please select a CSV file."); return; }
    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result; const rows = text.split('\n').map(r => r.trim()).filter(r => r);
        let studentsToUpload = []; let startIndex = 0;
        if(rows[0] && (rows[0].toLowerCase().includes('name') || rows[0].toLowerCase().includes('roll'))) { startIndex = 1; }
        for(let i=startIndex; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let val1 = cols[0]?.trim(); let val2 = cols[1]?.trim();
                let studentName, studentRoll;
                const isVal1Number = /^\d+$/.test(val1); const isVal2Number = /^\d+$/.test(val2);
                if (isVal1Number && !isVal2Number) { studentRoll = val1; studentName = val2; } else { studentName = val1; studentRoll = val2; }
                if(studentName && studentRoll) { studentsToUpload.push({ name: studentName, rollNo: studentRoll, sem: sem, dept: dept, status: 'Enrolled' }); }
            }
        }
        if(studentsToUpload.length > 0) {
            if(confirm(`Ready to upload ${studentsToUpload.length} students?`)) {
                const res = await fetch('http://localhost:5000/students/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentsToUpload) });
                const data = await res.json(); alert(data.message); closeCSVModal(); loadStudents();
                document.getElementById("csvDept").value = ""; document.getElementById("csvSem").value = ""; document.getElementById("csvFile").value = "";
            }
        } else { alert("No valid data found in CSV."); }
    };
    reader.readAsText(file);
}
async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim(); const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase(); const dept = document.getElementById("studentFilterDept").value; const sem = document.getElementById("studentFilterSem").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`; });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; document.getElementById("studentFilterSem").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name}` : "Unknown"; }
async function loadAllocations() { 
  const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); 
  const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); 
  renderAllocations(); 
}
function renderAllocations() {
  const deptFilter = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const groupings = {};
  allStudents.forEach(s => {
      if(s.proctorId) {
          const key = `${s.proctorId}-${s.dept}-${s.sem}`;
          if(!groupings[key]) { groupings[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 }; }
          groupings[key].count++;
      }
  });
  const groupsArray = Object.values(groupings);
  const filteredGroups = groupsArray.filter(g => deptFilter === "all" || g.dept === deptFilter);
  if (filteredGroups.length === 0) { body.innerHTML = `<tr><td colspan="5">No active class allocations found</td></tr>`; return; }
  filteredGroups.forEach(g => { 
    body.innerHTML += `<tr><td style="font-weight:bold;color:#4e73df;">${getProctorName(g.proctorId)}</td><td>${g.dept}</td><td>Sem ${g.sem}</td><td><span class="status-pill status-coord" style="color:black;">${g.count} Students</span></td><td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.proctorId}', '${g.dept}', '${g.sem}')">Remove</button></td></tr>`; 
  });
}
function openAllocationModal() {
  const facultySelect = document.getElementById("allocFaculty");
  facultySelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value; const sem = document.getElementById("allocSem").value; const facultyId = document.getElementById("allocFaculty").value;
    if(!dept || !sem || !facultyId) { alert("Please select Department, Semester and Proctor."); return; }
    if(confirm(`Assign ALL students in ${dept} Sem ${sem} to selected proctor?`)) {
        await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId }) });
        closeAllocationModal(); loadAllocations();
    }
}
async function unassignClass(proctorId, dept, sem) {
    if(!confirm(`Remove proctor from ${dept} Sem ${sem}?`)) return;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId: null }) });
    loadAllocations();
}
async function autoAllocate() { alert("Auto-allocation is disabled in Class Mode. Please assign classes manually."); }

async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    if (newPassword.length < 6) { alert("Password must be at least 6 chars."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; loadCredentials(); } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Same CSS as before + Table CSS */
    .sec-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .sec-table th, .sec-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
    .sec-table th { background: #f8fafc; color: #64748b; }
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option> </select>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
    <p style="color: #64748b; margin-bottom: 20px;">View usernames, roles, and current passwords.</p>
    
    <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #e2e8f0;">
        <h4 style="margin-top:0;">Emergency Password Override</h4>
        <input type="text" id="secUsername" placeholder="Username" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
        <input type="text" id="secNewPwd" placeholder="New Password" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
        <button class="btn btn-sm btn-primary" onclick="resetUserPassword()">Update</button>
    </div>

    <table class="sec-table">
        <thead> <tr> <th>Username (Roll/Name)</th> <th>Email</th> <th>Role</th> <th>Password</th> </tr> </thead>
        <tbody id="credentialList"> <tr><td colspan="4">Loading credentials...</td></tr> </tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:13px; color:#64748b;">Select Class & Upload CSV<br>(Columns can be: Name, Roll, Email)</p>
        <label>Select Department</label><select id="csvDept"><option value="" disabled selected>Choose Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <label>Select Semester</label><select id="csvSem"><option value="" disabled selected>Choose Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile" accept=".csv">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <input id="fDept" placeholder="Department">
    <input id="fEmail" placeholder="Email Address (Required)"> <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <input type="email" id="sEmail" placeholder="Email Address (Required)"> <select id="sSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label><select id="editSSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor to Class</h3>
    <label>Select Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Select Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Select Proctor</label><select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveClassAllocation()">Assign Class</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
// --- CORE JS ---
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

async function loadCredentials() {
    const list = document.getElementById("credentialList");
    list.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
    try {
        const res = await fetch("http://localhost:5000/users");
        const users = await res.json();
        list.innerHTML = "";
        users.forEach(u => {
            const pwdDisplay = u.role === 'admin' ? '********' : u.password;
            list.innerHTML += `<tr><td style="font-weight:bold;">${u.username}</td><td>${u.email || '-'}</td><td><span class="status-pill status-${u.role === 'admin' ? 'hod' : 'proctor'}">${u.role.toUpperCase()}</span></td><td style="font-family:monospace; color:#2563eb;">${pwdDisplay}</td></tr>`;
        });
    } catch(e) { list.innerHTML = "<tr><td colspan='4' style='color:red'>Error loading credentials.</td></tr>"; }
}

// ... [Existing Dashboard Logic] ...
async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;
    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => { listString += `${index + 1}. ${s.name} (${s.rollNo})\n`; });
    } else { listString = "No students assigned yet."; }
    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;
    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    body.innerHTML += `<tr><td>${f.name}</td><td>${f.dept}</td><td>${roleDisplay}</td><td><a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a><a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a></td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td></tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim(); const dept = document.getElementById("fDept").value;
  const email = document.getElementById("fEmail").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, email, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); } else { alert("Server Error"); }
}
function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id; document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod; document.getElementById("editFRoleCoord").checked = r.coordinator; document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim(); const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value;
    const file = document.getElementById("csvFile").files[0];
    if(!dept || !sem) { alert("Please select both Department and Semester."); return; }
    if(!file) { alert("Please select a CSV file."); return; }
    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result; const rows = text.split('\n').map(r => r.trim()).filter(r => r);
        let studentsToUpload = []; let startIndex = 0;
        if(rows[0] && (rows[0].toLowerCase().includes('name') || rows[0].toLowerCase().includes('roll'))) { startIndex = 1; }
        for(let i=startIndex; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let val1 = cols[0]?.trim(); let val2 = cols[1]?.trim(); let val3 = cols[2]?.trim(); // check for email
                let studentName, studentRoll, studentEmail;
                const isVal1Number = /^\d+$/.test(val1); const isVal2Number = /^\d+$/.test(val2);
                if (isVal1Number && !isVal2Number) { studentRoll = val1; studentName = val2; } else { studentName = val1; studentRoll = val2; }
                
                // Smart email detection: look for @
                if (val3 && val3.includes('@')) studentEmail = val3;
                else studentEmail = `${studentRoll}@student.edu`; // Fallback email

                if(studentName && studentRoll) { studentsToUpload.push({ name: studentName, rollNo: studentRoll, email: studentEmail, sem: sem, dept: dept, status: 'Enrolled' }); }
            }
        }
        if(studentsToUpload.length > 0) {
            if(confirm(`Ready to upload ${studentsToUpload.length} students?`)) {
                const res = await fetch('http://localhost:5000/students/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentsToUpload) });
                const data = await res.json(); alert(data.message); closeCSVModal(); loadStudents();
                document.getElementById("csvDept").value = ""; document.getElementById("csvSem").value = ""; document.getElementById("csvFile").value = "";
            }
        } else { alert("No valid data found in CSV."); }
    };
    reader.readAsText(file);
}
async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim(); const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  const email = document.getElementById("sEmail").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, email, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase(); const dept = document.getElementById("studentFilterDept").value; const sem = document.getElementById("studentFilterSem").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`; });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; document.getElementById("studentFilterSem").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name}` : "Unknown"; }
async function loadAllocations() { 
  const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); 
  const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); 
  renderAllocations(); 
}
function renderAllocations() {
  const deptFilter = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const groupings = {};
  allStudents.forEach(s => {
      if(s.proctorId) {
          const key = `${s.proctorId}-${s.dept}-${s.sem}`;
          if(!groupings[key]) { groupings[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 }; }
          groupings[key].count++;
      }
  });
  const groupsArray = Object.values(groupings);
  const filteredGroups = groupsArray.filter(g => deptFilter === "all" || g.dept === deptFilter);
  if (filteredGroups.length === 0) { body.innerHTML = `<tr><td colspan="5">No active class allocations found</td></tr>`; return; }
  filteredGroups.forEach(g => { 
    body.innerHTML += `<tr><td style="font-weight:bold;color:#4e73df;">${getProctorName(g.proctorId)}</td><td>${g.dept}</td><td>Sem ${g.sem}</td><td><span class="status-pill status-coord" style="color:black;">${g.count} Students</span></td><td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.proctorId}', '${g.dept}', '${g.sem}')">Remove</button></td></tr>`; 
  });
}
function openAllocationModal() {
  const facultySelect = document.getElementById("allocFaculty");
  facultySelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value; const sem = document.getElementById("allocSem").value; const facultyId = document.getElementById("allocFaculty").value;
    if(!dept || !sem || !facultyId) { alert("Please select Department, Semester and Proctor."); return; }
    if(confirm(`Assign ALL students in ${dept} Sem ${sem} to selected proctor?`)) {
        await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId }) });
        closeAllocationModal(); loadAllocations();
    }
}
async function unassignClass(proctorId, dept, sem) {
    if(!confirm(`Remove proctor from ${dept} Sem ${sem}?`)) return;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId: null }) });
    loadAllocations();
}
async function autoAllocate() { alert("Auto-allocation is disabled in Class Mode. Please assign classes manually."); }

async function resetUserPassword() {
    const username = document.getElementById("secUsername").value;
    const newPassword = document.getElementById("secNewPwd").value;
    if (!username || !newPassword) { alert("Please enter username and new password."); return; }
    const res = await fetch("http://localhost:5000/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, newPassword }) });
    const data = await res.json();
    if (res.ok) { alert("Success: " + data.message); document.getElementById("secUsername").value = ""; document.getElementById("secNewPwd").value = ""; loadCredentials(); } else { alert("Error: " + data.message); }
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* ... (Keep existing styles) ... */
    .sec-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .sec-table th, .sec-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
    .sec-table th { background: #f8fafc; color: #64748b; font-weight: 600; }
    .sec-table tr:hover { background-color: #f1f5f9; }
    
    /* Re-adding previous styles for context */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); cursor: pointer; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; color: #334155; cursor: pointer; }
    .checkbox-row label { cursor: pointer; width: 100%; }
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Assigned Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Name / Roll..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option> </select>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <button class="btn btn-dark" onclick="window.print()">Print PDF</button>
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Departments</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn" style="background-color: #4e73df; color: white;" onclick="autoAllocate()">Auto-Allocate</button>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> User Credentials Manager</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Manage login access, update emails for OTP, and reset passwords.</p>
    
    <table class="sec-table">
        <thead> 
            <tr> 
                <th>Username</th> 
                <th>Registered Email</th> 
                <th>Role</th> 
                <th>Password</th> 
                <th>Actions</th> 
            </tr> 
        </thead>
        <tbody id="credentialList"> <tr><td colspan="5">Loading credentials...</td></tr> </tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User Credentials</h3>
        <p style="font-size:12px; color:#64748b;">Updating: <span id="editUserTitle" style="font-weight:bold; color:#2563eb;"></span></p>
        
        <label>Email Address</label>
        <input type="email" id="editUserEmail" placeholder="Enter valid email for OTP">
        
        <label>New Password (Optional)</label>
        <input type="text" id="editUserPwd" placeholder="Leave empty to keep current">
        
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update User</button>
            <button class="btn btn-dark" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:13px; color:#64748b;">Select Class & Upload CSV<br>(Columns: Name, Roll No, [Email])</p>
        <label>Select Department</label><select id="csvDept"><option value="" disabled selected>Choose Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <label>Select Semester</label><select id="csvSem"><option value="" disabled selected>Choose Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile" accept=".csv">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="" disabled selected>Select Department</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <input id="fEmail" placeholder="Email Address (Required)">
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label style="display:block; margin:15px 0 10px; font-weight:600; color:#475569;">Assign Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">Head of Dept (HOD)</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Achievement Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input type="text" id="sName" placeholder="Name"><input type="text" id="sRoll" placeholder="Roll No">
    <input type="email" id="sEmail" placeholder="Email Address (Required)">
    <select id="sSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="sStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll">
    <label>Semester</label><select id="editSSem"><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Status</label><select id="editSStatus"><option value="Enrolled">Enrolled</option><option value="On Leave">On Leave</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Proctor to Class</h3>
    <label>Select Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <label>Select Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Select Proctor</label><select id="allocFaculty"></select>
    <div class="modal-btns"><button id="btnAssignProctor" class="btn btn-primary" onclick="saveClassAllocation()">Assign Class</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
// --- CORE JS ---
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

// --- NEW SECURITY / CREDENTIAL LOGIC ---
let currentUserToEdit = null;

async function loadCredentials() {
    const list = document.getElementById("credentialList");
    list.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    try {
        const res = await fetch("http://localhost:5000/users");
        const users = await res.json();
        list.innerHTML = "";
        
        users.forEach(u => {
            const pwdDisplay = u.role === 'admin' ? '********' : u.password;
            const emailDisplay = u.email || '<span style="color:red;">-</span>';
            
            list.innerHTML += `
                <tr>
                    <td style="font-weight:bold;">${u.username}</td>
                    <td>${emailDisplay}</td>
                    <td><span class="status-pill status-${u.role === 'admin' ? 'hod' : 'proctor'}">${u.role.toUpperCase()}</span></td>
                    <td style="font-family:monospace; color:#2563eb;">${pwdDisplay}</td>
                    <td>
                        <button class="btn btn-sm" style="background-color:#f59e0b; color:white;" onclick="openUserEditModal('${u.username}', '${u.email || ''}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </td>
                </tr>
            `;
        });
    } catch(e) { list.innerHTML = "<tr><td colspan='5' style='color:red'>Error loading credentials.</td></tr>"; }
}

function openUserEditModal(username, email) {
    currentUserToEdit = username;
    document.getElementById("editUserTitle").innerText = username;
    document.getElementById("editUserEmail").value = email;
    document.getElementById("editUserPwd").value = ""; // Clear password field
    document.getElementById("userEditModal").style.display = "flex";
}

function closeUserEditModal() {
    document.getElementById("userEditModal").style.display = "none";
    currentUserToEdit = null;
}

async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value.trim();
    const password = document.getElementById("editUserPwd").value.trim();
    
    if(!email) { alert("Email is required for OTP functionality."); return; }

    const payload = { username: currentUserToEdit, email };
    if(password) payload.password = password; // Only send if changed

    try {
        const res = await fetch("http://localhost:5000/admin/update-user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if(res.ok) {
            alert(data.message);
            closeUserEditModal();
            loadCredentials();
        } else {
            alert("Error: " + data.message);
        }
    } catch(e) {
        alert("Server Connection Error");
    }
}

// ... [Existing Dashboard Logic - kept exactly as before] ...
async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

let allFaculty = [];
let allStudentsForCount = [];

async function loadFaculty() {
  try { 
      const [resFaculty, resStudents] = await Promise.all([
          fetch("http://localhost:5000/faculty"),
          fetch("http://localhost:5000/students")
      ]);
      allFaculty = await resFaculty.json(); 
      allStudentsForCount = await resStudents.json();
      renderFaculty(); 
  } 
  catch (e) { console.error("Error loading faculty:", e); }
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const body = document.getElementById("facultyList"); body.innerHTML = "";
  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));
  
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="5">No faculty found</td></tr>`; return; }
  
  filtered.forEach(f => {
    const assignedStudents = allStudentsForCount.filter(s => s.proctorId === f._id);
    const studentCount = assignedStudents.length;
    let listString = "";
    if (assignedStudents.length > 0) {
        assignedStudents.forEach((s, index) => { listString += `${index + 1}. ${s.name} (${s.rollNo})\n`; });
    } else { listString = "No students assigned yet."; }
    const whatsappLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
    const mailBody = `Hello ${f.name},%0D%0A%0D%0AHere is your updated list of proctor students:%0D%0A${encodeURIComponent(listString)}%0D%0A%0D%0AEduAchieve Admin`;
    const mailLink = `mailto:?subject=Proctor Student List&body=${mailBody}`;
    let roles = []; 
    const r = f.roles || { proctor: false, hod: false, coordinator: false };
    if(r.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
    if(r.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
    if(r.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
    const roleDisplay = roles.length > 0 ? roles.join(" ") : '<span class="status-pill status-faculty">Faculty</span>';
    body.innerHTML += `<tr><td>${f.name}</td><td>${f.dept}</td><td>${roleDisplay}</td><td><a href="${whatsappLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a><a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a></td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td></tr>`;
  });
}

function clearFacultyFilters() { document.getElementById("facultySearch").value = ""; document.getElementById("facultyFilterDept").value = "all"; renderFaculty(); }
async function deleteFaculty(id) { if (confirm("Delete this faculty?")) { await fetch(`http://localhost:5000/faculty/${id}`, { method: "DELETE" }); loadFaculty(); } }
function openFacultyModal() { document.getElementById("facultyModal").style.display = "flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display = "none"; }

async function saveFaculty() {
  const name = document.getElementById("fName").value.trim(); const dept = document.getElementById("fDept").value;
  const email = document.getElementById("fEmail").value;
  if(!name || !dept) { alert("Please fill in Name and select a Department"); return; }
  const roles = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
  const res = await fetch("http://localhost:5000/faculty", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, email, roles }) });
  if(res.ok) { document.getElementById("fName").value=""; document.getElementById("fDept").value=""; document.getElementById("fRoleHOD").checked=false; document.getElementById("fRoleCoord").checked=false; document.getElementById("fRoleProctor").checked=false; closeFacultyModal(); loadFaculty(); } else { alert("Server Error"); }
}
function openEditFacultyModal(id) {
  const f = allFaculty.find(f => f._id === id); if (!f) return;
  currentEditFacultyId = id; document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept || "CE";
  const r = f.roles || { proctor: false, hod: false, coordinator: false };
  document.getElementById("editFRoleHOD").checked = r.hod; document.getElementById("editFRoleCoord").checked = r.coordinator; document.getElementById("editFRoleProctor").checked = r.proctor;
  document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; currentEditFacultyId = null; }
async function updateFaculty() {
  const name = document.getElementById("editFName").value.trim(); const dept = document.getElementById("editFDept").value;
  const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
  const res = await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, dept, roles }) });
  if(res.ok) { closeEditFacultyModal(); loadFaculty(); } else { alert("Update failed."); }
}

let allStudents = []; let currentEditId = null;
async function loadStudents() { const res = await fetch("http://localhost:5000/students"); allStudents = await res.json(); renderStudents(); }
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value;
    const file = document.getElementById("csvFile").files[0];
    if(!dept || !sem) { alert("Please select both Department and Semester."); return; }
    if(!file) { alert("Please select a CSV file."); return; }
    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result; const rows = text.split('\n').map(r => r.trim()).filter(r => r);
        let studentsToUpload = []; let startIndex = 0;
        if(rows[0] && (rows[0].toLowerCase().includes('name') || rows[0].toLowerCase().includes('roll'))) { startIndex = 1; }
        for(let i=startIndex; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let val1 = cols[0]?.trim(); let val2 = cols[1]?.trim(); let val3 = cols[2]?.trim(); 
                let studentName, studentRoll, studentEmail;
                const isVal1Number = /^\d+$/.test(val1); const isVal2Number = /^\d+$/.test(val2);
                if (isVal1Number && !isVal2Number) { studentRoll = val1; studentName = val2; } else { studentName = val1; studentRoll = val2; }
                
                if (val3 && val3.includes('@')) studentEmail = val3;
                else studentEmail = `${studentRoll}@student.edu`;

                if(studentName && studentRoll) { studentsToUpload.push({ name: studentName, rollNo: studentRoll, email: studentEmail, sem: sem, dept: dept, status: 'Enrolled' }); }
            }
        }
        if(studentsToUpload.length > 0) {
            if(confirm(`Ready to upload ${studentsToUpload.length} students?`)) {
                const res = await fetch('http://localhost:5000/students/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(studentsToUpload) });
                const data = await res.json(); alert(data.message); closeCSVModal(); loadStudents();
                document.getElementById("csvDept").value = ""; document.getElementById("csvSem").value = ""; document.getElementById("csvFile").value = "";
            }
        } else { alert("No valid data found in CSV."); }
    };
    reader.readAsText(file);
}
async function saveStudent() {
  const name = document.getElementById("sName").value.trim(); const rollNo = document.getElementById("sRoll").value.trim(); const sem = document.getElementById("sSem").value; const dept = document.getElementById("sDept").value; const status = document.getElementById("sStatus").value;
  const email = document.getElementById("sEmail").value;
  if (!name || !rollNo) { alert("Name and Roll No required"); return; }
  await fetch("http://localhost:5000/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, email, status }) });
  closeStudentModal(); loadStudents();
}
function renderStudents() {
  const search = document.getElementById("studentSearch").value.toLowerCase(); const dept = document.getElementById("studentFilterDept").value; const sem = document.getElementById("studentFilterSem").value;
  const body = document.getElementById("studentList"); body.innerHTML = "";
  const filtered = allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem));
  if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="6">No students found</td></tr>`; return; }
  filtered.forEach(s => { body.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white;margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`; });
}
function clearStudentFilters() { document.getElementById("studentSearch").value = ""; document.getElementById("studentFilterDept").value = "all"; document.getElementById("studentFilterSem").value = "all"; renderStudents(); }
async function deleteStudent(id) { if (confirm("Delete student?")) { await fetch(`http://localhost:5000/students/${id}`, { method: "DELETE" }); loadStudents(); } }
function openStudentModal() { document.getElementById("studentModal").style.display = "flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display = "none"; }
function openEditStudentModal(id) {
  const s = allStudents.find(s => s._id === id); if (!s) return;
  currentEditId = id; document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept; document.getElementById("editSStatus").value = s.status;
  document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; currentEditId = null; }
async function updateStudent() {
  const name = document.getElementById("editSName").value; const rollNo = document.getElementById("editSRoll").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const status = document.getElementById("editSStatus").value;
  await fetch(`http://localhost:5000/students/${currentEditId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, rollNo, sem, dept, status }) });
  closeEditStudentModal(); loadStudents();
}

function getProctorName(id) { const f = allFaculty.find(f => f._id === id); return f ? `${f.name}` : "Unknown"; }
async function loadAllocations() { 
  const sRes = await fetch("http://localhost:5000/students"); allStudents = await sRes.json(); 
  const fRes = await fetch("http://localhost:5000/faculty"); allFaculty = await fRes.json(); 
  renderAllocations(); 
}
function renderAllocations() {
  const deptFilter = document.getElementById("allocFilterDept").value;
  const body = document.getElementById("allocationList"); body.innerHTML = "";
  const groupings = {};
  allStudents.forEach(s => {
      if(s.proctorId) {
          const key = `${s.proctorId}-${s.dept}-${s.sem}`;
          if(!groupings[key]) { groupings[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 }; }
          groupings[key].count++;
      }
  });
  const groupsArray = Object.values(groupings);
  const filteredGroups = groupsArray.filter(g => deptFilter === "all" || g.dept === deptFilter);
  if (filteredGroups.length === 0) { body.innerHTML = `<tr><td colspan="5">No active class allocations found</td></tr>`; return; }
  filteredGroups.forEach(g => { 
    body.innerHTML += `<tr><td style="font-weight:bold;color:#4e73df;">${getProctorName(g.proctorId)}</td><td>${g.dept}</td><td>Sem ${g.sem}</td><td><span class="status-pill status-coord" style="color:black;">${g.count} Students</span></td><td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.proctorId}', '${g.dept}', '${g.sem}')">Remove</button></td></tr>`; 
  });
}
function openAllocationModal() {
  const facultySelect = document.getElementById("allocFaculty");
  facultySelect.innerHTML = allFaculty.filter(f => f.roles && f.roles.proctor).map(f => `<option value="${f._id}">${f.name} (${f.dept})</option>`).join("");
  document.getElementById("allocationModal").style.display = "flex";
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display = "none"; }
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value; const sem = document.getElementById("allocSem").value; const facultyId = document.getElementById("allocFaculty").value;
    if(!dept || !sem || !facultyId) { alert("Please select Department, Semester and Proctor."); return; }
    if(confirm(`Assign ALL students in ${dept} Sem ${sem} to selected proctor?`)) {
        await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId }) });
        closeAllocationModal(); loadAllocations();
    }
}
async function unassignClass(proctorId, dept, sem) {
    if(!confirm(`Remove proctor from ${dept} Sem ${sem}?`)) return;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, sem, facultyId: null }) });
    loadAllocations();
}
async function autoAllocate() { alert("Auto-allocation is disabled in Class Mode. Please assign classes manually."); }

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->





<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* --- TABLE STYLES --- */
    .sec-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .sec-table th, .sec-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
    .sec-table th { background: #f8fafc; color: #64748b; font-weight: 600; }
    
    /* --- BADGES --- */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-admin { background: #fee2e2; color: #b91c1c; }
    .status-student { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }

    /* --- ICONS --- */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
    
    /* --- CHECKBOXES --- */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> User Credentials Manager</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Manage login access and update emails for OTP.</p>
    
    <table class="sec-table">
        <thead> 
            <tr> 
                <th>Username</th> 
                <th>Registered Email</th> 
                <th>Role</th> 
                <th>Password</th> 
                <th>Actions</th> 
            </tr> 
        </thead>
        <tbody id="credentialList"> <tr><td colspan="5">Loading...</td></tr> </tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <label>Email (For OTP)</label>
        <input type="email" id="editUserEmail" placeholder="Enter valid email">
        <label>New Password</label>
        <input type="text" id="editUserPwd" placeholder="Leave blank to keep current">
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-dark" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:12px; color:#666;">Format: Name, RollNo, [Email]</p>
        <select id="csvDept"><option value="" disabled selected>Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <select id="csvSem"><option value="" disabled selected>Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <input id="fEmail" placeholder="Email (Optional)">
    <label style="display:block; margin:10px 0 5px; font-weight:600;">Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input id="sName" placeholder="Name"><input id="sRoll" placeholder="Roll No">
    <input id="sEmail" placeholder="Email">
    <select id="sSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Class</h3>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveClassAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS (Restored WhatsApp) ---
let allFaculty = [];
let allStudents = [];

async function loadFaculty() {
  const [fRes, sRes] = await Promise.all([
      fetch("http://localhost:5000/faculty"),
      fetch("http://localhost:5000/students")
  ]);
  allFaculty = await fRes.json();
  allStudents = await sRes.json();
  renderFaculty();
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const list = document.getElementById("facultyList"); 
  list.innerHTML = "";

  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));

  filtered.forEach(f => {
      // Logic for WhatsApp List
      const myStudents = allStudents.filter(s => s.proctorId === f._id);
      const studentCount = myStudents.length;
      let listString = "";
      myStudents.forEach((s, i) => listString += `${i+1}. ${s.name} (${s.rollNo})\n`);
      
      const waLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
      const mailLink = `mailto:?subject=Proctor List&body=${encodeURIComponent(listString)}`;

      // Role Pills
      let roles = [];
      if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
      if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
      if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);

      list.innerHTML += `
        <tr>
            <td>${f.name}</td>
            <td>${f.dept}</td>
            <td>${roles.join(" ")}</td>
            <td>
                <a href="${waLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a>
                <a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a>
            </td>
            <td><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td>
        </tr>`;
  });
}
function clearFacultyFilters() { document.getElementById("facultySearch").value=""; document.getElementById("facultyFilterDept").value="all"; renderFaculty(); }

// --- STUDENT FUNCTIONS (Restored CSV) ---
async function loadStudents() {
  const res = await fetch("http://localhost:5000/students");
  allStudents = await res.json();
  renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList");
    list.innerHTML = "";

    const filtered = allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) &&
        (dept === "all" || s.dept === dept) &&
        (sem === "all" || String(s.sem) === sem)
    );

    filtered.forEach(s => {
        list.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
    });
}

// CSV LOGIC
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function processCSVUpload() {
    const dept = document.getElementById("csvDept").value;
    const sem = document.getElementById("csvSem").value;
    const file = document.getElementById("csvFile").files[0];

    if(!file || !dept || !sem) { alert("Please fill all fields"); return; }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let studentsToUpload = [];
        
        // Skip header if exists
        let start = (rows[0].toLowerCase().includes('name')) ? 1 : 0;

        for(let i=start; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                // Heuristic to find Name vs Roll
                let v1 = cols[0].trim(), v2 = cols[1].trim(), v3 = cols[2]?.trim();
                let name, roll, email;
                
                if(/^\d+$/.test(v1)) { roll = v1; name = v2; } else { name = v1; roll = v2; }
                email = (v3 && v3.includes('@')) ? v3 : `${roll}@student.edu`;

                if(name && roll) {
                    studentsToUpload.push({ name, rollNo: roll, email, sem, dept, status: 'Enrolled' });
                }
            }
        }

        if(studentsToUpload.length > 0 && confirm(`Upload ${studentsToUpload.length} students?`)) {
            await fetch('http://localhost:5000/students/bulk', { 
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(studentsToUpload) 
            });
            alert("Upload Complete");
            closeCSVModal();
            loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION (Restored Group View) ---
async function loadAllocations() {
    loadFaculty(); // refresh dropdown
    const res = await fetch("http://localhost:5000/students");
    const students = await res.json();
    renderAllocations(students);
}

function renderAllocations(students = allStudents) {
    const deptFilter = document.getElementById("allocFilterDept").value;
    const list = document.getElementById("allocationList");
    list.innerHTML = "";

    const groups = {};
    students.forEach(s => {
        if(s.proctorId) {
            const key = `${s.proctorId}-${s.dept}-${s.sem}`;
            if(!groups[key]) groups[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 };
            groups[key].count++;
        }
    });

    Object.values(groups).forEach(g => {
        if(deptFilter !== "all" && g.dept !== deptFilter) return;
        
        const proctorName = allFaculty.find(f => f._id === g.proctorId)?.name || "Unknown";
        
        list.innerHTML += `
            <tr>
                <td style="color:#2563eb; font-weight:bold;">${proctorName}</td>
                <td>${g.dept}</td>
                <td>Sem ${g.sem}</td>
                <td><span class="status-pill status-coord" style="color:black">${g.count} Students</span></td>
                <td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.dept}', '${g.sem}')">Remove</button></td>
            </tr>`;
    });
}

async function unassignClass(dept, sem) {
    if(confirm(`Remove proctor from ${dept} Sem ${sem}?`)) {
        await fetch("http://localhost:5000/allocate/class", { 
            method: "POST", headers: {"Content-Type":"application/json"}, 
            body: JSON.stringify({ dept, sem, facultyId: null }) 
        });
        loadAllocations();
    }
}

// --- SECURITY (Keep new Edit Feature) ---
let currentUserToEdit = null;
async function loadCredentials() {
    const list = document.getElementById("credentialList");
    try {
        const res = await fetch("http://localhost:5000/users");
        const users = await res.json();
        list.innerHTML = "";
        users.forEach(u => {
            const pwd = u.role === 'admin' ? '********' : u.password;
            list.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.email||'-'}</td><td><span class="status-pill status-${u.role}">${u.role}</span></td><td>${pwd}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white" onclick="openUserEditModal('${u.username}', '${u.email}')">Edit</button></td></tr>`;
        });
    } catch(e) { list.innerHTML = "<tr><td colspan='5'>Error loading</td></tr>"; }
}

function openUserEditModal(user, email) {
    currentUserToEdit = user;
    document.getElementById("editUserTitle").innerText = user;
    document.getElementById("editUserEmail").value = (email && email !== 'undefined') ? email : '';
    document.getElementById("userEditModal").style.display = "flex";
}
function closeUserEditModal() { document.getElementById("userEditModal").style.display = "none"; }

async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value;
    const password = document.getElementById("editUserPwd").value;
    const payload = { username: currentUserToEdit, email };
    if(password) payload.password = password;
    
    await fetch("http://localhost:5000/admin/update-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    closeUserEditModal(); loadCredentials();
}

// --- STANDARD MODALS & SAVES ---
function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display="none"; }
async function saveFaculty() {
    const name = document.getElementById("fName").value;
    const dept = document.getElementById("fDept").value;
    const email = document.getElementById("fEmail").value;
    const roles = {
        hod: document.getElementById("fRoleHOD").checked,
        coordinator: document.getElementById("fRoleCoord").checked,
        proctor: document.getElementById("fRoleProctor").checked
    };
    await fetch("http://localhost:5000/faculty", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name, dept, email, roles}) });
    closeFacultyModal(); loadFaculty();
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const name = document.getElementById("sName").value;
    const rollNo = document.getElementById("sRoll").value;
    const sem = document.getElementById("sSem").value;
    const dept = document.getElementById("sDept").value;
    const email = document.getElementById("sEmail").value;
    await fetch("http://localhost:5000/students", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name, rollNo, sem, dept, email}) });
    closeStudentModal(); loadStudents();
}

async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/faculty/${id}`, {method:"DELETE"}); loadFaculty(); } }
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/students/${id}`, {method:"DELETE"}); loadStudents(); } }

function openAllocationModal() { 
    const sel = document.getElementById("allocFaculty");
    sel.innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value;
    const sem = document.getElementById("allocSem").value;
    const facultyId = document.getElementById("allocFaculty").value;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({dept, sem, facultyId}) });
    closeAllocationModal(); loadAllocations();
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->




<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* --- TABLE STYLES --- */
    .sec-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .sec-table th, .sec-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
    .sec-table th { background: #f8fafc; color: #64748b; font-weight: 600; }
    
    /* --- BADGES --- */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-admin { background: #fee2e2; color: #b91c1c; }
    .status-student { background: #dcfce7; color: #15803d; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }

    /* --- ICONS --- */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
    
    /* --- CHECKBOXES --- */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; }
    
    /* --- SIDEBAR BOTTOM --- */
    .logout-btn { margin-top: 10px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> User Credentials Manager</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Manage login access and update emails for OTP.</p>
    
    <table class="sec-table">
        <thead> 
            <tr> 
                <th>Username</th> 
                <th>Registered Email</th> 
                <th>Role</th> 
                <th>Password</th> 
                <th>Actions</th> 
            </tr> 
        </thead>
        <tbody id="credentialList"> <tr><td colspan="5">Loading...</td></tr> </tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <label>Email (For OTP)</label>
        <input type="email" id="editUserEmail" placeholder="Enter valid email">
        <label>New Password</label>
        <input type="text" id="editUserPwd" placeholder="Leave blank to keep current">
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-dark" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:12px; color:#666;">Format: Name, RollNo, [Email]</p>
        <select id="csvDept"><option value="" disabled selected>Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <select id="csvSem"><option value="" disabled selected>Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <input id="fEmail" placeholder="Email (Optional)">
    <label style="display:block; margin:10px 0 5px; font-weight:600;">Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input id="sName" placeholder="Name"><input id="sRoll" placeholder="Roll No">
    <input id="sEmail" placeholder="Email">
    <select id="sSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Class</h3>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveClassAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS (With WhatsApp + Faculty Label) ---
let allFaculty = [];
let allStudents = [];

async function loadFaculty() {
  const [fRes, sRes] = await Promise.all([
      fetch("http://localhost:5000/faculty"),
      fetch("http://localhost:5000/students")
  ]);
  allFaculty = await fRes.json();
  allStudents = await sRes.json();
  renderFaculty();
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const list = document.getElementById("facultyList"); 
  list.innerHTML = "";

  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));

  filtered.forEach(f => {
      // WhatsApp Logic
      const myStudents = allStudents.filter(s => s.proctorId === f._id);
      const studentCount = myStudents.length;
      let listString = "";
      myStudents.forEach((s, i) => listString += `${i+1}. ${s.name} (${s.rollNo})\n`);
      
      const waLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
      const mailLink = `mailto:?subject=Proctor List&body=${encodeURIComponent(listString)}`;

      // Role Pills
      let roles = [];
      if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
      if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
      if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
      if(roles.length === 0) roles.push('<span class="status-pill status-faculty">Faculty</span>');

      list.innerHTML += `
        <tr>
            <td>${f.name}</td>
            <td>${f.dept}</td>
            <td>${roles.join(" ")}</td>
            <td>
                <a href="${waLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a>
                <a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a>
            </td>
            <td><button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button></td>
        </tr>`;
  });
}
function clearFacultyFilters() { document.getElementById("facultySearch").value=""; document.getElementById("facultyFilterDept").value="all"; renderFaculty(); }

// --- STUDENT FUNCTIONS (With CSV) ---
async function loadStudents() {
  const res = await fetch("http://localhost:5000/students");
  allStudents = await res.json();
  renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList");
    list.innerHTML = "";

    const filtered = allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) &&
        (dept === "all" || s.dept === dept) &&
        (sem === "all" || String(s.sem) === sem)
    );

    filtered.forEach(s => {
        list.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td>${s.status}</td><td><button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button></td></tr>`;
    });
}

function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function processCSVUpload() {
    const dept = document.getElementById("csvDept").value;
    const sem = document.getElementById("csvSem").value;
    const file = document.getElementById("csvFile").files[0];

    if(!file || !dept || !sem) { alert("Please fill all fields"); return; }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let studentsToUpload = [];
        let start = (rows[0].toLowerCase().includes('name')) ? 1 : 0;

        for(let i=start; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let v1 = cols[0].trim(), v2 = cols[1].trim(), v3 = cols[2]?.trim();
                let name, roll, email;
                
                if(/^\d+$/.test(v1)) { roll = v1; name = v2; } else { name = v1; roll = v2; }
                email = (v3 && v3.includes('@')) ? v3 : `${roll}@student.edu`;

                if(name && roll) {
                    studentsToUpload.push({ name, rollNo: roll, email, sem, dept, status: 'Enrolled' });
                }
            }
        }

        if(studentsToUpload.length > 0 && confirm(`Upload ${studentsToUpload.length} students?`)) {
            await fetch('http://localhost:5000/students/bulk', { 
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(studentsToUpload) 
            });
            alert("Upload Complete");
            closeCSVModal();
            loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATIONS ---
async function loadAllocations() {
    loadFaculty(); 
    const res = await fetch("http://localhost:5000/students");
    const students = await res.json();
    renderAllocations(students);
}

function renderAllocations(students = allStudents) {
    const deptFilter = document.getElementById("allocFilterDept").value;
    const list = document.getElementById("allocationList");
    list.innerHTML = "";

    const groups = {};
    students.forEach(s => {
        if(s.proctorId) {
            const key = `${s.proctorId}-${s.dept}-${s.sem}`;
            if(!groups[key]) groups[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 };
            groups[key].count++;
        }
    });

    Object.values(groups).forEach(g => {
        if(deptFilter !== "all" && g.dept !== deptFilter) return;
        const proctorName = allFaculty.find(f => f._id === g.proctorId)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:#2563eb; font-weight:bold;">${proctorName}</td><td>${g.dept}</td><td>Sem ${g.sem}</td><td><span class="status-pill status-coord" style="color:black">${g.count} Students</span></td><td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.dept}', '${g.sem}')">Remove</button></td></tr>`;
    });
}

async function unassignClass(dept, sem) {
    if(confirm(`Remove proctor from ${dept} Sem ${sem}?`)) {
        await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept, sem, facultyId: null }) });
        loadAllocations();
    }
}

// --- SECURITY (Edit Emails) ---
let currentUserToEdit = null;
async function loadCredentials() {
    const list = document.getElementById("credentialList");
    try {
        const res = await fetch("http://localhost:5000/users");
        const users = await res.json();
        list.innerHTML = "";
        users.forEach(u => {
            const pwd = u.role === 'admin' ? '********' : u.password;
            list.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.email||'-'}</td><td><span class="status-pill status-${u.role}">${u.role}</span></td><td>${pwd}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white" onclick="openUserEditModal('${u.username}', '${u.email}')">Edit</button></td></tr>`;
        });
    } catch(e) { list.innerHTML = "<tr><td colspan='5'>Error loading</td></tr>"; }
}

function openUserEditModal(user, email) {
    currentUserToEdit = user;
    document.getElementById("editUserTitle").innerText = user;
    document.getElementById("editUserEmail").value = (email && email !== 'undefined') ? email : '';
    document.getElementById("userEditModal").style.display = "flex";
}
function closeUserEditModal() { document.getElementById("userEditModal").style.display = "none"; }

async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value;
    const password = document.getElementById("editUserPwd").value;
    const payload = { username: currentUserToEdit, email };
    if(password) payload.password = password;
    
    await fetch("http://localhost:5000/admin/update-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    closeUserEditModal(); loadCredentials();
}

// --- MODALS ---
function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display="none"; }
async function saveFaculty() {
    const name = document.getElementById("fName").value;
    const dept = document.getElementById("fDept").value;
    const email = document.getElementById("fEmail").value;
    const roles = {
        hod: document.getElementById("fRoleHOD").checked,
        coordinator: document.getElementById("fRoleCoord").checked,
        proctor: document.getElementById("fRoleProctor").checked
    };
    await fetch("http://localhost:5000/faculty", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name, dept, email, roles}) });
    closeFacultyModal(); loadFaculty();
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const name = document.getElementById("sName").value;
    const rollNo = document.getElementById("sRoll").value;
    const sem = document.getElementById("sSem").value;
    const dept = document.getElementById("sDept").value;
    const email = document.getElementById("sEmail").value;
    await fetch("http://localhost:5000/students", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name, rollNo, sem, dept, email}) });
    closeStudentModal(); loadStudents();
}

async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/faculty/${id}`, {method:"DELETE"}); loadFaculty(); } }
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/students/${id}`, {method:"DELETE"}); loadStudents(); } }

function openAllocationModal() { 
    const sel = document.getElementById("allocFaculty");
    sel.innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value;
    const sem = document.getElementById("allocSem").value;
    const facultyId = document.getElementById("allocFaculty").value;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({dept, sem, facultyId}) });
    closeAllocationModal(); loadAllocations();
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->




<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Management</title>
<link rel="stylesheet" href="style1.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* --- TABLE STYLES --- */
    .sec-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .sec-table th, .sec-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
    .sec-table th { background: #f8fafc; color: #64748b; font-weight: 600; }
    
    /* --- BADGES --- */
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-right: 4px; }
    .status-admin { background: #fee2e2; color: #b91c1c; }
    .status-student { background: #dcfce7; color: #15803d; }
    .status-hod { background: #fee2e2; color: #b91c1c; }
    .status-coord { background: #fef3c7; color: #b45309; }
    .status-proctor { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
    .count-badge { background: rgba(0,0,0,0.15); color: #064e3b; padding: 1px 6px; border-radius: 10px; margin-left: 5px; font-size: 10px; }

    /* --- ICONS --- */
    .notify-icon { font-size: 18px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
    
    /* --- CHECKBOXES --- */
    .modal-content input[type="checkbox"] { width: auto !important; display: inline-block !important; margin-right: 10px !important; transform: scale(1.2); }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 15px; }
    
    /* --- SIDEBAR BOTTOM --- */
    .logout-btn { margin-top: 10px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-university"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-chart-line"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-link"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Security </button>
  </div>
  
  <button class="menu-item logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
  <button class="menu-item logout-btn" onclick="resetSystem()"> <i class="fas fa-trash"></i> Reset System </button>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Item</p><h2 id="semBreakdown" class="breakdown-container">0</h2></div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Clear</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Notify</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option><option value="7">Sem 7</option><option value="8">Sem 8</option> </select>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Upload CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> User Credentials Manager</h2>
    <p style="color: #64748b; margin-bottom: 20px;">Manage login access and update emails for OTP.</p>
    
    <table class="sec-table">
        <thead> 
            <tr> 
                <th>Username</th> 
                <th>Registered Email</th> 
                <th>Role</th> 
                <th>Password</th> 
                <th>Actions</th> 
            </tr> 
        </thead>
        <tbody id="credentialList"> <tr><td colspan="5">Loading...</td></tr> </tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <label>Email (For OTP)</label>
        <input type="email" id="editUserEmail" placeholder="Enter valid email">
        <label>New Password</label>
        <input type="text" id="editUserPwd" placeholder="Leave blank to keep current">
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-dark" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName" placeholder="Full Name">
    <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <input id="editFEmail" placeholder="Email">
    <label style="display:block; margin:10px 0 5px; font-weight:600;">Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label for="editFRoleHOD">HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label for="editFRoleCoord">Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label for="editFRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-dark" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll" disabled style="background:#f1f5f9;"> <label>Email</label><input type="text" id="editSEmail">
    <label>Semester</label><select id="editSSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-dark" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload Students</h3>
        <p style="font-size:12px; color:#666;">Format: Name, RollNo, [Email]</p>
        <select id="csvDept"><option value="" disabled selected>Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <select id="csvSem"><option value="" disabled selected>Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-dark" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Full Name">
    <select id="fDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <input id="fEmail" placeholder="Email (Optional)">
    <label style="display:block; margin:10px 0 5px; font-weight:600;">Roles:</label>
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label for="fRoleHOD">HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label for="fRoleCoord">Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label for="fRoleProctor">Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-dark" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input id="sName" placeholder="Name"><input id="sRoll" placeholder="Roll No">
    <input id="sEmail" placeholder="Email">
    <select id="sSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-dark" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Class</h3>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveClassAllocation()">Assign</button><button class="btn btn-dark" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

async function loadDashboard() {
  const students = await fetch("http://localhost:5000/students").then(r => r.json());
  const faculty = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = students.length;
  document.getElementById("totalFaculty").innerText = faculty.length;
  document.getElementById("unassignedStudents").innerText = students.filter(s => !s.proctorId).length;
}

// --- FACULTY FUNCTIONS (With Edit) ---
let allFaculty = [];
let allStudents = [];
let currentEditFacultyId = null;

async function loadFaculty() {
  const [fRes, sRes] = await Promise.all([
      fetch("http://localhost:5000/faculty"),
      fetch("http://localhost:5000/students")
  ]);
  allFaculty = await fRes.json();
  allStudents = await sRes.json();
  renderFaculty();
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const list = document.getElementById("facultyList"); 
  list.innerHTML = "";

  const filtered = allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept));

  filtered.forEach(f => {
      // WhatsApp Logic
      const myStudents = allStudents.filter(s => s.proctorId === f._id);
      const studentCount = myStudents.length;
      let listString = "";
      myStudents.forEach((s, i) => listString += `${i+1}. ${s.name} (${s.rollNo})\n`);
      
      const waLink = `https://wa.me/?text=Hello ${encodeURIComponent(f.name)}, here is your proctor list:%0A${encodeURIComponent(listString)}`;
      const mailLink = `mailto:?subject=Proctor List&body=${encodeURIComponent(listString)}`;

      // Role Pills
      let roles = [];
      if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
      if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
      if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${studentCount}</span></span>`);
      if(roles.length === 0) roles.push('<span class="status-pill status-faculty">Faculty</span>');

      list.innerHTML += `
        <tr>
            <td>${f.name}</td>
            <td>${f.dept}</td>
            <td>${roles.join(" ")}</td>
            <td>
                <a href="${waLink}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366;"></i></a>
                <a href="${mailLink}"><i class="fas fa-envelope notify-icon" style="color:#3b82f6;"></i></a>
            </td>
            <td>
                <button class="btn btn-sm" style="background:#f59e0b; margin-right:5px;" onclick="openEditFacultyModal('${f._id}')">Edit</button>
                <button class="btn btn-sm" onclick="deleteFaculty('${f._id}')">Delete</button>
            </td>
        </tr>`;
  });
}
function clearFacultyFilters() { document.getElementById("facultySearch").value=""; document.getElementById("facultyFilterDept").value="all"; renderFaculty(); }

// Edit Faculty
function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id);
    if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name;
    document.getElementById("editFDept").value = f.dept;
    document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFRoleHOD").checked = f.roles?.hod || false;
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator || false;
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor || false;
    document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value;
    const dept = document.getElementById("editFDept").value;
    const email = document.getElementById("editFEmail").value;
    const roles = {
        hod: document.getElementById("editFRoleHOD").checked,
        coordinator: document.getElementById("editFRoleCoord").checked,
        proctor: document.getElementById("editFRoleProctor").checked
    };
    await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { 
        method: "PUT", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept, email, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENT FUNCTIONS (With Edit) ---
let currentEditStudentId = null;

async function loadStudents() {
  const res = await fetch("http://localhost:5000/students");
  allStudents = await res.json();
  renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList");
    list.innerHTML = "";

    const filtered = allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) &&
        (dept === "all" || s.dept === dept) &&
        (sem === "all" || String(s.sem) === sem)
    );

    filtered.forEach(s => {
        list.innerHTML += `
            <tr>
                <td>${s.name}</td>
                <td>${s.rollNo}</td>
                <td>${s.sem}</td>
                <td>${s.dept}</td>
                <td>${s.status}</td>
                <td>
                    <button class="btn btn-sm" style="background:#f59e0b; margin-right:5px;" onclick="openEditStudentModal('${s._id}')">Edit</button>
                    <button class="btn btn-sm" onclick="deleteStudent('${s._id}')">Delete</button>
                </td>
            </tr>`;
    });
}

// Edit Student
function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id);
    if(!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name;
    document.getElementById("editSRoll").value = s.rollNo;
    document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSSem").value = s.sem;
    document.getElementById("editSDept").value = s.dept;
    document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; }

async function updateStudent() {
    const name = document.getElementById("editSName").value;
    const sem = document.getElementById("editSSem").value;
    const dept = document.getElementById("editSDept").value;
    const email = document.getElementById("editSEmail").value;
    
    await fetch(`http://localhost:5000/students/${currentEditStudentId}`, { 
        method: "PUT", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, sem, dept, email}) 
    });
    closeEditStudentModal(); loadStudents();
}

function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function processCSVUpload() {
    const dept = document.getElementById("csvDept").value;
    const sem = document.getElementById("csvSem").value;
    const file = document.getElementById("csvFile").files[0];

    if(!file || !dept || !sem) { alert("Please fill all fields"); return; }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let studentsToUpload = [];
        let start = (rows[0].toLowerCase().includes('name')) ? 1 : 0;

        for(let i=start; i<rows.length; i++) {
            const cols = rows[i].split(',');
            if(cols.length >= 2) {
                let v1 = cols[0].trim(), v2 = cols[1].trim(), v3 = cols[2]?.trim();
                let name, roll, email;
                
                if(/^\d+$/.test(v1)) { roll = v1; name = v2; } else { name = v1; roll = v2; }
                email = (v3 && v3.includes('@')) ? v3 : `${roll}@student.edu`;

                if(name && roll) {
                    studentsToUpload.push({ name, rollNo: roll, email, sem, dept, status: 'Enrolled' });
                }
            }
        }

        if(studentsToUpload.length > 0 && confirm(`Upload ${studentsToUpload.length} students?`)) {
            await fetch('http://localhost:5000/students/bulk', { 
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(studentsToUpload) 
            });
            alert("Upload Complete");
            closeCSVModal();
            loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATIONS ---
async function loadAllocations() {
    loadFaculty(); 
    const res = await fetch("http://localhost:5000/students");
    const students = await res.json();
    renderAllocations(students);
}

function renderAllocations(students = allStudents) {
    const deptFilter = document.getElementById("allocFilterDept").value;
    const list = document.getElementById("allocationList");
    list.innerHTML = "";

    const groups = {};
    students.forEach(s => {
        if(s.proctorId) {
            const key = `${s.proctorId}-${s.dept}-${s.sem}`;
            if(!groups[key]) groups[key] = { proctorId: s.proctorId, dept: s.dept, sem: s.sem, count: 0 };
            groups[key].count++;
        }
    });

    Object.values(groups).forEach(g => {
        if(deptFilter !== "all" && g.dept !== deptFilter) return;
        const proctorName = allFaculty.find(f => f._id === g.proctorId)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:#2563eb; font-weight:bold;">${proctorName}</td><td>${g.dept}</td><td>Sem ${g.sem}</td><td><span class="status-pill status-coord" style="color:black">${g.count} Students</span></td><td><button class="btn btn-sm btn-dark" onclick="unassignClass('${g.dept}', '${g.sem}')">Remove</button></td></tr>`;
    });
}

async function unassignClass(dept, sem) {
    if(confirm(`Remove proctor from ${dept} Sem ${sem}?`)) {
        await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept, sem, facultyId: null }) });
        loadAllocations();
    }
}

// --- SECURITY (Edit Emails) ---
let currentUserToEdit = null;
async function loadCredentials() {
    const list = document.getElementById("credentialList");
    try {
        const res = await fetch("http://localhost:5000/users");
        const users = await res.json();
        list.innerHTML = "";
        users.forEach(u => {
            const pwd = u.role === 'admin' ? '********' : u.password;
            list.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.email||'-'}</td><td><span class="status-pill status-${u.role}">${u.role}</span></td><td>${pwd}</td><td><button class="btn btn-sm" style="background:#f59e0b;color:white" onclick="openUserEditModal('${u.username}', '${u.email}')">Edit</button></td></tr>`;
        });
    } catch(e) { list.innerHTML = "<tr><td colspan='5'>Error loading</td></tr>"; }
}

function openUserEditModal(user, email) {
    currentUserToEdit = user;
    document.getElementById("editUserTitle").innerText = user;
    document.getElementById("editUserEmail").value = (email && email !== 'undefined') ? email : '';
    document.getElementById("userEditModal").style.display = "flex";
}
function closeUserEditModal() { document.getElementById("userEditModal").style.display = "none"; }

async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value;
    const password = document.getElementById("editUserPwd").value;
    const payload = { username: currentUserToEdit, email };
    if(password) payload.password = password;
    
    await fetch("http://localhost:5000/admin/update-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    closeUserEditModal(); loadCredentials();
}

// --- MODALS ---
function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display="none"; }
async function saveFaculty() {
    const name = document.getElementById("fName").value;
    const dept = document.getElementById("fDept").value;
    const email = document.getElementById("fEmail").value;
    const roles = {
        hod: document.getElementById("fRoleHOD").checked,
        coordinator: document.getElementById("fRoleCoord").checked,
        proctor: document.getElementById("fRoleProctor").checked
    };
    await fetch("http://localhost:5000/faculty", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name, dept, email, roles}) });
    closeFacultyModal(); loadFaculty();
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const name = document.getElementById("sName").value;
    const rollNo = document.getElementById("sRoll").value;
    const sem = document.getElementById("sSem").value;
    const dept = document.getElementById("sDept").value;
    const email = document.getElementById("sEmail").value;
    await fetch("http://localhost:5000/students", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name, rollNo, sem, dept, email}) });
    closeStudentModal(); loadStudents();
}

async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/faculty/${id}`, {method:"DELETE"}); loadFaculty(); } }
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/students/${id}`, {method:"DELETE"}); loadStudents(); } }

function openAllocationModal() { 
    const sel = document.getElementById("allocFaculty");
    sel.innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const dept = document.getElementById("allocDept").value;
    const sem = document.getElementById("allocSem").value;
    const facultyId = document.getElementById("allocFaculty").value;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({dept, sem, facultyId}) });
    closeAllocationModal(); loadAllocations();
}

function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { alert("System reset (demo)"); }
document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->





<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6;
        --sidebar-bg: #1e293b;
        --sidebar-text: #e2e8f0;
        --card-bg: #ffffff;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
    }

    /* DARK MODE VARIABLES */
    body.dark-mode {
        --bg-color: #0f172a;
        --sidebar-bg: #020617;
        --card-bg: #1e293b;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --border-color: #334155;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: background 0.3s, color 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; transition: background 0.3s; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    .menu-item i { width: 20px; text-align: center; }
    
    /* BOTTOM ACTIONS */
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .btn-logout:hover { background: #475569; }

    /* DARK MODE TOGGLE */
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: flex; justify-content: center; align-items: center; gap: 8px; user-select: none; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    h1, h2 { margin-bottom: 20px; font-weight: 700; }

    /* CARDS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
    .card p { color: var(--text-muted); font-size: 14px; margin-bottom: 5px; }
    .card h2 { font-size: 28px; margin: 0; color: var(--primary); }

    /* TABLES & HEADERS */
    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; vertical-align: middle; }
    
    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; }
    .status-student { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #e0e7ff; color: #3730a3; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; margin-left: 5px; }

    /* BUTTONS */
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .notify-icon { font-size: 18px; margin-right: 8px; color: var(--text-muted); transition: 0.2s; }
    .notify-icon:hover { transform: scale(1.2); color: var(--primary); }

    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border-color); animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-content h3 { margin-bottom: 20px; color: var(--text-main); }
    .modal-content label { display: block; margin: 12px 0 5px; font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .modal-content input, .modal-content select { width: 100%; padding: 10px; margin-bottom: 5px; }
    .modal-btns { margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; }
    
    /* CHECKBOX FIX */
    .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer; }
    .checkbox-row input { width: auto; margin: 0; transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>

  <div class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-moon"></i> <span>Dark Mode</span>
  </div>

  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card"><p>Total Students</p><h2 id="totalStudents">0</h2></div>
    <div class="card"><p>Total Faculty</p><h2 id="totalFaculty">0</h2></div>
    <div class="card"><p>Unassigned Students</p><h2 id="unassignedStudents">0</h2></div>
    <div class="card"><p>Action Items</p><h2>3</h2></div>
  </div>
  
  <div class="card" style="margin-top: 20px;">
    <h3><i class="fas fa-rocket"></i> Quick Actions</h3>
    <p>Use the navigation menu to manage records. End of semester? Go to Students tab to promote batches.</p>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search Faculty..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-secondary" onclick="clearFacultyFilters()">Reset</button>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search Student..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
        
        <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote Batch </button>
        
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
    <p style="margin-bottom:20px;">Manage passwords and email recovery settings.</p>
    <table class="sec-table">
        <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
        <tbody id="credentialList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3> Promote Batch</h3>
        <p style="color:var(--text-muted); font-size:13px;">Automatically move all students from one semester to the next.</p>
        
        <label>Department</label>
        <select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        
        <label>Current Semester</label>
        <select id="promSem">
            <option value="1">Sem 1 -> Sem 2</option>
            <option value="2">Sem 2 -> Sem 3</option>
            <option value="3">Sem 3 -> Sem 4</option>
            <option value="4">Sem 4 -> Sem 5</option>
            <option value="5">Sem 5 -> Sem 6</option>
            <option value="6">Sem 6 -> Sem 7</option>
            <option value="7">Sem 7 -> Sem 8</option>
            <option value="8">Sem 8 -> Alumni</option>
        </select>
        
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="promoteStudents()">Start Promotion</button>
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <label>Email (For OTP)</label><input type="email" id="editUserEmail">
        <label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current">
        <div class="modal-btns"><button class="btn btn-primary" onclick="saveUserCredentials()">Update</button><button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName"><select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <input id="editFEmail">
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No (Locked)</label><input type="text" id="editSRoll" disabled style="opacity:0.7">
    <label>Email</label><input type="text" id="editSEmail">
    <label>Sem</label><select id="editSSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload</h3>
        <p style="font-size:12px; margin-bottom:10px;">CSV Format: Name, RollNo, [Email]</p>
        <select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <select id="csvSem"><option value="1">Sem 1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Name"><select id="fDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select><input id="fEmail" placeholder="Email">
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>
<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input id="sName" placeholder="Name"><input id="sRoll" placeholder="Roll No"><input id="sEmail" placeholder="Email">
    <select id="sSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>
<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Class</h3>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveClassAllocation()">Assign</button><button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
// --- GLOBAL & THEME ---
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
// Load Theme
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

async function loadDashboard() {
  const s = await fetch("http://localhost:5000/students").then(r => r.json());
  const f = await fetch("http://localhost:5000/faculty").then(r => r.json());
  document.getElementById("totalStudents").innerText = s.length;
  document.getElementById("totalFaculty").innerText = f.length;
  document.getElementById("unassignedStudents").innerText = s.filter(i => !i.proctorId).length;
}

// --- FACULTY ---
let allFaculty = [], allStudents = [], currentEditFacultyId = null;
async function loadFaculty() {
  const [f, s] = await Promise.all([fetch("http://localhost:5000/faculty"), fetch("http://localhost:5000/students")]);
  allFaculty = await f.json(); allStudents = await s.json();
  renderFaculty();
}
function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const list = document.getElementById("facultyList"); list.innerHTML = "";
  
  allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept)).forEach(f => {
      // WhatsApp Data
      const myStudents = allStudents.filter(s => s.proctorId === f._id);
      let listStr = ""; myStudents.forEach((s, i) => listStr += `${i+1}. ${s.name} (${s.rollNo})\n`);
      const wa = `https://wa.me/?text=Hello ${f.name}, Students:%0A${encodeURIComponent(listStr)}`;
      const mail = `mailto:?subject=Students&body=${encodeURIComponent(listStr)}`;
      
      let roles = [];
      if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
      if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
      if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);
      if(roles.length === 0) roles.push('<span class="status-pill status-faculty">Faculty</span>');

      list.innerHTML += `<tr><td><b>${f.name}</b></td><td>${f.dept}</td><td>${roles.join(" ")}</td>
      <td><a href="${wa}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366"></i></a><a href="${mail}"><i class="fas fa-envelope notify-icon"></i></a></td>
      <td><button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
  });
}
function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name;
    document.getElementById("editFDept").value = f.dept;
    document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFRoleHOD").checked = f.roles?.hod;
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator;
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}
async function updateFaculty() {
    const name = document.getElementById("editFName").value;
    const dept = document.getElementById("editFDept").value;
    const email = document.getElementById("editFEmail").value;
    const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
    await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name,dept,email,roles}) });
    document.getElementById("editFacultyModal").style.display = "none"; loadFaculty();
}

// --- STUDENTS ---
let currentEditStudentId = null;
async function loadStudents() {
  allStudents = await fetch("http://localhost:5000/students").then(r => r.json());
  renderStudents();
}
function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); list.innerHTML = "";
    
    allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem)).forEach(s => {
        list.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td><span class="status-pill status-student">${s.status}</span></td>
        <td><button class="btn btn-sm btn-primary" onclick="openEditStudentModal('${s._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
    });
}
function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id); if(!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept;
    document.getElementById("editStudentModal").style.display = "flex";
}
async function updateStudent() {
    const name = document.getElementById("editSName").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const email = document.getElementById("editSEmail").value;
    await fetch(`http://localhost:5000/students/${currentEditStudentId}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name,sem,dept,email}) });
    document.getElementById("editStudentModal").style.display = "none"; loadStudents();
}

// --- PROMOTION ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value;
    const fromSem = document.getElementById("promSem").value;
    if(confirm(`Are you sure you want to promote ${dept} Sem ${fromSem}?`)) {
        const res = await fetch("http://localhost:5000/students/promote", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dept, fromSem })
        });
        const data = await res.json();
        alert(data.message);
        closePromoteModal(); loadStudents();
    }
}

// --- CSV ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value; const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select File");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], start = rows[0].toLowerCase().includes('name') ? 1 : 0;
        for(let i=start; i<rows.length; i++) {
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = isNaN(c[0]) ? c[0] : c[1];
                let roll = isNaN(c[0]) ? c[1] : c[0];
                let email = (c[2] && c[2].includes('@')) ? c[2] : `${roll}@student.edu`;
                if(name && roll) data.push({ name: name.trim(), rollNo: roll.trim(), email: email.trim(), sem, dept, status:'Enrolled' });
            }
        }
        if(confirm(`Upload ${data.length} students?`)) {
            await fetch("http://localhost:5000/students/bulk", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data) });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- SECURITY ---
let currentEditUserId = null;
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.email||'-'}</td><td><span class="status-pill status-${u.role}">${u.role}</span></td><td>${u.role==='admin'?'***':u.password}</td><td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td></tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value;
    const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch("http://localhost:5000/admin/update-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- ALLOCATION ---
async function loadAllocations() {
    loadFaculty();
    const s = await fetch("http://localhost:5000/students").then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:#4f46e5; font-weight:bold">${pname}</td><td>${g.d}</td><td>Sem ${g.s}</td><td><span class="status-pill status-proctor">${g.c} Students</span></td><td><button class="btn btn-sm btn-secondary" onclick="unassign('${g.d}', '${g.s}')">Remove</button></td></tr>`;
    });
}
async function unassign(d, s) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}

// --- HELPERS ---
function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display="none"; }
async function saveFaculty() {
    const n=document.getElementById("fName").value; const d=document.getElementById("fDept").value; const e=document.getElementById("fEmail").value;
    const r = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
    await fetch("http://localhost:5000/faculty", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, dept:d, email:e, roles:r}) });
    closeFacultyModal(); loadFaculty();
}
function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n=document.getElementById("sName").value; const r=document.getElementById("sRoll").value; const e=document.getElementById("sEmail").value;
    const s=document.getElementById("sSem").value; const d=document.getElementById("sDept").value;
    await fetch("http://localhost:5000/students", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, rollNo:r, email:e, sem:s, dept:d}) });
    closeStudentModal(); loadStudents();
}
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->




<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: flex; justify-content: center; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* DASHBOARD CARDS (CLICKABLE) */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
    .card::after { content: 'Click for details '; position: absolute; bottom: 10px; right: 15px; font-size: 11px; opacity: 0; transition: 0.2s; color: var(--primary); }
    .card:hover::after { opacity: 1; }
    
    .card p { color: var(--text-muted); font-size: 14px; margin-bottom: 5px; }
    .card h2 { font-size: 28px; margin: 0; color: var(--primary); }

    /* TABLES & FORMS */
    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } .status-student { background: #dcfce7; color: #15803d; }
    .status-faculty { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
    .status-hod { background: #ffedd5; color: #9a3412; } .status-coord { background: #fef9c3; color: #854d0e; } .status-proctor { background: #d1fae5; color: #065f46; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; margin-left: 5px; }

    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 450px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
    .modal-btns { margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    
    .notify-icon { font-size: 18px; margin-right: 8px; color: var(--text-muted); cursor: pointer; }
    .notify-icon:hover { color: var(--primary); transform: scale(1.2); }
    
    /* CHECKBOX FIX */
    .modal-content input[type="checkbox"] { width: auto !important; margin-right: 10px; transform: scale(1.2); }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 8px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>

  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>

  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

<div id="dashboard" class="section active-section">
  <h1>System Overview</h1>
  <div class="stats-grid">
    <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
        <p>Total Students</p><h2 id="totalStudents">0</h2>
    </div>
    <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
        <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
    </div>
    <div class="card" onclick="openActionModal()">
        <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
    </div>
    <div class="card" onclick="openActionModal()">
        <p>Pending Actions</p><h2 id="actionCount">Check</h2>
    </div>
  </div>
</div>

<div id="faculty" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Faculty Directory</h2>
      <div class="header-actions">
        <input type="text" id="facultySearch" placeholder="Search..." onkeyup="renderFaculty()">
        <select id="facultyFilterDept" onchange="renderFaculty()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
      <tbody id="facultyList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="students" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Student Enrollment</h2>
      <div class="header-actions">
        <input type="text" id="studentSearch" placeholder="Search..." onkeyup="renderStudents()">
        <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
        <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote Batch </button>
        <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> CSV </button>
        <button class="btn btn-primary" onclick="openStudentModal()">+ Add</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="studentList"><tr><td colspan="6">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="allocations" class="section">
  <div class="card">
    <div class="card-header">
      <h2>Proctor Allocations</h2>
      <div class="header-actions">
        <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
        <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Assigned Students</th><th>Actions</th></tr></thead>
      <tbody id="allocationList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div id="security" class="section">
  <div class="card">
    <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
    <table class="sec-table">
        <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
        <tbody id="credentialList"><tr><td colspan="5">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3> Action Required</h3>
        <p style="color: #6b7280; margin-bottom:15px;">The following students do not have a proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid #e5e7eb; padding:10px; margin-bottom:15px; border-radius:8px;">
            </div>
        <p style="font-size:12px; color:#6b7280;">Go to <b>Allocations</b> tab to assign classes.</p>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3> Promote Batch</h3>
        <p style="font-size:13px; color:#6b7280;">Automatically move students to next semester.</p>
        <label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <label>Current Sem</label>
        <select id="promSem">
            <option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option>
            <option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option>
            <option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option>
        </select>
        <div class="modal-btns"><button class="btn btn-primary" onclick="promoteStudents()">Promote</button><button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <label>Email</label><input type="email" id="editUserEmail">
        <label>Password</label><input type="text" id="editUserPwd" placeholder="New Password">
        <div class="modal-btns"><button class="btn btn-primary" onclick="saveUserCredentials()">Update</button><button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3>Edit Faculty</h3>
    <input id="editFName"><select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select><input id="editFEmail">
    <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateFaculty()">Update</button><button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="editStudentModal">
  <div class="modal-content">
    <h3>Edit Student</h3>
    <label>Name</label><input type="text" id="editSName">
    <label>Roll No</label><input type="text" id="editSRoll" disabled style="opacity:0.7">
    <label>Email</label><input type="text" id="editSEmail">
    <label>Sem</label><select id="editSSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <label>Dept</label><select id="editSDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="updateStudent()">Update</button><button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button></div>
  </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3>Bulk Upload</h3>
        <select id="csvDept"><option value="" disabled selected>Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        <select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        <input type="file" id="csvFile">
        <div class="modal-btns"><button class="btn btn-primary" onclick="processCSVUpload()">Upload</button><button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3>Add Faculty</h3>
    <input id="fName" placeholder="Name"><select id="fDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select><input id="fEmail" placeholder="Email">
    <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
    <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveFaculty()">Save</button><button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button></div>
  </div>
</div>
<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3>Add Student</h3>
    <input id="sName" placeholder="Name"><input id="sRoll" placeholder="Roll No"><input id="sEmail" placeholder="Email">
    <select id="sSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveStudent()">Save</button><button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button></div>
  </div>
</div>
<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>Assign Class</h3>
    <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    <select id="allocFaculty"></select>
    <div class="modal-btns"><button class="btn btn-primary" onclick="saveClassAllocation()">Assign</button><button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button></div>
  </div>
</div>

<script>
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  if(btn) btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

// --- ACTION ITEM LOGIC ---
let unassignedStudentsList = [];
function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = "";
    if(unassignedStudentsList.length === 0) {
        listDiv.innerHTML = "<p>All students are assigned! </p>";
    } else {
        unassignedStudentsList.forEach(s => {
            listDiv.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
        });
    }
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

async function loadDashboard() {
  const s = await fetch("http://localhost:5000/students").then(r => r.json());
  const f = await fetch("http://localhost:5000/faculty").then(r => r.json());
  
  unassignedStudentsList = s.filter(i => !i.proctorId); // Store for modal
  
  document.getElementById("totalStudents").innerText = s.length;
  document.getElementById("totalFaculty").innerText = f.length;
  document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

// --- FACULTY ---
let allFaculty = [], allStudents = [], currentEditFacultyId = null;
async function loadFaculty() {
  const [f, s] = await Promise.all([fetch("http://localhost:5000/faculty"), fetch("http://localhost:5000/students")]);
  allFaculty = await f.json(); allStudents = await s.json();
  renderFaculty();
}
function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const list = document.getElementById("facultyList"); list.innerHTML = "";
  
  allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept)).forEach(f => {
      const myStudents = allStudents.filter(s => s.proctorId === f._id);
      let listStr = ""; myStudents.forEach((s, i) => listStr += `${i+1}. ${s.name} (${s.rollNo})\n`);
      const wa = `https://wa.me/?text=Hello ${f.name}, Students:%0A${encodeURIComponent(listStr)}`;
      const mail = `mailto:?subject=Students&body=${encodeURIComponent(listStr)}`;
      
      let roles = [];
      if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
      if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
      if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);
      if(roles.length === 0) roles.push('<span class="status-pill status-faculty">Faculty</span>');

      list.innerHTML += `<tr><td><b>${f.name}</b></td><td>${f.dept}</td><td>${roles.join(" ")}</td>
      <td><a href="${wa}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366"></i></a><a href="${mail}"><i class="fas fa-envelope notify-icon"></i></a></td>
      <td><button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
  });
}
function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name;
    document.getElementById("editFDept").value = f.dept;
    document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFRoleHOD").checked = f.roles?.hod;
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator;
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}
async function updateFaculty() {
    const name = document.getElementById("editFName").value;
    const dept = document.getElementById("editFDept").value;
    const email = document.getElementById("editFEmail").value;
    const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
    await fetch(`http://localhost:5000/faculty/${currentEditFacultyId}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name,dept,email,roles}) });
    document.getElementById("editFacultyModal").style.display = "none"; loadFaculty();
}

// --- STUDENTS ---
let currentEditStudentId = null;
async function loadStudents() {
  allStudents = await fetch("http://localhost:5000/students").then(r => r.json());
  renderStudents();
}
function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); list.innerHTML = "";
    
    allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem)).forEach(s => {
        list.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td><span class="status-pill status-student">${s.status}</span></td>
        <td><button class="btn btn-sm btn-primary" onclick="openEditStudentModal('${s._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
    });
}
function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id); if(!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name; document.getElementById("editSRoll").value = s.rollNo; document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSSem").value = s.sem; document.getElementById("editSDept").value = s.dept;
    document.getElementById("editStudentModal").style.display = "flex";
}
async function updateStudent() {
    const name = document.getElementById("editSName").value; const sem = document.getElementById("editSSem").value; const dept = document.getElementById("editSDept").value; const email = document.getElementById("editSEmail").value;
    await fetch(`http://localhost:5000/students/${currentEditStudentId}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name,sem,dept,email}) });
    document.getElementById("editStudentModal").style.display = "none"; loadStudents();
}

// --- PROMOTION ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value;
    const fromSem = document.getElementById("promSem").value;
    if(confirm(`Are you sure you want to promote ${dept} Sem ${fromSem}?`)) {
        const res = await fetch("http://localhost:5000/students/promote", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dept, fromSem })
        });
        const data = await res.json();
        alert(data.message);
        closePromoteModal(); loadStudents();
    }
}

// --- CSV ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value; const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select File");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], start = rows[0].toLowerCase().includes('name') ? 1 : 0;
        for(let i=start; i<rows.length; i++) {
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = isNaN(c[0]) ? c[0] : c[1];
                let roll = isNaN(c[0]) ? c[1] : c[0];
                let email = (c[2] && c[2].includes('@')) ? c[2] : `${roll}@student.edu`;
                if(name && roll) data.push({ name: name.trim(), rollNo: roll.trim(), email: email.trim(), sem, dept, status:'Enrolled' });
            }
        }
        if(confirm(`Upload ${data.length} students?`)) {
            await fetch("http://localhost:5000/students/bulk", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data) });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- SECURITY ---
let currentEditUserId = null;
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.email||'-'}</td><td><span class="status-pill status-${u.role}">${u.role}</span></td><td>${u.role==='admin'?'***':u.password}</td><td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td></tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value;
    const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch("http://localhost:5000/admin/update-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- ALLOCATION ---
async function loadAllocations() {
    loadFaculty();
    const s = await fetch("http://localhost:5000/students").then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:#4f46e5; font-weight:bold">${pname}</td><td>${g.d}</td><td>Sem ${g.s}</td><td><span class="status-pill status-proctor">${g.c} Students</span></td><td><button class="btn btn-sm btn-secondary" onclick="unassign('${g.d}', '${g.s}')">Remove</button></td></tr>`;
    });
}
async function unassign(d, s) { if(confirm("Remove?")) { await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch("http://localhost:5000/allocate/class", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}

// --- HELPERS ---
function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display="none"; }
async function saveFaculty() {
    const n=document.getElementById("fName").value; const d=document.getElementById("fDept").value; const e=document.getElementById("fEmail").value;
    const r = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
    await fetch("http://localhost:5000/faculty", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, dept:d, email:e, roles:r}) });
    closeFacultyModal(); loadFaculty();
}
function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n=document.getElementById("sName").value; const r=document.getElementById("sRoll").value; const e=document.getElementById("sEmail").value;
    const s=document.getElementById("sSem").value; const d=document.getElementById("sDept").value;
    await fetch("http://localhost:5000/students", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, rollNo:r, email:e, sem:s, dept:d}) });
    closeStudentModal(); loadStudents();
}
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`http://localhost:5000/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM - FIXED CONGESTION */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { 
        background: var(--card-bg); 
        padding: 30px; 
        border-radius: 16px; 
        width: 480px; 
        max-height: 90vh; 
        overflow-y: auto; 
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
        border: 1px solid var(--border-color); 
    }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { 
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
        background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px;
    }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    
    .notify-icon { font-size: 18px; margin-right: 8px; cursor: pointer; transition: 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody id="facultyList"></tbody>
        </table>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="studentList"></tbody>
        </table>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class to Proctor</button>
          </div>
        <table>
          <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
          <tbody id="allocationList"></tbody>
        </table>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <table>
            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
            <tbody id="credentialList"></tbody>
        </table>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
  <div class="modal-content">
    <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
    <div class="form-group">
        <label>Full Name</label>
        <input id="fName" placeholder="Enter name">
    </div>
    <div class="form-group">
        <label>Department</label>
        <select id="fDept">
            <option value="CE">CE</option><option value="IT">IT</option>
            <option value="CSBS">CSBS</option><option value="AI">AI</option>
        </select>
    </div>
    <div class="form-group">
        <label>Email Address</label>
        <input id="fEmail" placeholder="email@institution.edu">
    </div>
    <label>System Roles</label>
    <div class="checkbox-grid">
        <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
        <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
        <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
    </div>
    <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
    </div>
  </div>
</div>

<div class="modal" id="editFacultyModal">
  <div class="modal-content">
    <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
    <div class="form-group"><label>Name</label><input id="editFName"></div>
    <div class="form-group">
        <label>Dept</label>
        <select id="editFDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    </div>
    <div class="form-group"><label>Email</label><input id="editFEmail"></div>
    <div class="checkbox-grid">
        <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
        <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
        <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
    </div>
    <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
        <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
    </div>
  </div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <h3><i class="fas fa-user-plus"></i> Add Student</h3>
    <div class="form-group"><label>Full Name</label><input id="sName"></div>
    <div class="form-group"><label>Roll Number</label><input id="sRoll"></div>
    <div class="form-group"><label>Email</label><input id="sEmail"></div>
    <div class="form-group">
        <label>Semester</label>
        <select id="sSem">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
        </select>
    </div>
    <div class="form-group">
        <label>Department</label>
        <select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    </div>
    <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
    </div>
  </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <h3><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
        <div class="form-group">
            <label>Department</label>
            <select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        </div>
        <div class="form-group">
            <label>Semester</label>
            <select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
        </div>
        <div class="form-group">
            <label>Select CSV File</label>
            <input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3><i class="fas fa-link"></i> Assign Class to Proctor</h3>
    <div class="form-group">
        <label>Department</label>
        <select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
    </div>
    <div class="form-group">
        <label>Semester</label>
        <select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select>
    </div>
    <div class="form-group">
        <label>Select Proctor</label>
        <select id="allocFaculty"></select>
    </div>
    <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
    </div>
  </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3> Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns"><button class="btn btn-primary" onclick="saveUserCredentials()">Update</button><button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button></div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3> Promote Batch</h3>
        <div class="form-group">
            <label>Dept</label>
            <select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select>
        </div>
        <div class="form-group">
            <label>Promotion Step</label>
            <select id="promSem">
                <option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option>
                <option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option>
                <option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option>
            </select>
        </div>
        <div class="modal-btns"><button class="btn btn-primary" onclick="promoteStudents()">Promote</button><button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button></div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
  document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active-section");
  if(btn) btn.classList.add("active");
  if (id === "dashboard") loadDashboard();
  if (id === "faculty") loadFaculty();
  if (id === "students") loadStudents();
  if (id === "allocations") loadAllocations();
  if (id === "security") loadCredentials();
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
  const s = await fetch(`${API_URL}/students`).then(r => r.json());
  const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
  unassignedStudentsList = s.filter(i => !i.proctorId);
  document.getElementById("totalStudents").innerText = s.length;
  document.getElementById("totalFaculty").innerText = f.length;
  document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! </p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid #eee; padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [], currentEditFacultyId = null;
async function loadFaculty() {
  const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
  allFaculty = await f.json(); allStudents = await s.json();
  renderFaculty();
}

function renderFaculty() {
  const search = document.getElementById("facultySearch").value.toLowerCase();
  const dept = document.getElementById("facultyFilterDept").value;
  const list = document.getElementById("facultyList"); list.innerHTML = "";
  
  allFaculty.filter(f => f.name.toLowerCase().includes(search) && (dept === "all" || f.dept === dept)).forEach(f => {
      const myStudents = allStudents.filter(s => s.proctorId === f._id);
      let listStr = ""; myStudents.forEach((s, i) => listStr += `${i+1}. ${s.name} (${s.rollNo})\n`);
      const wa = `https://wa.me/?text=Hello ${f.name}, Students:%0A${encodeURIComponent(listStr)}`;
      const mail = `mailto:?subject=Students&body=${encodeURIComponent(listStr)}`;
      
      let roles = [];
      if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
      if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
      if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);
      if(roles.length === 0) roles.push('<span class="status-pill status-faculty">Faculty</span>');

      list.innerHTML += `<tr><td><b>${f.name}</b></td><td>${f.dept}</td><td>${roles.join(" ")}</td>
      <td><a href="${wa}" target="_blank"><i class="fab fa-whatsapp notify-icon" style="color:#25D366"></i></a><a href="${mail}"><i class="fas fa-envelope notify-icon" style="color:#4f46e5"></i></a></td>
      <td><button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
  });
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { document.getElementById("facultyModal").style.display="none"; }
async function saveFaculty() {
    const n=document.getElementById("fName").value; const d=document.getElementById("fDept").value; const e=document.getElementById("fEmail").value;
    const r = { hod: document.getElementById("fRoleHOD").checked, coordinator: document.getElementById("fRoleCoord").checked, proctor: document.getElementById("fRoleProctor").checked };
    await fetch(`${API_URL}/faculty`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, dept:d, email:e, roles:r}) });
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; document.getElementById("editFDept").value = f.dept; document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFRoleHOD").checked = f.roles?.hod; document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}
function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }
async function updateFaculty() {
    const name = document.getElementById("editFName").value; const dept = document.getElementById("editFDept").value; const email = document.getElementById("editFEmail").value;
    const roles = { hod: document.getElementById("editFRoleHOD").checked, coordinator: document.getElementById("editFRoleCoord").checked, proctor: document.getElementById("editFRoleProctor").checked };
    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name,dept,email,roles}) });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS ---
let currentEditStudentId = null;
async function loadStudents() {
  allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
  renderStudents();
}
function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); list.innerHTML = "";
    allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem)).forEach(s => {
        list.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td><span class="status-pill status-student">${s.status}</span></td>
        <td><button class="btn btn-sm btn-primary" onclick="openEditStudentModal('${s._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n=document.getElementById("sName").value; const r=document.getElementById("sRoll").value; const e=document.getElementById("sEmail").value;
    const s=document.getElementById("sSem").value; const d=document.getElementById("sDept").value;
    await fetch(`${API_URL}/students`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, rollNo:r, email:e, sem:s, dept:d}) });
    closeStudentModal(); loadStudents();
}

// --- PROMOTION ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; const fromSem = document.getElementById("promSem").value;
    if(confirm(`Promote ${dept} Sem ${fromSem}?`)) {
        const res = await fetch(`${API_URL}/students/promote`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, fromSem }) });
        const data = await res.json(); alert(data.message); closePromoteModal(); loadStudents();
    }
}

// --- CSV ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value; const file = document.getElementById("csvFile").files[0];
    if(!file || !dept) return alert("Select Dept and File");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], start = rows[0].toLowerCase().includes('name') ? 1 : 0;
        for(let i=start; i<rows.length; i++) {
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = isNaN(c[0]) ? c[0] : c[1];
                let roll = isNaN(c[0]) ? c[1] : c[0];
                let email = (c[2] && c[2].includes('@')) ? c[2] : `${roll.trim()}@student.edu`;
                if(name && roll) data.push({ name: name.trim(), rollNo: roll.trim(), email: email.trim(), sem, dept, status:'Enrolled' });
            }
        }
        if(confirm(`Upload ${data.length} students?`)) {
            await fetch(`${API_URL}/students/bulk`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data) });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold">${pname}</td><td>${g.d}</td><td>Sem ${g.s}</td><td><span class="status-pill status-proctor">${g.c} Students</span></td><td><button class="btn btn-sm btn-secondary" onclick="unassign('${g.d}', '${g.s}')">Remove</button></td></tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

// --- SECURITY ---
async function loadCredentials() {
    const users = await fetch(`${API_URL}/users`).then(r => r.json());
    const list = document.getElementById("credentialList"); list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.email||'-'}</td><td><span class="status-pill status-${u.role}">${u.role}</span></td><td>${u.role==='admin'?'***':u.password}</td><td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td></tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html>
