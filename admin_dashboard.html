




<!--my REfined-->

<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    
    .notify-icon { font-size: 18px; margin-right: 8px; cursor: pointer; transition: 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody id="facultyList"></tbody>
        </table>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Roll No</th><th>Sem</th><th>Dept</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="studentList"></tbody>
        </table>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
        <table>
          <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
          <tbody id="allocationList"></tbody>
        </table>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <table>
            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
            <tbody id="credentialList"></tbody>
        </table>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>
<div class="modal" id="studentModal"><div class="modal-content"><h3><i class="fas fa-user-plus"></i> Add Student</h3><div class="form-group"><label>Full Name</label><input id="sName"></div><div class="form-group"><label>Roll Number</label><input id="sRoll"></div><div class="form-group"><label>Email</label><input id="sEmail"></div><div class="form-group"><label>Semester</label><select id="sSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div><div class="form-group"><label>Department</label><select id="sDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div><div class="modal-btns"><button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button><button class="btn btn-primary" onclick="saveStudent()">Register Student</button></div></div></div>
<div class="modal" id="csvModal"><div class="modal-content"><h3><i class="fas fa-file-csv"></i> Bulk Student Upload</h3><div class="form-group"><label>Department</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div><div class="form-group"><label>Semester</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div><div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div><div class="modal-btns"><button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button><button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button></div></div></div>
<div class="modal" id="allocationModal"><div class="modal-content"><h3><i class="fas fa-link"></i> Assign Class to Proctor</h3><div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div><div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div><div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div><div class="modal-btns"><button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button><button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button></div></div></div>
<div class="modal" id="actionModal"><div class="modal-content"><h3>‚ö†Ô∏è Action Required</h3><p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p><div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div><div class="modal-btns"><button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button><button class="btn btn-secondary" onclick="closeActionModal()">Close</button></div></div></div>
<div class="modal" id="userEditModal"><div class="modal-content"><h3>Update User</h3><p>User: <b id="editUserTitle"></b></p><div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div><div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div><div class="modal-btns"><button class="btn btn-primary" onclick="saveUserCredentials()">Update</button><button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button></div></div></div>
<div class="modal" id="promoteModal"><div class="modal-content"><h3>üöÄ Promote Batch</h3><div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div><div class="form-group"><label>Promotion Step</label><select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select></div><div class="modal-btns"><button class="btn btn-primary" onclick="promoteStudents()">Promote</button><button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button></div></div></div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "security") loadCredentials();
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid #eee; padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
//---change kiya ---
let allFaculty = [], allStudents = [], currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>${f.email || '-'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> 
                <button class="btn btn-sm btn-secondary" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, roles:r}) 
    });
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS ---
let currentEditStudentId = null;
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}
function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); list.innerHTML = "";
    allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem)).forEach(s => {
        list.innerHTML += `<tr><td>${s.name}</td><td>${s.rollNo}</td><td>${s.sem}</td><td>${s.dept}</td><td><span class="status-pill status-student">${s.status}</span></td>
        <td><button class="btn btn-sm btn-primary" onclick="openEditStudentModal('${s._id}')">Edit</button> <button class="btn btn-sm btn-secondary" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n=document.getElementById("sName").value; const r=document.getElementById("sRoll").value; const e=document.getElementById("sEmail").value;
    const s=document.getElementById("sSem").value; const d=document.getElementById("sDept").value;
    await fetch(`${API_URL}/students`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:n, rollNo:r, email:e, sem:s, dept:d}) });
    closeStudentModal(); loadStudents();
}

// --- PROMOTION ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; const fromSem = document.getElementById("promSem").value;
    if(confirm(`Promote ${dept} Sem ${fromSem}?`)) {
        const res = await fetch(`${API_URL}/students/promote`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dept, fromSem }) });
        const data = await res.json(); alert(data.message); closePromoteModal(); loadStudents();
    }
}

// --- CSV ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }
function processCSVUpload() {
    const dept = document.getElementById("csvDept").value; const sem = document.getElementById("csvSem").value; const file = document.getElementById("csvFile").files[0];
    if(!file || !dept) return alert("Select Dept and File");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], start = rows[0].toLowerCase().includes('name') ? 1 : 0;
        for(let i=start; i<rows.length; i++) {
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = isNaN(c[0]) ? c[0] : c[1];
                let roll = isNaN(c[0]) ? c[1] : c[0];
                let email = (c[2] && c[2].includes('@')) ? c[2] : `${roll.trim()}@student.edu`;
                if(name && roll) data.push({ name: name.trim(), rollNo: roll.trim(), email: email.trim(), sem, dept, status:'Enrolled' });
            }
        }
        if(confirm(`Upload ${data.length} students?`)) {
            await fetch(`${API_URL}/students/bulk`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data) });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold">${pname}</td><td>${g.d}</td><td>Sem ${g.s}</td><td><span class="status-pill status-proctor">${g.c} Students</span></td><td><button class="btn btn-sm btn-secondary" onclick="unassign('${g.d}', '${g.s}')">Remove</button></td></tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); 
        loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

// --- ‚≠ê NEW: PRINT FUNCTIONALITY ‚≠ê ---
async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    
    // Sort students by Dept -> Sem -> Roll
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    
    let html = `
    <html>
    <head>
        <title>Class Lists - EduAchieve</title>
        <style>
            body { font-family: 'Segoe UI', sans-serif; padding: 20px; }
            .class-header { background: #1e293b; color: white; padding: 10px; font-size: 18px; font-weight: bold; margin-top: 20px; border-radius: 6px 6px 0 0; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
            th { background-color: #f3f4f6; font-weight: bold; }
            .page-break { page-break-before: always; }
            .footer { text-align: center; font-size: 12px; color: #666; margin-top: 10px; }
        </style>
    </head>
    <body>
        <h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>
    `;

    // Group by Class (Dept + Sem)
    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `
                <div class="class-header">${studentClass}</div>
                <table>
                    <thead>
                        <tr>
                            <th width="15%">Roll No</th>
                            <th width="45%">Student Name</th>
                            <th width="40%">Assigned Proctor</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            currentClass = studentClass;
            isFirst = false;
        }

        html += `
            <tr>
                <td><b>${s.rollNo}</b></td>
                <td>${s.name}</td>
                <td>${proctorName}</td>
            </tr>
        `;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
}

// --- SECURITY ---
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    
    users.forEach(u => {
        list.innerHTML += `
        <tr>
            <td><b>${u.username}</b></td>
            <td>${u.email || '-'}</td>
            <td><span class="status-pill status-${u.role}">${u.role}</span></td>
            <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
            <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
        </tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->







<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    
    .notify-icon { font-size: 18px; margin-right: 8px; cursor: pointer; transition: 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('achievements', this)"> <i class="fas fa-trophy"></i> Achievements </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody id="facultyList"></tbody>
        </table>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Roll No</th><th>Sem & Dept</th><th>Contact Info</th><th>Actions</th></tr></thead>
          <tbody id="studentList"></tbody>
        </table>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
        <table>
          <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
          <tbody id="allocationList"></tbody>
        </table>
      </div>
    </div>

    <div id="achievements" class="section">
      <div class="card">
        <h2>Global Achievement Tracking</h2>
        <div class="header-actions">
            <input type="text" id="achSearch" placeholder="Search Title, Name, Roll No..." onkeyup="renderAdminAchievements()" style="width: 300px;">
            <button class="btn" style="background-color: #10b981; color: white;" onclick="generateGlobalReport()"><i class="fas fa-file-excel"></i> Export All</button>
        </div>
        <table>
          <thead><tr><th>Student</th><th>Title</th><th>Category</th><th>Date</th><th>Status</th></tr></thead>
          <tbody id="adminAchList"></tbody>
        </table>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <table>
            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
            <tbody id="credentialList"></tbody>
        </table>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add Student</h3>
        <div class="form-group"><label>Full Name</label><input id="sName"></div>
        <div class="form-group"><label>Roll Number</label><input id="sRoll"></div>
        <div class="form-group"><label>Email</label><input id="sEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="sMobile"></div> <div class="form-group"><label>Semester</label>
            <select id="sSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="sDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;"><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template</button>
        </div>
        <div class="form-group"><label>Department (Fallback)</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester (Fallback)</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> Assign Class to Proctor</h3>
        <div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
        </div>
    </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3>üöÄ Promote Batch</h3>
        <div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Promotion Step</label>
            <select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select>
        </div>
        <div class="form-group">
            <label>Detained Students (Stay in Current Sem)</label>
            <input type="text" id="promDetained" placeholder="Comma separated Roll Nos (e.g. CS01, CS02)">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="promoteStudents()">Promote Batch</button>
        </div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "achievements") loadAdminAchievements();
    if (id === "security") loadCredentials();
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid var(--border-color); padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [], currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>${f.email || '-'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> 
                <button class="btn btn-sm btn-secondary" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, roles:r}) 
    });
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS ---
let currentEditStudentId = null;
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}
function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); list.innerHTML = "";
    allStudents.filter(s => (s.name.toLowerCase().includes(search) || s.rollNo.includes(search)) && (dept === "all" || s.dept === dept) && (sem === "all" || String(s.sem) === sem)).forEach(s => {
        list.innerHTML += `<tr>
            <td><b>${s.name}</b></td>
            <td>${s.rollNo}</td>
            <td>Sem ${s.sem} <br><small style="color:var(--text-muted)">${s.dept}</small></td>
            <td><small><i class="fas fa-envelope"></i> ${s.email || '-'}<br><i class="fas fa-phone"></i> ${s.mobile || '-'}</small></td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n=document.getElementById("sName").value; 
    const r=document.getElementById("sRoll").value; 
    const e=document.getElementById("sEmail").value;
    const m=document.getElementById("sMobile").value;
    const s=document.getElementById("sSem").value; 
    const d=document.getElementById("sDept").value;
    await fetch(`${API_URL}/students`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, rollNo:r, email:e, mobile:m, sem:s, dept:d}) 
    });
    closeStudentModal(); loadStudents();
}

// --- PROMOTION ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; 
    const fromSem = document.getElementById("promSem").value;
    const detainedStr = document.getElementById("promDetained").value;
    
    // Parse detained string to array
    const detainedRolls = detainedStr.split(",").map(s => s.trim()).filter(s => s !== "");

    let msg = `Promote ${dept} Sem ${fromSem}?`;
    if(detainedRolls.length > 0) msg += `\n\nEXCLUDING DETAINED STUDENTS:\n${detainedRolls.join(", ")}`;

    if(confirm(msg)) {
        const res = await fetch(`${API_URL}/students/promote`, { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ dept, fromSem, detainedRolls }) 
        });
        const data = await res.json(); 
        alert(data.message); 
        closePromoteModal(); 
        loadStudents();
    }
}

// --- CSV BULK UPLOAD ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function downloadTemplate() {
    const csv = "Name,RollNo,Department,Semester,Email,Mobile\nJohn Doe,CS001,CE,3,john@student.edu,9876543210\nJane Smith,CS002,IT,3,jane@student.edu,9123456780";
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Bulk_Upload_Template.csv";
    link.click();
}

function processCSVUpload() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select a CSV File");
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], duplicates = [];
        const start = rows[0].toLowerCase().includes('name') ? 1 : 0; // Skip header
        
        for(let i = start; i < rows.length; i++) {
            if(!rows[i].trim()) continue;
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = c[0].trim();
                let roll = c[1].trim();
                // Map from CSV if available, else use Dropdown Fallbacks
                let dept = c[2] ? c[2].trim() : document.getElementById("csvDept")?.value || "Gen"; 
                let sem = c[3] ? c[3].trim() : document.getElementById("csvSem")?.value || "1";
                let email = (c[4] && c[4].includes('@')) ? c[4].trim() : `${roll}@student.edu`;
                let mobile = c[5] ? c[5].trim() : "";

                // Checking for duplicate before pushing to payload
                if (allStudents.some(s => s.rollNo === roll)) {
                    duplicates.push(roll);
                } else if (name && roll) {
                    data.push({ name, rollNo: roll, email, mobile, sem, dept, status:'Enrolled' });
                }
            }
        }

        if (duplicates.length > 0) {
            alert(`‚ö†Ô∏è The following ${duplicates.length} students already exist and will be skipped:\n${duplicates.join(', ')}`);
        }

        if (data.length === 0) {
            return alert("No new valid students to upload.");
        }

        if(confirm(`Proceed to upload ${data.length} new students?`)) {
            await fetch(`${API_URL}/students/bulk`, { 
                method: "POST", 
                headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify(data) 
            });
            closeCSVModal(); 
            loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr><td style="color:var(--primary); font-weight:bold">${pname}</td><td>${g.d}</td><td>Sem ${g.s}</td><td><span class="status-pill status-proctor">${g.c} Students</span></td><td><button class="btn btn-sm btn-secondary" onclick="unassign('${g.d}', '${g.s}')">Remove</button></td></tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}
function closeAllocationModal() { document.getElementById("allocationModal").style.display="none"; }
async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); 
        loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    let html = `<html><head><title>Class Lists - EduAchieve</title><style>body{font-family:'Segoe UI',sans-serif;padding:20px;}.class-header{background:#1e293b;color:white;padding:10px;font-size:18px;font-weight:bold;margin-top:20px;border-radius:6px 6px 0 0;}table{width:100%;border-collapse:collapse;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:14px;}th{background-color:#f3f4f6;font-weight:bold;}.page-break{page-break-before:always;}.footer{text-align:center;font-size:12px;color:#666;margin-top:10px;}</style></head><body><h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>`;

    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `<div class="class-header">${studentClass}</div><table><thead><tr><th width="15%">Roll No</th><th width="45%">Student Name</th><th width="40%">Assigned Proctor</th></tr></thead><tbody>`;
            currentClass = studentClass;
            isFirst = false;
        }
        html += `<tr><td><b>${s.rollNo}</b></td><td>${s.name}</td><td>${proctorName}</td></tr>`;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;
    printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

// --- NEW: ADMIN ACHIEVEMENT TRACKING ---
let adminAchs = [];
async function loadAdminAchievements() {
    adminAchs = await fetch(`${API_URL}/achievements`).then(r => r.json());
    renderAdminAchievements();
}
function renderAdminAchievements() {
    const search = document.getElementById("achSearch").value.toLowerCase();
    const list = document.getElementById("adminAchList"); list.innerHTML = "";
    
    adminAchs.filter(a => 
        (a.studentName && a.studentName.toLowerCase().includes(search)) || 
        (a.studentRoll && a.studentRoll.toLowerCase().includes(search)) || 
        (a.title && a.title.toLowerCase().includes(search))
    ).forEach(a => {
        list.innerHTML += `
            <tr>
                <td><b>${a.studentName}</b><br><small style="color:var(--text-muted);">${a.studentRoll}</small></td>
                <td>${a.title}</td>
                <td>${a.category}</td>
                <td>${new Date(a.date).toLocaleDateString()}</td>
                <td><span class="status-pill status-${a.status}">${a.status}</span></td>
            </tr>`;
    });
}
function generateGlobalReport() {
    if(adminAchs.length === 0) return alert("No achievements found.");
    let csvContent = "Roll No,Student Name,Title,Category,Date,Status\n";
    adminAchs.forEach(a => {
        csvContent += `${a.studentRoll},${a.studentName},${a.title},${a.category},${new Date(a.date).toLocaleDateString()},${a.status}\n`;
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Global_Achievement_Report.csv";
    link.click();
}

// --- SECURITY ---
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr>
            <td><b>${u.username}</b></td>
            <td>${u.email || '-'}</td>
            <td><span class="status-pill status-${u.role}">${u.role}</span></td>
            <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
            <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
        </tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->





<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* üü© STUDENT SQUARE CARDS (NEW) */
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .student-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; position: relative; transition: 0.2s; }
    .student-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .student-card h4 { margin-bottom: 5px; color: var(--text-main); font-size: 18px; padding-right: 70px; }
    .student-card p { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
    .student-card .actions { margin-top: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 15px; }

    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-danger { background: var(--danger); color: white; }
    
    .notify-icon { font-size: 18px; margin-right: 8px; cursor: pointer; transition: 0.2s; }
    .notify-icon:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('achievements', this)"> <i class="fas fa-trophy"></i> Achievements </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
        <table>
          <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody id="facultyList"></tbody>
        </table>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
          </div>
          
          <div class="student-grid" id="studentListGrid"></div>

      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
        <table>
          <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
          <tbody id="allocationList"></tbody>
        </table>
      </div>
    </div>

    <div id="achievements" class="section">
      <div class="card">
        <h2>Global Achievement Tracking</h2>
        <div class="header-actions">
            <input type="text" id="achSearch" placeholder="Search Title, Name, Roll No..." onkeyup="renderAdminAchievements()" style="width: 300px;">
            <button class="btn" style="background-color: #10b981; color: white;" onclick="generateGlobalReport()"><i class="fas fa-file-excel"></i> Export All</button>
        </div>
        <table>
          <thead><tr><th>Student</th><th>Class & Sem</th><th>Title</th><th>Category</th><th>Date</th><th>Status</th><th>Proof</th></tr></thead>
          <tbody id="adminAchList"></tbody>
        </table>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <table>
            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
            <tbody id="credentialList"></tbody>
        </table>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add Student</h3>
        <div class="form-group"><label>Full Name</label><input id="sName"></div>
        <div class="form-group"><label>Roll Number</label><input id="sRoll"></div>
        <div class="form-group"><label>Email</label><input id="sEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="sMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="sSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="sDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
        </div>
    </div>
</div>

<div class="modal" id="editStudentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-edit"></i> Edit Student</h3>
        <div class="form-group"><label>Full Name</label><input id="editSName"></div>
        <div class="form-group"><label>Roll Number</label><input id="editSRoll"></div>
        <div class="form-group"><label>Email</label><input id="editSEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="editSMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="editSSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="Graduated">Graduated</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="editSDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="form-group"><label>Status</label>
            <select id="editSStatus">
                <option value="Enrolled">Enrolled</option>
                <option value="Alumni">Alumni</option>
                <option value="Detained">Detained</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateStudent()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;"><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template</button>
        </div>
        <div class="form-group"><label>Department (Fallback)</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester (Fallback)</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> Assign/Edit Proctor Class</h3>
        <div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
        </div>
    </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3>üöÄ Promote Batch</h3>
        <div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Promotion Step</label>
            <select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select>
        </div>
        <div class="form-group">
            <label>Detained Students (Stay in Current Sem)</label>
            <input type="text" id="promDetained" placeholder="Comma separated Roll Nos (e.g. CS01, CS02)">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="promoteStudents()">Promote Batch</button>
        </div>
    </div>
</div>

<div id="proofModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="width: 80%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;">Document Preview</h3>
            <button onclick="document.getElementById('proofModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div id="proofBody" style="flex:1; background:#525659; overflow:auto;"></div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "achievements") loadAdminAchievements();
    if (id === "security") loadCredentials();
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid var(--border-color); padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [], currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>${f.email || '-'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> 
                <button class="btn btn-sm btn-danger" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, roles:r}) 
    });
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS (SQUARE CARDS) ---
let currentEditStudentId = null;
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const grid = document.getElementById("studentListGrid"); 
    grid.innerHTML = "";
    
    allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search)) && 
        (dept === "all" || s.dept === dept) && 
        (sem === "all" || String(s.sem) === sem)
    ).forEach(s => {
        let statusColor = s.status === 'Enrolled' ? 'status-student' : 'status-coord';
        if(s.status === 'Alumni') statusColor = 'status-proctor';
        if(s.status === 'Detained') statusColor = 'status-admin';

        grid.innerHTML += `
        <div class="student-card">
            <div>
                <h4>${s.name}</h4>
                <span class="status-pill ${statusColor}" style="position:absolute; top:20px; right:20px;">${s.status}</span>
                <p><b>Roll No:</b> ${s.rollNo}</p>
                <p><b>Class:</b> ${s.dept} | Semester ${s.sem}</p>
                <p><i class="fas fa-envelope"></i> ${s.email || 'N/A'}</p>
                <p><i class="fas fa-phone"></i> ${s.mobile || 'N/A'}</p>
            </div>
            <div class="actions">
                <button class="btn btn-sm btn-primary" style="flex:1; display:flex; justify-content:center;" onclick="openEditStudentModal('${s._id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-danger" style="flex:1; display:flex; justify-content:center;" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i> Delete</button>
            </div>
        </div>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n = document.getElementById("sName").value; 
    const r = document.getElementById("sRoll").value; 
    const e = document.getElementById("sEmail").value;
    const m = document.getElementById("sMobile").value;
    const s = document.getElementById("sSem").value; 
    const d = document.getElementById("sDept").value;
    await fetch(`${API_URL}/students`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, rollNo:r, email:e, mobile:m, sem:s, dept:d}) 
    });
    closeStudentModal(); loadStudents();
}

// üü© EDIT STUDENT FUNCTIONS
function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id);
    if (!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name;
    document.getElementById("editSRoll").value = s.rollNo;
    document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSMobile").value = s.mobile || "";
    document.getElementById("editSSem").value = s.sem;
    document.getElementById("editSDept").value = s.dept;
    document.getElementById("editSStatus").value = s.status || "Enrolled";
    document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; }

async function updateStudent() {
    const payload = {
        name: document.getElementById("editSName").value,
        rollNo: document.getElementById("editSRoll").value,
        email: document.getElementById("editSEmail").value,
        mobile: document.getElementById("editSMobile").value,
        sem: document.getElementById("editSSem").value,
        dept: document.getElementById("editSDept").value,
        status: document.getElementById("editSStatus").value
    };
    await fetch(`${API_URL}/students/${currentEditStudentId}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    closeEditStudentModal();
    loadStudents();
}

// --- PROMOTION ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; 
    const fromSem = document.getElementById("promSem").value;
    const detainedStr = document.getElementById("promDetained").value;
    
    const detainedRolls = detainedStr.split(",").map(s => s.trim()).filter(s => s !== "");

    let msg = `Promote ${dept} Sem ${fromSem}?`;
    if(detainedRolls.length > 0) msg += `\n\nEXCLUDING DETAINED STUDENTS:\n${detainedRolls.join(", ")}`;

    if(confirm(msg)) {
        const res = await fetch(`${API_URL}/students/promote`, { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ dept, fromSem, detainedRolls }) 
        });
        const data = await res.json(); 
        alert(data.message); 
        closePromoteModal(); 
        loadStudents();
    }
}

// --- CSV BULK UPLOAD ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function downloadTemplate() {
    const csv = "Name,RollNo,Department,Semester,Email,Mobile\nJohn Doe,CS001,CE,3,john@student.edu,9876543210\nJane Smith,CS002,IT,3,jane@student.edu,9123456780";
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Bulk_Upload_Template.csv";
    link.click();
}

function processCSVUpload() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select a CSV File");
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], duplicates = [];
        const start = rows[0].toLowerCase().includes('name') ? 1 : 0; 
        
        for(let i = start; i < rows.length; i++) {
            if(!rows[i].trim()) continue;
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = c[0].trim();
                let roll = c[1].trim();
                let dept = c[2] ? c[2].trim() : document.getElementById("csvDept")?.value || "Gen"; 
                let sem = c[3] ? c[3].trim() : document.getElementById("csvSem")?.value || "1";
                let email = (c[4] && c[4].includes('@')) ? c[4].trim() : `${roll}@student.edu`;
                let mobile = c[5] ? c[5].trim() : "";

                if (allStudents.some(s => s.rollNo === roll)) {
                    duplicates.push(roll);
                } else if (name && roll) {
                    data.push({ name, rollNo: roll, email, mobile, sem, dept, status:'Enrolled' });
                }
            }
        }

        if (duplicates.length > 0) {
            alert(`‚ö†Ô∏è The following ${duplicates.length} students already exist and will be skipped:\n${duplicates.join(', ')}`);
        }
        if (data.length === 0) return alert("No new valid students to upload.");

        if(confirm(`Proceed to upload ${data.length} new students?`)) {
            await fetch(`${API_URL}/students/bulk`, { 
                method: "POST", 
                headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify(data) 
            });
            closeCSVModal(); 
            loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr>
            <td style="color:var(--primary); font-weight:bold">${pname}</td>
            <td>${g.d}</td>
            <td>Sem ${g.s}</td>
            <td><span class="status-pill status-proctor">${g.c} Students</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditAllocation('${g.d}', '${g.s}', '${g.pid}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-danger" onclick="unassign('${g.d}', '${g.s}')"><i class="fas fa-trash"></i> Remove</button>
            </td>
        </tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}

// üü© EDIT ALLOCATION FUNCTION
function openEditAllocation(dept, sem, facultyId) {
    document.getElementById("allocDept").value = dept;
    document.getElementById("allocSem").value = sem;
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocFaculty").value = facultyId;
    
    // Disable inputs so user can only change the proctor, not the class definition
    document.getElementById("allocDept").disabled = true;
    document.getElementById("allocSem").disabled = true;
    
    document.getElementById("allocationModal").style.display = "flex";
}

function closeAllocationModal() { 
    document.getElementById("allocationModal").style.display="none"; 
    // Reset disables
    document.getElementById("allocDept").disabled = false;
    document.getElementById("allocSem").disabled = false;
}

async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove Proctor Assignment?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); 
        loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    let html = `<html><head><title>Class Lists - EduAchieve</title><style>body{font-family:'Segoe UI',sans-serif;padding:20px;}.class-header{background:#1e293b;color:white;padding:10px;font-size:18px;font-weight:bold;margin-top:20px;border-radius:6px 6px 0 0;}table{width:100%;border-collapse:collapse;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:14px;}th{background-color:#f3f4f6;font-weight:bold;}.page-break{page-break-before:always;}.footer{text-align:center;font-size:12px;color:#666;margin-top:10px;}</style></head><body><h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>`;

    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `<div class="class-header">${studentClass}</div><table><thead><tr><th width="15%">Roll No</th><th width="45%">Student Name</th><th width="40%">Assigned Proctor</th></tr></thead><tbody>`;
            currentClass = studentClass;
            isFirst = false;
        }
        html += `<tr><td><b>${s.rollNo}</b></td><td>${s.name}</td><td>${proctorName}</td></tr>`;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;
    printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

// --- ADMIN ACHIEVEMENT TRACKING ---
let adminAchs = [];
async function loadAdminAchievements() {
    adminAchs = await fetch(`${API_URL}/achievements`).then(r => r.json());
    if (allStudents.length === 0) {
        allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    }
    renderAdminAchievements();
}

function renderAdminAchievements() {
    const search = document.getElementById("achSearch").value.toLowerCase();
    const list = document.getElementById("adminAchList"); list.innerHTML = "";
    
    adminAchs.filter(a => 
        (a.studentName && a.studentName.toLowerCase().includes(search)) || 
        (a.studentRoll && a.studentRoll.toLowerCase().includes(search)) || 
        (a.title && a.title.toLowerCase().includes(search))
    ).forEach(a => {
        // üü© NEW: Dynamically fetch student's Dept and Sem
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const deptSem = stu ? `${stu.dept} | Sem ${stu.sem}` : `<span style="color:#ef4444;">Unknown</span>`;

        list.innerHTML += `
            <tr>
                <td><b>${a.studentName}</b><br><small style="color:var(--text-muted);">${a.studentRoll}</small></td>
                <td>${deptSem}</td>
                <td>${a.title}</td>
                <td>${a.category}</td>
                <td>${new Date(a.date).toLocaleDateString()}</td>
                <td><span class="status-pill status-${a.status}">${a.status}</span></td>
                <td><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="openProofModal('${a._id}')"><i class="fas fa-eye"></i></button></td>
            </tr>`;
    });
}

function openProofModal(id) {
    const a = adminAchs.find(i => i._id === id);
    const b = document.getElementById('proofBody');
    if(!a.fileData) return alert("No file uploaded.");
    b.innerHTML = a.fileData.includes("pdf") ? `<iframe src="${a.fileData}" width="100%" height="100%" style="border:none;"></iframe>` : `<img src="${a.fileData}" style="max-width:100%; display:block; margin:auto;">`;
    document.getElementById('proofModal').style.display = 'flex';
}

function generateGlobalReport() {
    if(adminAchs.length === 0) return alert("No achievements found.");
    
    // üü© NEW: Added Department and Semester to the CSV Header
    let csvContent = "Roll No,Student Name,Department,Semester,Title,Category,Date,Status\n";
    
    adminAchs.forEach(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const d = stu ? stu.dept : "N/A";
        const sm = stu ? stu.sem : "N/A";

        csvContent += `${a.studentRoll},${a.studentName},${d},${sm},${a.title},${a.category},${new Date(a.date).toLocaleDateString()},${a.status}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Global_Achievement_Report.csv";
    link.click();
}

// --- SECURITY ---
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr>
            <td><b>${u.username}</b></td>
            <td>${u.email || '-'}</td>
            <td><span class="status-pill status-${u.role}">${u.role}</span></td>
            <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
            <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
        </tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->







<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* GRID FOR ACHIEVEMENT CARDS */
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .student-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; position: relative; transition: 0.2s; }
    .student-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .student-card h4 { margin-bottom: 10px; color: var(--text-main); font-size: 16px; padding-right: 70px; line-height: 1.4; }
    .student-card p { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
    .student-card .actions { margin-top: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 15px; }

    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .status-Approved { background: #dcfce7; color: #166534; }
    .status-Pending { background: #fef3c7; color: #92400e; }
    .status-Rejected { background: #fee2e2; color: #991b1b; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-danger { background: var(--danger); color: white; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('achievements', this)"> <i class="fas fa-trophy"></i> Achievements </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact</th><th>Actions</th></tr></thead>
              <tbody id="facultyList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
          </div>
          
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Roll No</th><th>Sem & Dept</th><th>Contact Info</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="studentList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
              <tbody id="allocationList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="achievements" class="section">
      <div class="card">
        <h2>Global Achievement Tracking</h2>
        
        <div class="header-actions" style="background: var(--bg-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
            <input type="text" id="achSearch" placeholder="Search Title, Name, Roll No..." onkeyup="renderAdminAchievements()" style="width: 200px; margin-bottom: 0;">
            <select id="achCat" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Categories</option><option value="Certificate">Certificate</option><option value="Internship">Internship</option><option value="Competition">Competition</option>
            </select>
            <select id="achDept" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
            <select id="achSem" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
            <select id="achMonth" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Months</option>
                <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
            </select>
            <select id="achYear" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Years</option>
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
            </select>
            
            <button class="btn" style="background-color: #10b981; color: white;" onclick="generateGlobalReport()"><i class="fas fa-file-excel"></i> Export Filtered</button>
        </div>

        <div id="achStats" style="margin-top: 15px; font-size: 14px; font-weight: 600; color: var(--primary);"></div>

        <div class="student-grid" id="adminAchGrid"></div>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
                <tbody id="credentialList"></tbody>
            </table>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add Student</h3>
        <div class="form-group"><label>Full Name</label><input id="sName"></div>
        <div class="form-group"><label>Roll Number</label><input id="sRoll"></div>
        <div class="form-group"><label>Email</label><input id="sEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="sMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="sSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="sDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
        </div>
    </div>
</div>

<div class="modal" id="editStudentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-edit"></i> Edit Student</h3>
        <div class="form-group"><label>Full Name</label><input id="editSName"></div>
        <div class="form-group"><label>Roll Number</label><input id="editSRoll"></div>
        <div class="form-group"><label>Email</label><input id="editSEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="editSMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="editSSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="Graduated">Graduated</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="editSDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="form-group"><label>Status</label>
            <select id="editSStatus">
                <option value="Enrolled">Enrolled</option>
                <option value="Alumni">Alumni</option>
                <option value="Detained">Detained</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateStudent()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;"><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template</button>
        </div>
        <div class="form-group"><label>Department (Fallback)</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester (Fallback)</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> Assign/Edit Proctor Class</h3>
        <div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
        </div>
    </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3>üöÄ Promote Batch</h3>
        <div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Promotion Step</label>
            <select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select>
        </div>
        <div class="form-group">
            <label>Detained Students (Stay in Current Sem)</label>
            <input type="text" id="promDetained" placeholder="Comma separated Roll Nos (e.g. CS01, CS02)">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="promoteStudents()">Promote Batch</button>
        </div>
    </div>
</div>

<div id="proofModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="width: 80%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;">Document Preview</h3>
            <button onclick="document.getElementById('proofModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div id="proofBody" style="flex:1; background:#525659; overflow:auto;"></div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "achievements") loadAdminAchievements();
    if (id === "security") loadCredentials();
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid var(--border-color); padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [];
let currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>${f.email || '-'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')">Edit</button> 
                <button class="btn btn-sm btn-danger" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, roles:r}) 
    });
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS (RESTORED TO TABLE) ---
let currentEditStudentId = null;
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); 
    list.innerHTML = "";
    
    allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search)) && 
        (dept === "all" || s.dept === dept) && 
        (sem === "all" || String(s.sem) === sem)
    ).forEach(s => {
        let statusColor = s.status === 'Enrolled' ? 'status-student' : 'status-coord';
        if(s.status === 'Alumni') statusColor = 'status-proctor';
        if(s.status === 'Detained') statusColor = 'status-admin';

        list.innerHTML += `<tr>
            <td><b>${s.name}</b></td>
            <td>${s.rollNo}</td>
            <td>Sem ${s.sem} <br><small style="color:var(--text-muted)">${s.dept}</small></td>
            <td><small><i class="fas fa-envelope"></i> ${s.email || '-'}<br><i class="fas fa-phone"></i> ${s.mobile || '-'}</small></td>
            <td><span class="status-pill ${statusColor}">${s.status}</span></td>
            <td>
                <button class="btn btn-sm btn-primary" style="padding:6px 10px;" onclick="openEditStudentModal('${s._id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" style="padding:6px 10px;" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n = document.getElementById("sName").value; 
    const r = document.getElementById("sRoll").value; 
    const e = document.getElementById("sEmail").value;
    const m = document.getElementById("sMobile").value;
    const s = document.getElementById("sSem").value; 
    const d = document.getElementById("sDept").value;
    await fetch(`${API_URL}/students`, { 
        method: "POST", 
        headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, rollNo:r, email:e, mobile:m, sem:s, dept:d}) 
    });
    closeStudentModal(); loadStudents();
}

function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id);
    if (!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name;
    document.getElementById("editSRoll").value = s.rollNo;
    document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSMobile").value = s.mobile || "";
    document.getElementById("editSSem").value = s.sem;
    document.getElementById("editSDept").value = s.dept;
    document.getElementById("editSStatus").value = s.status || "Enrolled";
    document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; }

async function updateStudent() {
    const payload = {
        name: document.getElementById("editSName").value,
        rollNo: document.getElementById("editSRoll").value,
        email: document.getElementById("editSEmail").value,
        mobile: document.getElementById("editSMobile").value,
        sem: document.getElementById("editSSem").value,
        dept: document.getElementById("editSDept").value,
        status: document.getElementById("editSStatus").value
    };
    await fetch(`${API_URL}/students/${currentEditStudentId}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    closeEditStudentModal();
    loadStudents();
}

// --- PROMOTION WITH EXCEPTIONS ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; 
    const fromSem = document.getElementById("promSem").value;
    const detainedStr = document.getElementById("promDetained").value;
    
    const detainedRolls = detainedStr.split(",").map(s => s.trim()).filter(s => s !== "");

    let msg = `Promote ${dept} Sem ${fromSem}?`;
    if(detainedRolls.length > 0) msg += `\n\nEXCLUDING DETAINED STUDENTS:\n${detainedRolls.join(", ")}`;

    if(confirm(msg)) {
        const res = await fetch(`${API_URL}/students/promote`, { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ dept, fromSem, detainedRolls }) 
        });
        const data = await res.json(); 
        alert(data.message); 
        closePromoteModal(); 
        loadStudents();
    }
}

// --- CSV BULK UPLOAD WITH DUPLICATE CHECK ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function downloadTemplate() {
    const csv = "Name,RollNo,Department,Semester,Email,Mobile\nJohn Doe,CS001,CE,3,john@student.edu,9876543210\nJane Smith,CS002,IT,3,jane@student.edu,9123456780";
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Bulk_Upload_Template.csv";
    link.click();
}

function processCSVUpload() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select a CSV File");
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], duplicates = [];
        const start = rows[0].toLowerCase().includes('name') ? 1 : 0; 
        
        for(let i = start; i < rows.length; i++) {
            if(!rows[i].trim()) continue;
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = c[0].trim();
                let roll = c[1].trim();
                let dept = c[2] ? c[2].trim() : document.getElementById("csvDept")?.value || "Gen"; 
                let sem = c[3] ? c[3].trim() : document.getElementById("csvSem")?.value || "1";
                let email = (c[4] && c[4].includes('@')) ? c[4].trim() : `${roll}@student.edu`;
                let mobile = c[5] ? c[5].trim() : "";

                if (allStudents.some(s => s.rollNo === roll)) {
                    duplicates.push(roll);
                } else if (name && roll) {
                    data.push({ name, rollNo: roll, email, mobile, sem, dept, status:'Enrolled' });
                }
            }
        }

        if (duplicates.length > 0) {
            alert(`‚ö†Ô∏è The following ${duplicates.length} students already exist and will be skipped:\n${duplicates.join(', ')}`);
        }
        if (data.length === 0) return alert("No new valid students to upload.");

        if(confirm(`Proceed to upload ${data.length} new students?`)) {
            await fetch(`${API_URL}/students/bulk`, { 
                method: "POST", 
                headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify(data) 
            });
            closeCSVModal(); 
            loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr>
            <td style="color:var(--primary); font-weight:bold">${pname}</td>
            <td>${g.d}</td>
            <td>Sem ${g.s}</td>
            <td><span class="status-pill status-proctor">${g.c} Students</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditAllocation('${g.d}', '${g.s}', '${g.pid}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-danger" onclick="unassign('${g.d}', '${g.s}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}

function openEditAllocation(dept, sem, facultyId) {
    document.getElementById("allocDept").value = dept;
    document.getElementById("allocSem").value = sem;
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocFaculty").value = facultyId;
    
    document.getElementById("allocDept").disabled = true;
    document.getElementById("allocSem").disabled = true;
    document.getElementById("allocationModal").style.display = "flex";
}

function closeAllocationModal() { 
    document.getElementById("allocationModal").style.display="none"; 
    document.getElementById("allocDept").disabled = false;
    document.getElementById("allocSem").disabled = false;
}

async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove Proctor Assignment?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); 
        loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    let html = `<html><head><title>Class Lists - EduAchieve</title><style>body{font-family:'Segoe UI',sans-serif;padding:20px;}.class-header{background:#1e293b;color:white;padding:10px;font-size:18px;font-weight:bold;margin-top:20px;border-radius:6px 6px 0 0;}table{width:100%;border-collapse:collapse;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:14px;}th{background-color:#f3f4f6;font-weight:bold;}.page-break{page-break-before:always;}.footer{text-align:center;font-size:12px;color:#666;margin-top:10px;}</style></head><body><h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>`;

    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `<div class="class-header">${studentClass}</div><table><thead><tr><th width="15%">Roll No</th><th width="45%">Student Name</th><th width="40%">Assigned Proctor</th></tr></thead><tbody>`;
            currentClass = studentClass;
            isFirst = false;
        }
        html += `<tr><td><b>${s.rollNo}</b></td><td>${s.name}</td><td>${proctorName}</td></tr>`;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;
    printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

// --- ADMIN ACHIEVEMENT TRACKING (CARDS + ADVANCED FILTERING) ---
let adminAchs = [];
window.currentFilteredAchs = []; // Stores filtered list for exporting

async function loadAdminAchievements() {
    adminAchs = await fetch(`${API_URL}/achievements`).then(r => r.json());
    if (allStudents.length === 0) {
        allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    }
    renderAdminAchievements();
}

function renderAdminAchievements() {
    const search = document.getElementById("achSearch").value.toLowerCase();
    const cat = document.getElementById("achCat").value;
    const dept = document.getElementById("achDept").value;
    const sem = document.getElementById("achSem").value;
    const month = document.getElementById("achMonth").value;
    const year = document.getElementById("achYear").value;

    const grid = document.getElementById("adminAchGrid"); 
    grid.innerHTML = "";
    
    // Core Filter Logic
    window.currentFilteredAchs = adminAchs.filter(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll) || {};
        const sDept = stu.dept || "Unknown";
        const sSem = stu.sem || "Unknown";
        
        const aDate = new Date(a.date);
        const aMonth = aDate.getMonth() + 1; // 1-12
        const aYear = aDate.getFullYear();

        const matchSearch = (a.studentName && a.studentName.toLowerCase().includes(search)) || 
                            (a.studentRoll && a.studentRoll.toLowerCase().includes(search)) || 
                            (a.title && a.title.toLowerCase().includes(search));
        
        const matchCat = cat === "all" || a.category === cat;
        const matchDept = dept === "all" || sDept === dept;
        const matchSem = sem === "all" || String(sSem) === sem;
        const matchMonth = month === "all" || String(aMonth) === month;
        const matchYear = year === "all" || String(aYear) === year;

        return matchSearch && matchCat && matchDept && matchSem && matchMonth && matchYear;
    });

    // Update Stats
    const approvedCount = window.currentFilteredAchs.filter(x => x.status === 'Approved').length;
    const pendingCount = window.currentFilteredAchs.filter(x => x.status === 'Pending').length;
    document.getElementById("achStats").innerHTML = `<i class="fas fa-filter"></i> Showing ${window.currentFilteredAchs.length} results (‚úÖ ${approvedCount} Approved | ‚è≥ ${pendingCount} Pending)`;

    // Render Cards
    window.currentFilteredAchs.forEach(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const deptSem = stu ? `${stu.dept} | Sem ${stu.sem}` : `<span style="color:#ef4444;">Unknown</span>`;

        grid.innerHTML += `
            <div class="student-card">
                <div>
                    <span class="status-pill status-${a.status}" style="position:absolute; top:20px; right:20px;">${a.status}</span>
                    <h4>${a.title}</h4>
                    <p><b>Student:</b> ${a.studentName} (${a.studentRoll})</p>
                    <p><b>Class:</b> ${deptSem}</p>
                    <p><b>Category:</b> ${a.category}</p>
                    <p><b>Date:</b> ${new Date(a.date).toLocaleDateString()}</p>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-primary" style="flex:1; display:flex; justify-content:center;" onclick="openProofModal('${a._id}')"><i class="fas fa-eye"></i> View Document</button>
                </div>
            </div>`;
    });
}

function openProofModal(id) {
    const a = adminAchs.find(i => i._id === id);
    const b = document.getElementById('proofBody');
    if(!a.fileData) return alert("No file uploaded.");
    b.innerHTML = a.fileData.includes("pdf") ? `<iframe src="${a.fileData}" width="100%" height="100%" style="border:none;"></iframe>` : `<img src="${a.fileData}" style="max-width:100%; display:block; margin:auto;">`;
    document.getElementById('proofModal').style.display = 'flex';
}

function generateGlobalReport() {
    const dataToExport = window.currentFilteredAchs && window.currentFilteredAchs.length > 0 ? window.currentFilteredAchs : adminAchs;
    if(dataToExport.length === 0) return alert("No achievements found matching your filters.");
    
    let csvContent = "Roll No,Student Name,Department,Semester,Title,Category,Date,Status\n";
    
    dataToExport.forEach(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const d = stu ? stu.dept : "N/A";
        const sm = stu ? stu.sem : "N/A";

        csvContent += `${a.studentRoll},${a.studentName},${d},${sm},${a.title},${a.category},${new Date(a.date).toLocaleDateString()},${a.status}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Filtered_Achievement_Report.csv";
    link.click();
}

// --- SECURITY ---
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr>
            <td><b>${u.username}</b></td>
            <td>${u.email || '-'}</td>
            <td><span class="status-pill status-${u.role}">${u.role}</span></td>
            <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
            <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
        </tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->




<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* ACHIEVEMENT GROUP GRID (NEW) */
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .student-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; transition: 0.2s; }
    .student-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .student-card h4 { margin-bottom: 5px; color: var(--text-main); font-size: 18px; }
    .student-card p { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; }
    .student-card .actions { margin-top: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 15px; }

    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .status-Approved { background: #dcfce7; color: #166534; }
    .status-Pending { background: #fef3c7; color: #92400e; }
    .status-Rejected { background: #fee2e2; color: #991b1b; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-danger { background: var(--danger); color: white; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('achievements', this)"> <i class="fas fa-trophy"></i> Achievements </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact & Notify</th><th>Actions</th></tr></thead>
              <tbody id="facultyList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
          </div>
          
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Roll No</th><th>Sem & Dept</th><th>Contact Info</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="studentList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
              <tbody id="allocationList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="achievements" class="section">
      <div class="card">
        <h2>Global Achievement Tracking</h2>
        
        <div class="header-actions" style="background: var(--bg-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
            <input type="text" id="achSearch" placeholder="Search Name, Roll No..." onkeyup="renderAdminAchievements()" style="width: 200px; margin-bottom: 0;">
            <select id="achCat" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Categories</option><option value="Certificate">Certificate</option><option value="Internship">Internship</option><option value="Competition">Competition</option>
            </select>
            <select id="achDept" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
            <select id="achSem" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
            <select id="achMonth" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Months</option>
                <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
            </select>
            <select id="achYear" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Years</option>
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
            </select>
            
            <button class="btn" style="background-color: #10b981; color: white;" onclick="generateGlobalReport()"><i class="fas fa-file-excel"></i> Export Filtered</button>
        </div>

        <div id="achStats" style="margin-top: 15px; font-size: 14px; font-weight: 600; color: var(--primary);"></div>

        <div class="student-grid" id="adminAchGrid"></div>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
                <tbody id="credentialList"></tbody>
            </table>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail"></div>
        <div class="form-group"><label>Mobile Number</label><input id="fMobile"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="form-group"><label>Mobile Number</label><input id="editFMobile"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add Student</h3>
        <div class="form-group"><label>Full Name</label><input id="sName"></div>
        <div class="form-group"><label>Roll Number</label><input id="sRoll"></div>
        <div class="form-group"><label>Email</label><input id="sEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="sMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="sSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="sDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
        </div>
    </div>
</div>

<div class="modal" id="editStudentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-edit"></i> Edit Student</h3>
        <div class="form-group"><label>Full Name</label><input id="editSName"></div>
        <div class="form-group"><label>Roll Number</label><input id="editSRoll"></div>
        <div class="form-group"><label>Email</label><input id="editSEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="editSMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="editSSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="Graduated">Graduated</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="editSDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="form-group"><label>Status</label>
            <select id="editSStatus">
                <option value="Enrolled">Enrolled</option>
                <option value="Alumni">Alumni</option>
                <option value="Detained">Detained</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateStudent()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;"><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template</button>
        </div>
        <div class="form-group"><label>Department (Fallback)</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester (Fallback)</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> Assign/Edit Proctor Class</h3>
        <div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
        </div>
    </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3>üöÄ Promote Batch</h3>
        <div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Promotion Step</label>
            <select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select>
        </div>
        <div class="form-group">
            <label>Detained Students (Stay in Current Sem)</label>
            <input type="text" id="promDetained" placeholder="Comma separated Roll Nos (e.g. CS01, CS02)">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="promoteStudents()">Promote Batch</button>
        </div>
    </div>
</div>

<div class="modal" id="adminStudentAchModal" style="z-index: 1500;">
    <div class="modal-content" style="width: 800px; max-width: 90%;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;"><i class="fas fa-folder-open"></i> Student Documents</h3>
            <button onclick="document.getElementById('adminStudentAchModal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Title</th><th>Category</th><th>Date</th><th>Status</th><th>Proof</th></tr></thead>
                <tbody id="adminStudentAchList"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="proofModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="width: 80%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;">Document Preview</h3>
            <button onclick="document.getElementById('proofModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        <div id="proofBody" style="flex:1; background:#525659; overflow:auto; border-radius:8px;"></div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "achievements") loadAdminAchievements();
    if (id === "security") loadCredentials();
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid var(--border-color); padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [];
let currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>
                <small><i class="fas fa-envelope"></i> ${f.email || 'N/A'}<br><i class="fas fa-phone"></i> ${f.mobile || 'N/A'}</small>
                <div style="margin-top:5px; display:flex; gap:5px;">
                    <button class="btn" style="background:#25D366; color:white; padding: 4px 8px; font-size:12px;" onclick="notifyWhatsApp('${f.mobile}', '${f.name}')" title="WhatsApp Notify"><i class="fab fa-whatsapp"></i></button>
                    <button class="btn" style="background:#ea4335; color:white; padding: 4px 8px; font-size:12px;" onclick="notifyEmail('${f.email}', '${f.name}')" title="Email Notify"><i class="fas fa-envelope"></i></button>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')"><i class="fas fa-edit"></i> Edit</button> 
                <button class="btn btn-sm btn-danger" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function notifyWhatsApp(mobile, name) {
    if(!mobile || mobile === 'undefined') return alert("No mobile number provided for this faculty.");
    const msg = `Hello ${name}, you have been assigned new roles/proctoring duties in the EduAchieve Portal. Please login to check your dashboard.`;
    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
}

async function notifyEmail(email, name) {
    if(!email || email === 'undefined') return alert("No email provided.");
    if(confirm(`Send email notification to ${email}?`)) {
        await fetch(`${API_URL}/notify-faculty`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, name })
        });
        alert("Email sent!");
    }
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const m = document.getElementById("fMobile").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty`, { 
        method: "POST", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, mobile:m, roles:r}) 
    });
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFMobile").value = f.mobile || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const mobile = document.getElementById("editFMobile").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, mobile, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS ---
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); 
    list.innerHTML = "";
    
    allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search)) && 
        (dept === "all" || s.dept === dept) && 
        (sem === "all" || String(s.sem) === sem)
    ).forEach(s => {
        let statusColor = s.status === 'Enrolled' ? 'status-student' : 'status-coord';
        if(s.status === 'Alumni') statusColor = 'status-proctor';
        if(s.status === 'Detained') statusColor = 'status-admin';

        list.innerHTML += `<tr>
            <td><b>${s.name}</b></td>
            <td>${s.rollNo}</td>
            <td>Sem ${s.sem} <br><small style="color:var(--text-muted)">${s.dept}</small></td>
            <td><small><i class="fas fa-envelope"></i> ${s.email || '-'}<br><i class="fas fa-phone"></i> ${s.mobile || '-'}</small></td>
            <td><span class="status-pill ${statusColor}">${s.status}</span></td>
            <td>
                <button class="btn btn-sm btn-primary" style="padding:6px 10px;" onclick="openEditStudentModal('${s._id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" style="padding:6px 10px;" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { document.getElementById("studentModal").style.display="none"; }
async function saveStudent() {
    const n = document.getElementById("sName").value; 
    const r = document.getElementById("sRoll").value; 
    const e = document.getElementById("sEmail").value;
    const m = document.getElementById("sMobile").value;
    const s = document.getElementById("sSem").value; 
    const d = document.getElementById("sDept").value;
    await fetch(`${API_URL}/students`, { 
        method: "POST", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, rollNo:r, email:e, mobile:m, sem:s, dept:d}) 
    });
    closeStudentModal(); loadStudents();
}

function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id);
    if (!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name;
    document.getElementById("editSRoll").value = s.rollNo;
    document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSMobile").value = s.mobile || "";
    document.getElementById("editSSem").value = s.sem;
    document.getElementById("editSDept").value = s.dept;
    document.getElementById("editSStatus").value = s.status || "Enrolled";
    document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; }

async function updateStudent() {
    const payload = {
        name: document.getElementById("editSName").value,
        rollNo: document.getElementById("editSRoll").value,
        email: document.getElementById("editSEmail").value,
        mobile: document.getElementById("editSMobile").value,
        sem: document.getElementById("editSSem").value,
        dept: document.getElementById("editSDept").value,
        status: document.getElementById("editSStatus").value
    };
    await fetch(`${API_URL}/students/${currentEditStudentId}`, {
        method: "PUT", headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    closeEditStudentModal(); loadStudents();
}

// --- PROMOTION WITH EXCEPTIONS ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; 
    const fromSem = document.getElementById("promSem").value;
    const detainedStr = document.getElementById("promDetained").value;
    
    const detainedRolls = detainedStr.split(",").map(s => s.trim()).filter(s => s !== "");

    let msg = `Promote ${dept} Sem ${fromSem}?`;
    if(detainedRolls.length > 0) msg += `\n\nEXCLUDING DETAINED STUDENTS:\n${detainedRolls.join(", ")}`;

    if(confirm(msg)) {
        const res = await fetch(`${API_URL}/students/promote`, { 
            method: "POST", headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ dept, fromSem, detainedRolls }) 
        });
        const data = await res.json(); 
        alert(data.message); closePromoteModal(); loadStudents();
    }
}

// --- CSV BULK UPLOAD WITH DUPLICATE CHECK ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function downloadTemplate() {
    const csv = "Name,RollNo,Department,Semester,Email,Mobile\nJohn Doe,CS001,CE,3,john@student.edu,9876543210\nJane Smith,CS002,IT,3,jane@student.edu,9123456780";
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Bulk_Upload_Template.csv";
    link.click();
}

function processCSVUpload() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select a CSV File");
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], duplicates = [];
        const start = rows[0].toLowerCase().includes('name') ? 1 : 0; 
        
        for(let i = start; i < rows.length; i++) {
            if(!rows[i].trim()) continue;
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = c[0].trim();
                let roll = c[1].trim();
                let dept = c[2] ? c[2].trim() : document.getElementById("csvDept")?.value || "Gen"; 
                let sem = c[3] ? c[3].trim() : document.getElementById("csvSem")?.value || "1";
                let email = (c[4] && c[4].includes('@')) ? c[4].trim() : `${roll}@student.edu`;
                let mobile = c[5] ? c[5].trim() : "";

                if (allStudents.some(s => s.rollNo === roll)) {
                    duplicates.push(roll);
                } else if (name && roll) {
                    data.push({ name, rollNo: roll, email, mobile, sem, dept, status:'Enrolled' });
                }
            }
        }

        if (duplicates.length > 0) {
            alert(`‚ö†Ô∏è The following ${duplicates.length} students already exist and will be skipped:\n${duplicates.join(', ')}`);
        }
        if (data.length === 0) return alert("No new valid students to upload.");

        if(confirm(`Proceed to upload ${data.length} new students?`)) {
            await fetch(`${API_URL}/students/bulk`, { 
                method: "POST", headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify(data) 
            });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr>
            <td style="color:var(--primary); font-weight:bold">${pname}</td>
            <td>${g.d}</td>
            <td>Sem ${g.s}</td>
            <td><span class="status-pill status-proctor">${g.c} Students</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditAllocation('${g.d}', '${g.s}', '${g.pid}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-danger" onclick="unassign('${g.d}', '${g.s}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}

function openEditAllocation(dept, sem, facultyId) {
    document.getElementById("allocDept").value = dept;
    document.getElementById("allocSem").value = sem;
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocFaculty").value = facultyId;
    
    document.getElementById("allocDept").disabled = true;
    document.getElementById("allocSem").disabled = true;
    document.getElementById("allocationModal").style.display = "flex";
}

function closeAllocationModal() { 
    document.getElementById("allocationModal").style.display="none"; 
    document.getElementById("allocDept").disabled = false;
    document.getElementById("allocSem").disabled = false;
}

async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove Proctor Assignment?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    let html = `<html><head><title>Class Lists - EduAchieve</title><style>body{font-family:'Segoe UI',sans-serif;padding:20px;}.class-header{background:#1e293b;color:white;padding:10px;font-size:18px;font-weight:bold;margin-top:20px;border-radius:6px 6px 0 0;}table{width:100%;border-collapse:collapse;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:14px;}th{background-color:#f3f4f6;font-weight:bold;}.page-break{page-break-before:always;}.footer{text-align:center;font-size:12px;color:#666;margin-top:10px;}</style></head><body><h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>`;

    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `<div class="class-header">${studentClass}</div><table><thead><tr><th width="15%">Roll No</th><th width="45%">Student Name</th><th width="40%">Assigned Proctor</th></tr></thead><tbody>`;
            currentClass = studentClass;
            isFirst = false;
        }
        html += `<tr><td><b>${s.rollNo}</b></td><td>${s.name}</td><td>${proctorName}</td></tr>`;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;
    printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

// --- üü© ADMIN ACHIEVEMENT TRACKING (ONE BOX PER STUDENT) ---
let adminAchs = [];
window.currentFilteredAchs = []; 

async function loadAdminAchievements() {
    adminAchs = await fetch(`${API_URL}/achievements`).then(r => r.json());
    if (allStudents.length === 0) {
        allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    }
    renderAdminAchievements();
}

function renderAdminAchievements() {
    const search = document.getElementById("achSearch").value.toLowerCase();
    const cat = document.getElementById("achCat").value;
    const dept = document.getElementById("achDept").value;
    const sem = document.getElementById("achSem").value;
    const month = document.getElementById("achMonth").value;
    const year = document.getElementById("achYear").value;

    const grid = document.getElementById("adminAchGrid"); 
    grid.innerHTML = "";
    
    // Filter down the master list
    window.currentFilteredAchs = adminAchs.filter(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll) || {};
        const sDept = stu.dept || "Unknown";
        const sSem = stu.sem || "Unknown";
        
        const aDate = new Date(a.date);
        const aMonth = (aDate.getMonth() + 1).toString();
        const aYear = aDate.getFullYear().toString();

        const matchSearch = (a.studentName && a.studentName.toLowerCase().includes(search)) || 
                            (a.studentRoll && a.studentRoll.toLowerCase().includes(search)) || 
                            (a.title && a.title.toLowerCase().includes(search));
        
        const matchCat = cat === "all" || a.category === cat;
        const matchDept = dept === "all" || sDept === dept;
        const matchSem = sem === "all" || String(sSem) === sem;
        const matchMonth = month === "all" || aMonth === month;
        const matchYear = year === "all" || aYear === year;

        return matchSearch && matchCat && matchDept && matchSem && matchMonth && matchYear;
    });

    // Group the filtered achievements by Student
    const studentGroups = {};
    let approvedCount = 0, pendingCount = 0, rejectedCount = 0;

    window.currentFilteredAchs.forEach(a => {
        if(!studentGroups[a.studentRoll]) {
            studentGroups[a.studentRoll] = {
                name: a.studentName, roll: a.studentRoll,
                achs: [], approved: 0, pending: 0, rejected: 0
            };
        }
        studentGroups[a.studentRoll].achs.push(a);
        
        if(a.status === 'Approved') { studentGroups[a.studentRoll].approved++; approvedCount++; }
        if(a.status === 'Pending') { studentGroups[a.studentRoll].pending++; pendingCount++; }
        if(a.status === 'Rejected') { studentGroups[a.studentRoll].rejected++; rejectedCount++; }
    });

    // Update Top Stats
    document.getElementById("achStats").innerHTML = `<i class="fas fa-filter"></i> Found ${window.currentFilteredAchs.length} documents across ${Object.keys(studentGroups).length} students (‚úÖ ${approvedCount} Approved | ‚è≥ ${pendingCount} Pending | ‚ùå ${rejectedCount} Rejected)`;

    // Render Student Cards
    Object.values(studentGroups).forEach(group => {
        const stu = allStudents.find(s => s.rollNo === group.roll);
        const deptSem = stu ? `${stu.dept} | Sem ${stu.sem}` : `<span style="color:#ef4444;">Unknown</span>`;

        grid.innerHTML += `
            <div class="student-card">
                <div>
                    <h4>${group.name}</h4>
                    <p><b>Roll No:</b> ${group.roll}</p>
                    <p><b>Class:</b> ${deptSem}</p>
                    <div style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                        <span class="status-pill status-Approved">${group.approved} Approved</span>
                        <span class="status-pill status-Pending">${group.pending} Pending</span>
                        ${group.rejected > 0 ? `<span class="status-pill status-Rejected">${group.rejected} Rejected</span>` : ''}
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-primary" style="flex:1;" onclick="openStudentAchModal('${group.roll}')"><i class="fas fa-folder-open"></i> View ${group.achs.length} Docs</button>
                </div>
            </div>`;
    });
}

function openStudentAchModal(rollNo) {
    const list = document.getElementById("adminStudentAchList");
    list.innerHTML = "";
    
    const achs = window.currentFilteredAchs.filter(a => a.studentRoll === rollNo);
    
    achs.forEach(a => {
        list.innerHTML += `
            <tr>
                <td><b>${a.title}</b></td>
                <td>${a.category}</td>
                <td>${new Date(a.date).toLocaleDateString()}</td>
                <td><span class="status-pill status-${a.status}">${a.status}</span></td>
                <td><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="openProofModal('${a._id}')"><i class="fas fa-eye"></i></button></td>
            </tr>
        `;
    });
    
    document.getElementById("adminStudentAchModal").style.display = "flex";
}

function openProofModal(id) {
    const a = adminAchs.find(i => i._id === id);
    const b = document.getElementById('proofBody');
    if(!a.fileData) return alert("No file uploaded.");
    b.innerHTML = a.fileData.includes("pdf") ? `<iframe src="${a.fileData}" width="100%" height="100%" style="border:none;"></iframe>` : `<img src="${a.fileData}" style="max-width:100%; display:block; margin:auto;">`;
    document.getElementById('proofModal').style.display = 'flex';
}

function generateGlobalReport() {
    const dataToExport = window.currentFilteredAchs && window.currentFilteredAchs.length > 0 ? window.currentFilteredAchs : adminAchs;
    if(dataToExport.length === 0) return alert("No achievements found matching your filters.");
    
    let csvContent = "Roll No,Student Name,Department,Semester,Title,Category,Date,Status\n";
    
    dataToExport.forEach(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const d = stu ? stu.dept : "N/A";
        const sm = stu ? stu.sem : "N/A";

        csvContent += `${a.studentRoll},${a.studentName},${d},${sm},${a.title},${a.category},${new Date(a.date).toLocaleDateString()},${a.status}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Filtered_Achievement_Report.csv";
    link.click();
}

// --- SECURITY ---
async function loadCredentials() {
    const users = await fetch("http://localhost:5000/users").then(r => r.json());
    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    users.forEach(u => {
        list.innerHTML += `<tr>
            <td><b>${u.username}</b></td>
            <td>${u.email || '-'}</td>
            <td><span class="status-pill status-${u.role}">${u.role}</span></td>
            <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
            <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
        </tr>`;
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->






<!--DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduAchieve | Admin Console</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root {
        --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
        --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
        --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
    }
    body.dark-mode {
        --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
        --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

    /* SIDEBAR */
    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
    .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-logout { background: #334155; color: white; }
    .btn-reset { background: #7f1d1d; color: #fecaca; }
    .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .active-section { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS & TABLES */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
    .stats-grid .card { cursor: pointer; transition: 0.2s; }
    .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
    .card p { color: var(--text-muted); font-size: 14px; }

    .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
    .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
    td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    
    /* GRID FOR ACHIEVEMENT CARDS */
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .student-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; position: relative; transition: 0.2s; }
    .student-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .student-card h4 { margin-bottom: 10px; color: var(--text-main); font-size: 16px; padding-right: 70px; line-height: 1.4; }
    .student-card p { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
    .student-card .actions { margin-top: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 15px; }

    /* BADGES */
    .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
    .status-admin { background: #fee2e2; color: #b91c1c; } 
    .status-student { background: #dcfce7; color: #15803d; }
    .status-proctor { background: #d1fae5; color: #065f46; }
    .status-hod { background: #ffedd5; color: #9a3412; }
    .status-coord { background: #fef9c3; color: #854d0e; }
    .status-Approved { background: #dcfce7; color: #166534; }
    .status-Pending { background: #fef3c7; color: #92400e; }
    .status-Rejected { background: #fee2e2; color: #991b1b; }
    .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

    /* MODAL SYSTEM */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
    .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
    
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-danger { background: var(--danger); color: white; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('achievements', this)"> <i class="fas fa-trophy"></i> Achievements </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact & Notify</th><th>Actions</th></tr></thead>
              <tbody id="facultyList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="students" class="section">
      
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
    <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
    <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
    <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
    
    <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
    <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
    <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
    
    <button class="btn" style="background-color: #f59e0b; color: white;" onclick="notifyInactiveStudents()"> <i class="fas fa-bell"></i> Alert Inactive </button>
</div>
          
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Roll No</th><th>Sem & Dept</th><th>Contact Info</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="studentList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
              <tbody id="allocationList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="achievements" class="section">
      <div class="card">
        <h2>Global Achievement Tracking</h2>
        <div class="header-actions" style="background: var(--bg-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
            <input type="text" id="achSearch" placeholder="Search Name, Roll No..." onkeyup="renderAdminAchievements()" style="width: 200px; margin-bottom: 0;">
            <select id="achCat" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Categories</option><option value="Certificate">Certificate</option><option value="Internship">Internship</option><option value="Competition">Competition</option>
            </select>
            <select id="achDept" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
            <select id="achSem" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
            <select id="achMonth" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Months</option>
                <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
            </select>
            <select id="achYear" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Years</option>
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
            </select>
            
            <button class="btn" style="background-color: #10b981; color: white;" onclick="generateGlobalReport()"><i class="fas fa-file-excel"></i> Export Filtered</button>
        </div>
        <div id="achStats" style="margin-top: 15px; font-size: 14px; font-weight: 600; color: var(--primary);"></div>
        <div class="student-grid" id="adminAchGrid"></div>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
                <tbody id="credentialList"></tbody>
            </table>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName" oninput="autoFillEmail('faculty')"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail" oninput="this.dataset.modified=true"></div>
        <div class="form-group"><label>Mobile Number</label><input id="fMobile"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="form-group"><label>Mobile Number</label><input id="editFMobile"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add Student</h3>
        <div class="form-group"><label>Full Name</label><input id="sName"></div>
        <div class="form-group"><label>Roll Number</label><input id="sRoll" oninput="autoFillEmail('student')"></div>
        <div class="form-group"><label>Email</label><input id="sEmail" oninput="this.dataset.modified=true"></div>
        <div class="form-group"><label>Mobile</label><input id="sMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="sSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="sDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
        </div>
    </div>
</div>

<div class="modal" id="editStudentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-edit"></i> Edit Student</h3>
        <div class="form-group"><label>Full Name</label><input id="editSName"></div>
        <div class="form-group"><label>Roll Number</label><input id="editSRoll"></div>
        <div class="form-group"><label>Email</label><input id="editSEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="editSMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="editSSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="Graduated">Graduated</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="editSDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="form-group"><label>Status</label>
            <select id="editSStatus">
                <option value="Enrolled">Enrolled</option>
                <option value="Alumni">Alumni</option>
                <option value="Detained">Detained</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateStudent()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;"><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template</button>
        </div>
        <div class="form-group"><label>Department (Fallback)</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester (Fallback)</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> Assign/Edit Proctor Class</h3>
        <div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
        </div>
    </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3>üöÄ Promote Batch</h3>
        <div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Promotion Step</label>
            <select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select>
        </div>
        <div class="form-group">
            <label>Detained Students (Stay in Current Sem)</label>
            <input type="text" id="promDetained" placeholder="Comma separated Roll Nos (e.g. CS01, CS02)">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="promoteStudents()">Promote Batch</button>
        </div>
    </div>
</div>

<div class="modal" id="adminStudentAchModal" style="z-index: 1500;">
    <div class="modal-content" style="width: 800px; max-width: 90%;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;"><i class="fas fa-folder-open"></i> Student Documents</h3>
            <button onclick="document.getElementById('adminStudentAchModal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Title</th><th>Category</th><th>Date</th><th>Status</th><th>Proof</th></tr></thead>
                <tbody id="adminStudentAchList"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="proofModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="width: 80%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;">Document Preview</h3>
            <button onclick="document.getElementById('proofModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        <div id="proofBody" style="flex:1; background:#525659; overflow:auto; border-radius:8px;"></div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "achievements") loadAdminAchievements();
    if (id === "security") loadCredentials();
}

// üü© AUTOFILL GOOGLE-LIKE FEATURE
function autoFillEmail(type) {
    if (type === 'student') {
        const roll = document.getElementById('sRoll').value;
        const emailInput = document.getElementById('sEmail');
        if (!emailInput.dataset.modified) emailInput.value = roll ? `${roll.toLowerCase()}@student.edu` : "";
    } else if (type === 'faculty') {
        const name = document.getElementById('fName').value;
        const emailInput = document.getElementById('fEmail');
        if (!emailInput.dataset.modified) emailInput.value = name ? `${name.replace(/\\s+/g, '').toLowerCase()}@edu.com` : "";
    }
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid var(--border-color); padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [];
let currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>
                <small><i class="fas fa-envelope"></i> ${f.email || 'N/A'}<br><i class="fas fa-phone"></i> ${f.mobile || 'N/A'}</small>
                <div style="margin-top:5px; display:flex; gap:5px;">
                    <button class="btn" style="background:#25D366; color:white; padding: 4px 8px; font-size:12px;" onclick="notifyWhatsApp('${f.mobile}', '${f.name}')" title="WhatsApp Notify"><i class="fab fa-whatsapp"></i></button>
                    <button class="btn" style="background:#ea4335; color:white; padding: 4px 8px; font-size:12px;" onclick="notifyEmail('${f.email}', '${f.name}')" title="Email Notify"><i class="fas fa-envelope"></i></button>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')"><i class="fas fa-edit"></i> Edit</button> 
                <button class="btn btn-sm btn-danger" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function notifyWhatsApp(mobile, name) {
    if(!mobile || mobile === 'undefined') return alert("No mobile number provided for this faculty.");
    const msg = `Hello ${name}, you have been assigned new roles/proctoring duties in the EduAchieve Portal. Please login to check your dashboard.`;
    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
}

async function notifyEmail(email, name) {
    if(!email || email === 'undefined') return alert("No email provided.");
    if(confirm(`Send email notification to ${email}?`)) {
        await fetch(`${API_URL}/notify-faculty`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, name })
        });
        alert("Email sent!");
    }
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
    document.getElementById("fEmail").dataset.modified = "";
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const m = document.getElementById("fMobile").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    const res = await fetch(`${API_URL}/faculty`, { 
        method: "POST", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, mobile:m, roles:r}) 
    });
    
    if(!res.ok) return alert("Error adding faculty");
    
    alert("‚úÖ Faculty Added Successfully!");
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFMobile").value = f.mobile || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const mobile = document.getElementById("editFMobile").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, mobile, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS ---
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); 
    list.innerHTML = "";
    
    allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search)) && 
        (dept === "all" || s.dept === dept) && 
        (sem === "all" || String(s.sem) === sem)
    ).forEach(s => {
        let statusColor = s.status === 'Enrolled' ? 'status-student' : 'status-coord';
        if(s.status === 'Alumni') statusColor = 'status-proctor';
        if(s.status === 'Detained') statusColor = 'status-admin';

        list.innerHTML += `<tr>
            <td><b>${s.name}</b></td>
            <td>${s.rollNo}</td>
            <td>Sem ${s.sem} <br><small style="color:var(--text-muted)">${s.dept}</small></td>
            <td><small><i class="fas fa-envelope"></i> ${s.email || '-'}<br><i class="fas fa-phone"></i> ${s.mobile || '-'}</small></td>
            <td><span class="status-pill ${statusColor}">${s.status}</span></td>
            <td>
                <button class="btn btn-sm btn-primary" style="padding:6px 10px;" onclick="openEditStudentModal('${s._id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" style="padding:6px 10px;" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { 
    document.getElementById("studentModal").style.display="none"; 
    document.getElementById("sEmail").dataset.modified = "";
}

// üü© DUPLICATE NOTIFICATION UPDATED HERE
async function saveStudent() {
    const n = document.getElementById("sName").value; 
    const r = document.getElementById("sRoll").value; 
    const e = document.getElementById("sEmail").value;
    const m = document.getElementById("sMobile").value;
    const s = document.getElementById("sSem").value; 
    const d = document.getElementById("sDept").value;
    
    const res = await fetch(`${API_URL}/students`, { 
        method: "POST", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, rollNo:r, email:e, mobile:m, sem:s, dept:d}) 
    });
    
    const data = await res.json();
    if (!res.ok) {
        alert("‚ö†Ô∏è " + (data.message || "Failed to register student"));
        return;
    }
    
    alert("‚úÖ " + data.message);
    closeStudentModal(); loadStudents();
}

function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id);
    if (!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name;
    document.getElementById("editSRoll").value = s.rollNo;
    document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSMobile").value = s.mobile || "";
    document.getElementById("editSSem").value = s.sem;
    document.getElementById("editSDept").value = s.dept;
    document.getElementById("editSStatus").value = s.status || "Enrolled";
    document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; }

async function updateStudent() {
    const payload = {
        name: document.getElementById("editSName").value,
        rollNo: document.getElementById("editSRoll").value,
        email: document.getElementById("editSEmail").value,
        mobile: document.getElementById("editSMobile").value,
        sem: document.getElementById("editSSem").value,
        dept: document.getElementById("editSDept").value,
        status: document.getElementById("editSStatus").value
    };
    await fetch(`${API_URL}/students/${currentEditStudentId}`, {
        method: "PUT", headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    closeEditStudentModal(); loadStudents();
}

// --- PROMOTION WITH EXCEPTIONS ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; 
    const fromSem = document.getElementById("promSem").value;
    const detainedStr = document.getElementById("promDetained").value;
    
    const detainedRolls = detainedStr.split(",").map(s => s.trim()).filter(s => s !== "");

    let msg = `Promote ${dept} Sem ${fromSem}?`;
    if(detainedRolls.length > 0) msg += `\n\nEXCLUDING DETAINED STUDENTS:\n${detainedRolls.join(", ")}`;

    if(confirm(msg)) {
        const res = await fetch(`${API_URL}/students/promote`, { 
            method: "POST", headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ dept, fromSem, detainedRolls }) 
        });
        const data = await res.json(); 
        alert(data.message); closePromoteModal(); loadStudents();
    }
}

// --- CSV BULK UPLOAD ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function downloadTemplate() {
    const csv = "Name,RollNo,Department,Semester,Email,Mobile\nJohn Doe,CS001,CE,3,john@student.edu,9876543210\nJane Smith,CS002,IT,3,jane@student.edu,9123456780";
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Bulk_Upload_Template.csv";
    link.click();
}

function processCSVUpload() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select a CSV File");
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], duplicates = [];
        const start = rows[0].toLowerCase().includes('name') ? 1 : 0; 
        
        for(let i = start; i < rows.length; i++) {
            if(!rows[i].trim()) continue;
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = c[0].trim();
                let roll = c[1].trim();
                let dept = c[2] ? c[2].trim() : document.getElementById("csvDept")?.value || "Gen"; 
                let sem = c[3] ? c[3].trim() : document.getElementById("csvSem")?.value || "1";
                let email = (c[4] && c[4].includes('@')) ? c[4].trim() : `${roll}@student.edu`;
                let mobile = c[5] ? c[5].trim() : "";

                if (allStudents.some(s => s.rollNo === roll)) {
                    duplicates.push(roll);
                } else if (name && roll) {
                    data.push({ name, rollNo: roll, email, mobile, sem, dept, status:'Enrolled' });
                }
            }
        }

        if (duplicates.length > 0) {
            alert(`‚ö†Ô∏è The following ${duplicates.length} students already exist and will be skipped:\n${duplicates.join(', ')}`);
        }
        if (data.length === 0) return alert("No new valid students to upload.");

        if(confirm(`Proceed to upload ${data.length} new students?`)) {
            await fetch(`${API_URL}/students/bulk`, { 
                method: "POST", headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify(data) 
            });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr>
            <td style="color:var(--primary); font-weight:bold">${pname}</td>
            <td>${g.d}</td>
            <td>Sem ${g.s}</td>
            <td><span class="status-pill status-proctor">${g.c} Students</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditAllocation('${g.d}', '${g.s}', '${g.pid}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-danger" onclick="unassign('${g.d}', '${g.s}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}

function openEditAllocation(dept, sem, facultyId) {
    document.getElementById("allocDept").value = dept;
    document.getElementById("allocSem").value = sem;
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocFaculty").value = facultyId;
    
    document.getElementById("allocDept").disabled = true;
    document.getElementById("allocSem").disabled = true;
    document.getElementById("allocationModal").style.display = "flex";
}

function closeAllocationModal() { 
    document.getElementById("allocationModal").style.display="none"; 
    document.getElementById("allocDept").disabled = false;
    document.getElementById("allocSem").disabled = false;
}

async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove Proctor Assignment?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    let html = `<html><head><title>Class Lists - EduAchieve</title><style>body{font-family:'Segoe UI',sans-serif;padding:20px;}.class-header{background:#1e293b;color:white;padding:10px;font-size:18px;font-weight:bold;margin-top:20px;border-radius:6px 6px 0 0;}table{width:100%;border-collapse:collapse;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:14px;}th{background-color:#f3f4f6;font-weight:bold;}.page-break{page-break-before:always;}.footer{text-align:center;font-size:12px;color:#666;margin-top:10px;}</style></head><body><h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>`;

    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `<div class="class-header">${studentClass}</div><table><thead><tr><th width="15%">Roll No</th><th width="45%">Student Name</th><th width="40%">Assigned Proctor</th></tr></thead><tbody>`;
            currentClass = studentClass;
            isFirst = false;
        }
        html += `<tr><td><b>${s.rollNo}</b></td><td>${s.name}</td><td>${proctorName}</td></tr>`;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;
    printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

// --- ADMIN ACHIEVEMENT TRACKING ---
let adminAchs = [];
window.currentFilteredAchs = []; 

async function loadAdminAchievements() {
    adminAchs = await fetch(`${API_URL}/achievements`).then(r => r.json());
    if (allStudents.length === 0) {
        allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    }
    renderAdminAchievements();
}

function renderAdminAchievements() {
    const search = document.getElementById("achSearch").value.toLowerCase();
    const cat = document.getElementById("achCat").value;
    const dept = document.getElementById("achDept").value;
    const sem = document.getElementById("achSem").value;
    const month = document.getElementById("achMonth").value;
    const year = document.getElementById("achYear").value;

    const grid = document.getElementById("adminAchGrid"); 
    grid.innerHTML = "";
    
    window.currentFilteredAchs = adminAchs.filter(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll) || {};
        const sDept = stu.dept || "Unknown";
        const sSem = stu.sem || "Unknown";
        
        const aDate = new Date(a.date);
        const aMonth = (aDate.getMonth() + 1).toString();
        const aYear = aDate.getFullYear().toString();

        const matchSearch = (a.studentName && a.studentName.toLowerCase().includes(search)) || 
                            (a.studentRoll && a.studentRoll.toLowerCase().includes(search)) || 
                            (a.title && a.title.toLowerCase().includes(search));
        
        const matchCat = cat === "all" || a.category === cat;
        const matchDept = dept === "all" || sDept === dept;
        const matchSem = sem === "all" || String(sSem) === sem;
        const matchMonth = month === "all" || aMonth === month;
        const matchYear = year === "all" || aYear === year;

        return matchSearch && matchCat && matchDept && matchSem && matchMonth && matchYear;
    });

    const studentGroups = {};
    let approvedCount = 0, pendingCount = 0, rejectedCount = 0;

    window.currentFilteredAchs.forEach(a => {
        if(!studentGroups[a.studentRoll]) {
            studentGroups[a.studentRoll] = { name: a.studentName, roll: a.studentRoll, achs: [], approved: 0, pending: 0, rejected: 0 };
        }
        studentGroups[a.studentRoll].achs.push(a);
        if(a.status === 'Approved') { studentGroups[a.studentRoll].approved++; approvedCount++; }
        if(a.status === 'Pending') { studentGroups[a.studentRoll].pending++; pendingCount++; }
        if(a.status === 'Rejected') { studentGroups[a.studentRoll].rejected++; rejectedCount++; }
    });

    document.getElementById("achStats").innerHTML = `<i class="fas fa-filter"></i> Found ${window.currentFilteredAchs.length} documents across ${Object.keys(studentGroups).length} students (‚úÖ ${approvedCount} Approved | ‚è≥ ${pendingCount} Pending | ‚ùå ${rejectedCount} Rejected)`;

    Object.values(studentGroups).forEach(group => {
        const stu = allStudents.find(s => s.rollNo === group.roll);
        const deptSem = stu ? `${stu.dept} | Sem ${stu.sem}` : `<span style="color:#ef4444;">Unknown</span>`;

        grid.innerHTML += `
            <div class="student-card">
                <div>
                    <h4>${group.name}</h4>
                    <p><b>Roll No:</b> ${group.roll}</p>
                    <p><b>Class:</b> ${deptSem}</p>
                    <div style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                        <span class="status-pill status-Approved">${group.approved} Approved</span>
                        <span class="status-pill status-Pending">${group.pending} Pending</span>
                        ${group.rejected > 0 ? `<span class="status-pill status-Rejected">${group.rejected} Rejected</span>` : ''}
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-primary" style="flex:1;" onclick="openStudentAchModal('${group.roll}')"><i class="fas fa-folder-open"></i> View ${group.achs.length} Docs</button>
                </div>
            </div>`;
    });
}

function openStudentAchModal(rollNo) {
    const list = document.getElementById("adminStudentAchList");
    list.innerHTML = "";
    const achs = window.currentFilteredAchs.filter(a => a.studentRoll === rollNo);
    
    achs.forEach(a => {
        list.innerHTML += `
            <tr>
                <td><b>${a.title}</b></td>
                <td>${a.category}</td>
                <td>${new Date(a.date).toLocaleDateString()}</td>
                <td><span class="status-pill status-${a.status}">${a.status}</span></td>
                <td><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="openProofModal('${a._id}')"><i class="fas fa-eye"></i></button></td>
            </tr>`;
    });
    document.getElementById("adminStudentAchModal").style.display = "flex";
}

function openProofModal(id) {
    const a = adminAchs.find(i => i._id === id);
    const b = document.getElementById('proofBody');
    if(!a.fileData) return alert("No file uploaded.");
    b.innerHTML = a.fileData.includes("pdf") ? `<iframe src="${a.fileData}" width="100%" height="100%" style="border:none;"></iframe>` : `<img src="${a.fileData}" style="max-width:100%; display:block; margin:auto;">`;
    document.getElementById('proofModal').style.display = 'flex';
}

function generateGlobalReport() {
    const dataToExport = window.currentFilteredAchs && window.currentFilteredAchs.length > 0 ? window.currentFilteredAchs : adminAchs;
    if(dataToExport.length === 0) return alert("No achievements found matching your filters.");
    
    let csvContent = "Roll No,Student Name,Department,Semester,Title,Category,Date,Status\n";
    
    dataToExport.forEach(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const d = stu ? stu.dept : "N/A";
        const sm = stu ? stu.sem : "N/A";
        csvContent += `${a.studentRoll},${a.studentName},${d},${sm},${a.title},${a.category},${new Date(a.date).toLocaleDateString()},${a.status}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Filtered_Achievement_Report.csv";
    link.click();
}

// --- üü© SECURITY (CLEAN CREDENTIALS UPDATE) ---
async function loadCredentials() {
    const [usersRes, stuRes, facRes] = await Promise.all([
        fetch(`${API_URL}/users`), fetch(`${API_URL}/students`), fetch(`${API_URL}/faculty`)
    ]);
    const users = await usersRes.json();
    const students = await stuRes.json();
    const faculty = await facRes.json();

    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    
    users.forEach(u => {
        // Only show users that have an actual corresponding profile in the DB (or are admin)
        let isValidUser = false;
        if (u.role === 'admin') isValidUser = true;
        if (u.role === 'student' && students.some(s => s.rollNo === u.username)) isValidUser = true;
        if (u.role === 'faculty' && faculty.some(f => f.name.replace(/\s+/g, '').toLowerCase() === u.username)) isValidUser = true;

        if (isValidUser) {
            list.innerHTML += `<tr>
                <td><b>${u.username}</b></td>
                <td>${u.email || '-'}</td>
                <td><span class="status-pill status-${u.role}">${u.role}</span></td>
                <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
                <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
            </tr>`;
        }
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- SMART INACTIVITY NOTIFICATION ---
async function notifyInactiveStudents() {
    if(!confirm("Scan the system and email students who have been inactive for over 30 days?\n\nNote: Students who recently started an Internship will be skipped automatically.")) return;
    
    // Show loading state on button
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Scanning...`;
    btn.disabled = true;

    try {
        const res = await fetch(`${API_URL}/admin/notify-inactive`, { method: "POST" });
        const data = await res.json();
        alert("‚úÖ " + data.message);
    } catch(e) {
        alert("‚ùå Error sending notifications. Check server logs.");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html-->








<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EduAchieve | Admin Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f3f4f6; --sidebar-bg: #1e293b; --sidebar-text: #e2e8f0; --card-bg: #ffffff;
            --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb;
            --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444;
        }
        body.dark-mode {
            --bg-color: #0f172a; --sidebar-bg: #020617; --card-bg: #1e293b;
            --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); display: flex; transition: 0.3s; }

        /* SIDEBAR */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: var(--sidebar-text); position: fixed; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-menu { flex: 1; padding: 20px 0; }
        .menu-item { width: 100%; padding: 15px 25px; background: none; border: none; color: var(--sidebar-text); text-align: left; cursor: pointer; font-size: 15px; display: flex; gap: 12px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--primary); }
        
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .action-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-logout { background: #334155; color: white; }
        .btn-reset { background: #7f1d1d; color: #fecaca; }
        .theme-toggle { margin: 0 20px 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; text-align: center; display: justify-content: center; display: flex; gap: 8px; }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); min-height: 100vh; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & TABLES */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
        .stats-grid .card { cursor: pointer; transition: 0.2s; }
        .stats-grid .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        .card h2 { font-size: 28px; color: var(--primary); margin-top: 5px; }
        .card p { color: var(--text-muted); font-size: 14px; }

        .header-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        input, select { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); outline: none; }
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: var(--bg-color); color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        
        /* üü© FIXED STUDENT SQUARE CARDS (No Overlapping) */
        .student-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 25px; 
            margin-top: 20px; 
            align-items: stretch;
        }
        .student-card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            position: relative; 
            transition: 0.2s;
            min-height: 100%; 
            box-sizing: border-box;
            min-width: 0; 
            word-wrap: break-word; 
        }
        .student-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .student-card h4 { margin-bottom: 10px; color: var(--text-main); font-size: 16px; padding-right: 70px; line-height: 1.4; }
        .student-card p { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .student-card .actions { margin-top: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 15px; flex-wrap: wrap; }

        /* BADGES */
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .status-admin { background: #fee2e2; color: #b91c1c; } 
        .status-student { background: #dcfce7; color: #15803d; }
        .status-proctor { background: #d1fae5; color: #065f46; }
        .status-hod { background: #ffedd5; color: #9a3412; }
        .status-coord { background: #fef9c3; color: #854d0e; }
        .status-Approved { background: #dcfce7; color: #166534; }
        .status-Pending { background: #fef3c7; color: #92400e; }
        .status-Rejected { background: #fee2e2; color: #991b1b; }
        .count-badge { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 50%; font-size: 10px; }

        /* MODAL SYSTEM */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border-color); }
        .modal-content h3 { margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
        .form-group input, .form-group select { width: 100%; margin-bottom: 0; }
        
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 10px 0 20px; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

        .modal-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--danger); color: white; }
    </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header"> <i class="fas fa-graduation-cap"></i> EduAchieve </div>
  <div class="sidebar-menu">
    <button class="menu-item active" onclick="switchTab('dashboard', this)"> <i class="fas fa-th-large"></i> Dashboard </button>
    <button class="menu-item" onclick="switchTab('faculty', this)"> <i class="fas fa-chalkboard-teacher"></i> Faculty List </button>
    <button class="menu-item" onclick="switchTab('students', this)"> <i class="fas fa-user-graduate"></i> Students </button>
    <button class="menu-item" onclick="switchTab('allocations', this)"> <i class="fas fa-project-diagram"></i> Allocations </button>
    <button class="menu-item" onclick="switchTab('achievements', this)"> <i class="fas fa-trophy"></i> Achievements </button>
    <button class="menu-item" onclick="switchTab('security', this)"> <i class="fas fa-shield-alt"></i> Credentials </button>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> <span>Dark Mode</span> </div>
  <div class="sidebar-footer">
    <button class="action-btn btn-logout" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout </button>
    <button class="action-btn btn-reset" onclick="resetSystem()"> <i class="fas fa-trash-alt"></i> Reset System </button>
  </div>
</div>

<div class="main-content">

    <div id="dashboard" class="section active-section">
      <h1>System Overview</h1>
      <div class="stats-grid">
        <div class="card" onclick="switchTab('students', document.querySelectorAll('.menu-item')[2])">
            <p>Total Students</p><h2 id="totalStudents">0</h2>
        </div>
        <div class="card" onclick="switchTab('faculty', document.querySelectorAll('.menu-item')[1])">
            <p>Total Faculty</p><h2 id="totalFaculty">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>Unassigned Students</p><h2 id="unassignedStudents" style="color:#ef4444;">0</h2>
        </div>
        <div class="card" onclick="openActionModal()">
            <p>System Status</p><h2 id="actionCount" style="font-size: 18px;">Check Alerts</h2>
        </div>
      </div>
    </div>

    <div id="faculty" class="section">
      <div class="card">
          <h2>Faculty Directory</h2>
          <div class="header-actions">
            <input type="text" id="facultySearch" placeholder="Search by name..." onkeyup="renderFaculty()">
            <select id="facultyFilterDept" onchange="renderFaculty()"> 
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> 
            </select>
            <button class="btn btn-primary" onclick="openFacultyModal()">+ Add Faculty</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Dept</th><th>Roles</th><th>Contact & Notify</th><th>Actions</th></tr></thead>
              <tbody id="facultyList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="students" class="section">
      <div class="card">
          <h2>Student Enrollment</h2>
          <div class="header-actions">
            <input type="text" id="studentSearch" placeholder="Search Name/Roll..." onkeyup="renderStudents()">
            <select id="studentFilterDept" onchange="renderStudents()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <select id="studentFilterSem" onchange="renderStudents()"> <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option> </select>
            
            <button class="btn" style="background-color: #8b5cf6; color: white;" onclick="openPromoteModal()"> <i class="fas fa-level-up-alt"></i> Promote </button>
            <button class="btn" style="background-color: #10b981; color: white;" onclick="openCSVModal()"> <i class="fas fa-file-csv"></i> Bulk Upload </button>
            <button class="btn btn-primary" onclick="openStudentModal()">+ Add Student</button>
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="notifyInactiveStudents()"> <i class="fas fa-bell"></i> Alert Inactive </button>
          </div>
          
          <div class="table-container">
            <table>
              <thead><tr><th>Name</th><th>Roll No</th><th>Sem & Dept</th><th>Contact Info</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="studentList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="allocations" class="section">
      <div class="card">
          <h2>Proctor Allocations</h2>
          <div class="header-actions">
            <select id="allocFilterDept" onchange="renderAllocations()"> <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option> </select>
            <button class="btn" style="background-color: #f59e0b; color: white;" onclick="autoAllocate()"> <i class="fas fa-magic"></i> Auto-Allocate </button>
            <button class="btn" style="background-color: #374151; color: white;" onclick="printAllocations()"> <i class="fas fa-print"></i> Print Class List </button>
            <button class="btn btn-primary" onclick="openAllocationModal()">+ Assign Class</button>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Proctor Name</th><th>Department</th><th>Semester</th><th>Count</th><th>Actions</th></tr></thead>
              <tbody id="allocationList"></tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="achievements" class="section">
      <div class="card">
        <h2>Global Achievement Tracking</h2>
        
        <div class="header-actions" style="background: var(--bg-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
            <input type="text" id="achSearch" placeholder="Search Title, Name, Roll No..." onkeyup="renderAdminAchievements()" style="width: 200px; margin-bottom: 0;">
            <select id="achCat" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Categories</option><option value="Certificate">Certificate</option><option value="Internship">Internship</option><option value="Competition">Competition</option><option value="Extracurricular">Extracurricular</option><option value="Sports">Sports</option>
            </select>
            <select id="achDept" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Depts</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
            <select id="achSem" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Sem</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
            <select id="achMonth" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Months</option>
                <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
            </select>
            <select id="achYear" onchange="renderAdminAchievements()" style="margin-bottom: 0;">
                <option value="all">All Years</option>
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
            </select>
            
            <button class="btn" style="background-color: #10b981; color: white;" onclick="generateGlobalReport()"><i class="fas fa-file-excel"></i> Export Filtered</button>
        </div>

        <div id="achStats" style="margin-top: 15px; font-size: 14px; font-weight: 600; color: var(--primary);"></div>

        <div class="student-grid" id="adminAchGrid"></div>
      </div>
    </div>

    <div id="security" class="section">
      <div class="card">
        <h2><i class="fas fa-user-shield"></i> Credential Manager</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Password</th><th>Actions</th></tr></thead>
                <tbody id="credentialList"></tbody>
            </table>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="facultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add New Faculty</h3>
        <div class="form-group"><label>Full Name</label><input id="fName" oninput="autoFillEmail('faculty')"></div>
        <div class="form-group">
            <label>Departments (Select multiple for HOD)</label>
            <div class="checkbox-grid" id="fDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="fDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email Address</label><input id="fEmail" oninput="this.dataset.modified=true"></div>
        <div class="form-group"><label>Mobile Number</label><input id="fMobile"></div>
        <label>System Roles</label>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="fRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="fRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveFaculty()">Save Faculty</button>
        </div>
    </div>
</div>

<div class="modal" id="editFacultyModal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Faculty</h3>
        <div class="form-group"><label>Name</label><input id="editFName"></div>
        <div class="form-group">
            <label>Departments</label>
            <div class="checkbox-grid" id="editFDeptsBox">
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CE"><label>CE</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="IT"><label>IT</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="CSBS"><label>CSBS</label></div>
                <div class="checkbox-row"><input type="checkbox" name="editFDept" value="AI"><label>AI</label></div>
            </div>
        </div>
        <div class="form-group"><label>Email</label><input id="editFEmail"></div>
        <div class="form-group"><label>Mobile Number</label><input id="editFMobile"></div>
        <div class="checkbox-grid">
            <div class="checkbox-row"><input type="checkbox" id="editFRoleHOD"><label>HOD</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleCoord"><label>Coordinator</label></div>
            <div class="checkbox-row"><input type="checkbox" id="editFRoleProctor"><label>Proctor</label></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditFacultyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateFaculty()">Update Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-plus"></i> Add Student</h3>
        <div class="form-group"><label>Full Name</label><input id="sName"></div>
        <div class="form-group"><label>Roll Number</label><input id="sRoll" oninput="autoFillEmail('student')"></div>
        <div class="form-group"><label>Email</label><input id="sEmail" oninput="this.dataset.modified=true"></div>
        <div class="form-group"><label>Mobile</label><input id="sMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="sSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="sDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStudent()">Register Student</button>
        </div>
    </div>
</div>

<div class="modal" id="editStudentModal">
    <div class="modal-content">
        <h3><i class="fas fa-user-edit"></i> Edit Student</h3>
        <div class="form-group"><label>Full Name</label><input id="editSName"></div>
        <div class="form-group"><label>Roll Number</label><input id="editSRoll"></div>
        <div class="form-group"><label>Email</label><input id="editSEmail"></div>
        <div class="form-group"><label>Mobile</label><input id="editSMobile"></div>
        <div class="form-group"><label>Semester</label>
            <select id="editSSem">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="Graduated">Graduated</option>
            </select>
        </div>
        <div class="form-group"><label>Department</label>
            <select id="editSDept">
                <option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option>
            </select>
        </div>
        <div class="form-group"><label>Status</label>
            <select id="editSStatus">
                <option value="Enrolled">Enrolled</option>
                <option value="Alumni">Alumni</option>
                <option value="Detained">Detained</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateStudent()">Save Changes</button>
        </div>
    </div>
</div>

<div class="modal" id="csvModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;"><i class="fas fa-file-csv"></i> Bulk Student Upload</h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template</button>
        </div>
        <div class="form-group"><label>Department (Fallback)</label><select id="csvDept"><option value="" disabled selected>Select Dept</option><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester (Fallback)</label><select id="csvSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select CSV File</label><input type="file" id="csvFile" accept=".csv" style="border: 2px dashed var(--border-color); padding: 20px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
            <button class="btn btn-primary" onclick="processCSVUpload()">Upload Students</button>
        </div>
    </div>
</div>

<div class="modal" id="allocationModal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> Assign/Edit Proctor Class</h3>
        <div class="form-group"><label>Department</label><select id="allocDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Semester</label><select id="allocSem"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
        <div class="form-group"><label>Select Proctor</label><select id="allocFaculty"></select></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeAllocationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveClassAllocation()">Confirm Assignment</button>
        </div>
    </div>
</div>

<div class="modal" id="actionModal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Action Required</h3>
        <p style="color: var(--text-muted); margin-bottom:15px;">Students without an assigned proctor:</p>
        <div id="unassignedList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); padding:10px; border-radius:8px; background: var(--bg-color);"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="switchTab('allocations', document.querySelectorAll('.menu-item')[3]); closeActionModal();">Go to Allocations</button>
            <button class="btn btn-secondary" onclick="closeActionModal()">Close</button>
        </div>
    </div>
</div>

<div class="modal" id="userEditModal">
    <div class="modal-content">
        <h3>Update User</h3>
        <p>User: <b id="editUserTitle"></b></p>
        <div class="form-group"><label>Email</label><input type="email" id="editUserEmail"></div>
        <div class="form-group"><label>New Password</label><input type="text" id="editUserPwd" placeholder="Leave blank to keep current"></div>
        <div class="modal-btns">
            <button class="btn btn-primary" onclick="saveUserCredentials()">Update</button>
            <button class="btn btn-secondary" onclick="closeUserEditModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="modal" id="promoteModal">
    <div class="modal-content">
        <h3>üöÄ Promote Batch</h3>
        <div class="form-group"><label>Dept</label><select id="promDept"><option value="CE">CE</option><option value="IT">IT</option><option value="CSBS">CSBS</option><option value="AI">AI</option></select></div>
        <div class="form-group"><label>Promotion Step</label>
            <select id="promSem"><option value="1">Sem 1 -> 2</option><option value="2">Sem 2 -> 3</option><option value="3">Sem 3 -> 4</option><option value="4">Sem 4 -> 5</option><option value="5">Sem 5 -> 6</option><option value="6">Sem 6 -> 7</option><option value="7">Sem 7 -> 8</option><option value="8">Sem 8 -> Alumni</option></select>
        </div>
        <div class="form-group">
            <label>Detained Students (Stay in Current Sem)</label>
            <input type="text" id="promDetained" placeholder="Comma separated Roll Nos (e.g. CS01, CS02)">
        </div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closePromoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="promoteStudents()">Promote Batch</button>
        </div>
    </div>
</div>

<div class="modal" id="adminStudentAchModal" style="z-index: 1500;">
    <div class="modal-content" style="width: 800px; max-width: 90%;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;"><i class="fas fa-folder-open"></i> Student Documents</h3>
            <button onclick="document.getElementById('adminStudentAchModal').style.display='none'" style="border:none; background:none; font-size:24px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Title</th><th>Category</th><th>Completion Date</th><th>Status</th><th>Proof</th></tr></thead>
                <tbody id="adminStudentAchList"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="proofModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="width: 80%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <h3 style="margin:0;">Document Preview</h3>
            <button onclick="document.getElementById('proofModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        <div id="proofBody" style="flex:1; background:#525659; overflow:auto; border-radius:8px;"></div>
    </div>
</div>

<script>
const API_URL = "http://localhost:5000";

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.querySelector('.theme-toggle span').innerText = isDark ? 'Light Mode' : 'Dark Mode';
    document.querySelector('.theme-toggle i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}
if(localStorage.getItem('theme') === 'dark') toggleTheme();

function switchTab(id, btn) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active-section"));
    document.querySelectorAll(".menu-item").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active-section");
    if(btn) btn.classList.add("active");
    if (id === "dashboard") loadDashboard();
    if (id === "faculty") loadFaculty();
    if (id === "students") loadStudents();
    if (id === "allocations") loadAllocations();
    if (id === "achievements") loadAdminAchievements();
    if (id === "security") loadCredentials();
}

function autoFillEmail(type) {
    if (type === 'student') {
        const roll = document.getElementById('sRoll').value;
        const emailInput = document.getElementById('sEmail');
        if (!emailInput.dataset.modified) emailInput.value = roll ? `${roll.toLowerCase()}@student.edu` : "";
    } else if (type === 'faculty') {
        const name = document.getElementById('fName').value;
        const emailInput = document.getElementById('fEmail');
        if (!emailInput.dataset.modified) emailInput.value = name ? `${name.replace(/\s+/g, '').toLowerCase()}@edu.com` : "";
    }
}

// --- DASHBOARD & ALERTS ---
let unassignedStudentsList = [];
async function loadDashboard() {
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const f = await fetch(`${API_URL}/faculty`).then(r => r.json());
    unassignedStudentsList = s.filter(i => !i.proctorId);
    document.getElementById("totalStudents").innerText = s.length;
    document.getElementById("totalFaculty").innerText = f.length;
    document.getElementById("unassignedStudents").innerText = unassignedStudentsList.length;
}

function openActionModal() {
    const listDiv = document.getElementById("unassignedList");
    listDiv.innerHTML = unassignedStudentsList.length ? "" : "<p>All students are assigned! üéâ</p>";
    unassignedStudentsList.forEach(s => {
        listDiv.innerHTML += `<div style="border-bottom:1px solid var(--border-color); padding:8px; font-size:13px;"><b>${s.name}</b> (${s.dept} Sem ${s.sem})</div>`;
    });
    document.getElementById("actionModal").style.display = "flex";
}
function closeActionModal() { document.getElementById("actionModal").style.display = "none"; }

// --- FACULTY ---
let allFaculty = [], allStudents = [];
let currentEditFacultyId = null;

async function loadFaculty() {
    const [f, s] = await Promise.all([fetch(`${API_URL}/faculty`), fetch(`${API_URL}/students`)]);
    allFaculty = await f.json(); allStudents = await s.json();
    renderFaculty();
}

function renderFaculty() {
    const search = document.getElementById("facultySearch").value.toLowerCase();
    const filterDept = document.getElementById("facultyFilterDept").value;
    const list = document.getElementById("facultyList"); list.innerHTML = "";
    
    allFaculty.filter(f => {
        const matchesName = f.name.toLowerCase().includes(search);
        const depts = Array.isArray(f.dept) ? f.dept : [f.dept];
        const matchesDept = filterDept === "all" || depts.includes(filterDept);
        return matchesName && matchesDept;
    }).forEach(f => {
        const myStudents = allStudents.filter(s => s.proctorId === f._id);
        const deptDisplay = Array.isArray(f.dept) ? f.dept.join(", ") : f.dept;
        
        let roles = [];
        if(f.roles?.hod) roles.push('<span class="status-pill status-hod">HOD</span>');
        if(f.roles?.coordinator) roles.push('<span class="status-pill status-coord">Coord</span>');
        if(f.roles?.proctor) roles.push(`<span class="status-pill status-proctor">Proctor <span class="count-badge">${myStudents.length}</span></span>`);

        list.innerHTML += `<tr>
            <td><b>${f.name}</b></td>
            <td>${deptDisplay}</td>
            <td>${roles.join(" ")}</td>
            <td>
                <small><i class="fas fa-envelope"></i> ${f.email || 'N/A'}<br><i class="fas fa-phone"></i> ${f.mobile || 'N/A'}</small>
                <div style="margin-top:5px; display:flex; gap:5px;">
                    <button class="btn" style="background:#25D366; color:white; padding: 4px 8px; font-size:12px;" onclick="notifyWhatsApp('${f.mobile}', '${f.name}')" title="WhatsApp Notify"><i class="fab fa-whatsapp"></i></button>
                    <button class="btn" style="background:#ea4335; color:white; padding: 4px 8px; font-size:12px;" onclick="notifyEmail('${f.email}', '${f.name}')" title="Email Notify"><i class="fas fa-envelope"></i></button>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditFacultyModal('${f._id}')"><i class="fas fa-edit"></i> Edit</button> 
                <button class="btn btn-sm btn-danger" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i></button>
            </td></tr>`;
    });
}

function notifyWhatsApp(mobile, name) {
    if(!mobile || mobile === 'undefined') return alert("No mobile number provided for this faculty.");
    const msg = `Hello ${name}, you have been assigned new roles/proctoring duties in the EduAchieve Portal. Please login to check your dashboard.`;
    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
}

async function notifyEmail(email, name) {
    if(!email || email === 'undefined') return alert("No email provided.");
    if(confirm(`Send email notification to ${email}?`)) {
        await fetch(`${API_URL}/notify-faculty`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, name })
        });
        alert("Email sent!");
    }
}

function openFacultyModal() { document.getElementById("facultyModal").style.display="flex"; }
function closeFacultyModal() { 
    document.getElementById("facultyModal").style.display="none"; 
    document.querySelectorAll('input[name="fDept"]').forEach(cb => cb.checked = false);
    document.getElementById("fEmail").dataset.modified = "";
}

async function saveFaculty() {
    const n = document.getElementById("fName").value; 
    const e = document.getElementById("fEmail").value;
    const m = document.getElementById("fMobile").value;
    const depts = Array.from(document.querySelectorAll('input[name="fDept"]:checked')).map(cb => cb.value);
    
    if(depts.length === 0) return alert("Select at least one department");

    const r = { 
        hod: document.getElementById("fRoleHOD").checked, 
        coordinator: document.getElementById("fRoleCoord").checked, 
        proctor: document.getElementById("fRoleProctor").checked 
    };

    const res = await fetch(`${API_URL}/faculty`, { 
        method: "POST", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, dept:depts, email:e, mobile:m, roles:r}) 
    });
    
    if(!res.ok) return alert("Error adding faculty");
    
    alert("‚úÖ Faculty Added Successfully!");
    closeFacultyModal(); loadFaculty();
}

function openEditFacultyModal(id) {
    const f = allFaculty.find(x => x._id === id); if(!f) return;
    currentEditFacultyId = id;
    document.getElementById("editFName").value = f.name; 
    document.getElementById("editFEmail").value = f.email || "";
    document.getElementById("editFMobile").value = f.mobile || "";
    
    const facultyDepts = Array.isArray(f.dept) ? f.dept : [f.dept];
    document.querySelectorAll('input[name="editFDept"]').forEach(cb => {
        cb.checked = facultyDepts.includes(cb.value);
    });

    document.getElementById("editFRoleHOD").checked = f.roles?.hod; 
    document.getElementById("editFRoleCoord").checked = f.roles?.coordinator; 
    document.getElementById("editFRoleProctor").checked = f.roles?.proctor;
    document.getElementById("editFacultyModal").style.display = "flex";
}

function closeEditFacultyModal() { document.getElementById("editFacultyModal").style.display = "none"; }

async function updateFaculty() {
    const name = document.getElementById("editFName").value; 
    const email = document.getElementById("editFEmail").value;
    const mobile = document.getElementById("editFMobile").value;
    const depts = Array.from(document.querySelectorAll('input[name="editFDept"]:checked')).map(cb => cb.value);
    
    const roles = { 
        hod: document.getElementById("editFRoleHOD").checked, 
        coordinator: document.getElementById("editFRoleCoord").checked, 
        proctor: document.getElementById("editFRoleProctor").checked 
    };

    await fetch(`${API_URL}/faculty/${currentEditFacultyId}`, { 
        method: "PUT", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name, dept: depts, email, mobile, roles}) 
    });
    closeEditFacultyModal(); loadFaculty();
}

// --- STUDENTS ---
async function loadStudents() {
    allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    renderStudents();
}

function renderStudents() {
    const search = document.getElementById("studentSearch").value.toLowerCase();
    const dept = document.getElementById("studentFilterDept").value;
    const sem = document.getElementById("studentFilterSem").value;
    const list = document.getElementById("studentList"); 
    list.innerHTML = "";
    
    allStudents.filter(s => 
        (s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search)) && 
        (dept === "all" || s.dept === dept) && 
        (sem === "all" || String(s.sem) === sem)
    ).forEach(s => {
        let statusColor = s.status === 'Enrolled' ? 'status-student' : 'status-coord';
        if(s.status === 'Alumni') statusColor = 'status-proctor';
        if(s.status === 'Detained') statusColor = 'status-admin';

        list.innerHTML += `<tr>
            <td><b>${s.name}</b></td>
            <td>${s.rollNo}</td>
            <td>Sem ${s.sem} <br><small style="color:var(--text-muted)">${s.dept}</small></td>
            <td><small><i class="fas fa-envelope"></i> ${s.email || '-'}<br><i class="fas fa-phone"></i> ${s.mobile || '-'}</small></td>
            <td><span class="status-pill ${statusColor}">${s.status}</span></td>
            <td>
                <button class="btn btn-sm btn-primary" style="padding:6px 10px;" onclick="openEditStudentModal('${s._id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" style="padding:6px 10px;" onclick="deleteStudent('${s._id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function openStudentModal() { document.getElementById("studentModal").style.display="flex"; }
function closeStudentModal() { 
    document.getElementById("studentModal").style.display="none"; 
    document.getElementById("sEmail").dataset.modified = "";
}

async function saveStudent() {
    const n = document.getElementById("sName").value; 
    const r = document.getElementById("sRoll").value; 
    const e = document.getElementById("sEmail").value;
    const m = document.getElementById("sMobile").value;
    const s = document.getElementById("sSem").value; 
    const d = document.getElementById("sDept").value;
    
    const res = await fetch(`${API_URL}/students`, { 
        method: "POST", headers: {"Content-Type":"application/json"}, 
        body: JSON.stringify({name:n, rollNo:r, email:e, mobile:m, sem:s, dept:d}) 
    });
    
    const data = await res.json();
    if (!res.ok) {
        alert("‚ö†Ô∏è " + (data.message || "Failed to register student"));
        return;
    }
    
    alert("‚úÖ " + data.message);
    closeStudentModal(); loadStudents();
}

function openEditStudentModal(id) {
    const s = allStudents.find(x => x._id === id);
    if (!s) return;
    currentEditStudentId = id;
    document.getElementById("editSName").value = s.name;
    document.getElementById("editSRoll").value = s.rollNo;
    document.getElementById("editSEmail").value = s.email || "";
    document.getElementById("editSMobile").value = s.mobile || "";
    document.getElementById("editSSem").value = s.sem;
    document.getElementById("editSDept").value = s.dept;
    document.getElementById("editSStatus").value = s.status || "Enrolled";
    document.getElementById("editStudentModal").style.display = "flex";
}
function closeEditStudentModal() { document.getElementById("editStudentModal").style.display = "none"; }

async function updateStudent() {
    const payload = {
        name: document.getElementById("editSName").value,
        rollNo: document.getElementById("editSRoll").value,
        email: document.getElementById("editSEmail").value,
        mobile: document.getElementById("editSMobile").value,
        sem: document.getElementById("editSSem").value,
        dept: document.getElementById("editSDept").value,
        status: document.getElementById("editSStatus").value
    };
    await fetch(`${API_URL}/students/${currentEditStudentId}`, {
        method: "PUT", headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    closeEditStudentModal(); loadStudents();
}

// --- PROMOTION WITH EXCEPTIONS ---
function openPromoteModal() { document.getElementById("promoteModal").style.display = "flex"; }
function closePromoteModal() { document.getElementById("promoteModal").style.display = "none"; }
async function promoteStudents() {
    const dept = document.getElementById("promDept").value; 
    const fromSem = document.getElementById("promSem").value;
    const detainedStr = document.getElementById("promDetained").value;
    
    const detainedRolls = detainedStr.split(",").map(s => s.trim()).filter(s => s !== "");

    let msg = `Promote ${dept} Sem ${fromSem}?`;
    if(detainedRolls.length > 0) msg += `\n\nEXCLUDING DETAINED STUDENTS:\n${detainedRolls.join(", ")}`;

    if(confirm(msg)) {
        const res = await fetch(`${API_URL}/students/promote`, { 
            method: "POST", headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ dept, fromSem, detainedRolls }) 
        });
        const data = await res.json(); 
        alert(data.message); closePromoteModal(); loadStudents();
    }
}

// --- CSV BULK UPLOAD WITH DUPLICATE CHECK ---
function openCSVModal() { document.getElementById("csvModal").style.display = "flex"; }
function closeCSVModal() { document.getElementById("csvModal").style.display = "none"; }

function downloadTemplate() {
    const csv = "Name,RollNo,Department,Semester,Email,Mobile\nJohn Doe,CS001,CE,3,john@student.edu,9876543210\nJane Smith,CS002,IT,3,jane@student.edu,9123456780";
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Bulk_Upload_Template.csv";
    link.click();
}

function processCSVUpload() {
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Select a CSV File");
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const rows = e.target.result.split('\n');
        let data = [], duplicates = [];
        const start = rows[0].toLowerCase().includes('name') ? 1 : 0; 
        
        for(let i = start; i < rows.length; i++) {
            if(!rows[i].trim()) continue;
            const c = rows[i].split(',');
            if(c.length >= 2) {
                let name = c[0].trim();
                let roll = c[1].trim();
                let dept = c[2] ? c[2].trim() : document.getElementById("csvDept")?.value || "Gen"; 
                let sem = c[3] ? c[3].trim() : document.getElementById("csvSem")?.value || "1";
                let email = (c[4] && c[4].includes('@')) ? c[4].trim() : `${roll}@student.edu`;
                let mobile = c[5] ? c[5].trim() : "";

                if (allStudents.some(s => s.rollNo === roll)) {
                    duplicates.push(roll);
                } else if (name && roll) {
                    data.push({ name, rollNo: roll, email, mobile, sem, dept, status:'Enrolled' });
                }
            }
        }

        if (duplicates.length > 0) {
            alert(`‚ö†Ô∏è The following ${duplicates.length} students already exist and will be skipped:\n${duplicates.join(', ')}`);
        }
        if (data.length === 0) return alert("No new valid students to upload.");

        if(confirm(`Proceed to upload ${data.length} new students?`)) {
            await fetch(`${API_URL}/students/bulk`, { 
                method: "POST", headers: {"Content-Type":"application/json"}, 
                body: JSON.stringify(data) 
            });
            closeCSVModal(); loadStudents();
        }
    };
    reader.readAsText(file);
}

// --- ALLOCATION ---
async function loadAllocations() {
    await loadFaculty();
    const s = await fetch(`${API_URL}/students`).then(r => r.json());
    const list = document.getElementById("allocationList"); list.innerHTML = "";
    const filter = document.getElementById("allocFilterDept").value;
    const groups = {};
    s.forEach(st => { if(st.proctorId) { const k = `${st.proctorId}-${st.dept}-${st.sem}`; if(!groups[k]) groups[k] = { pid: st.proctorId, d: st.dept, s: st.sem, c: 0 }; groups[k].c++; }});
    Object.values(groups).forEach(g => {
        if(filter !== "all" && g.d !== filter) return;
        const pname = allFaculty.find(f => f._id === g.pid)?.name || "Unknown";
        list.innerHTML += `<tr>
            <td style="color:var(--primary); font-weight:bold">${pname}</td>
            <td>${g.d}</td>
            <td>Sem ${g.s}</td>
            <td><span class="status-pill status-proctor">${g.c} Students</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditAllocation('${g.d}', '${g.s}', '${g.pid}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-danger" onclick="unassign('${g.d}', '${g.s}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}
function openAllocationModal() { 
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocationModal").style.display="flex"; 
}

function openEditAllocation(dept, sem, facultyId) {
    document.getElementById("allocDept").value = dept;
    document.getElementById("allocSem").value = sem;
    document.getElementById("allocFaculty").innerHTML = allFaculty.filter(f => f.roles?.proctor).map(f => `<option value="${f._id}">${f.name}</option>`).join("");
    document.getElementById("allocFaculty").value = facultyId;
    
    document.getElementById("allocDept").disabled = true;
    document.getElementById("allocSem").disabled = true;
    document.getElementById("allocationModal").style.display = "flex";
}

function closeAllocationModal() { 
    document.getElementById("allocationModal").style.display="none"; 
    document.getElementById("allocDept").disabled = false;
    document.getElementById("allocSem").disabled = false;
}

async function saveClassAllocation() {
    const d = document.getElementById("allocDept").value; const s = document.getElementById("allocSem").value; const f = document.getElementById("allocFaculty").value;
    await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: f }) });
    closeAllocationModal(); loadAllocations();
}
async function unassign(d, s) { if(confirm("Remove Proctor Assignment?")) { await fetch(`${API_URL}/allocate/class`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ dept: d, sem: s, facultyId: null }) }); loadAllocations(); } }

async function autoAllocate() {
    if(!confirm("Automatically distribute ALL unassigned students to available proctors in their departments?")) return;
    try {
        const res = await fetch(`${API_URL}/allocate/auto`, { method: "POST" });
        const data = await res.json();
        alert(data.message);
        loadAllocations(); loadDashboard(); 
    } catch(e) { alert("Server error during auto-allocation."); }
}

async function printAllocations() {
    await loadFaculty();
    const students = await fetch(`${API_URL}/students`).then(r => r.json());
    students.sort((a, b) => (a.dept > b.dept) ? 1 : (a.dept === b.dept) ? ((a.sem > b.sem) ? 1 : -1) : -1);

    const printWindow = window.open('', '', 'height=600,width=800');
    let html = `<html><head><title>Class Lists - EduAchieve</title><style>body{font-family:'Segoe UI',sans-serif;padding:20px;}.class-header{background:#1e293b;color:white;padding:10px;font-size:18px;font-weight:bold;margin-top:20px;border-radius:6px 6px 0 0;}table{width:100%;border-collapse:collapse;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:14px;}th{background-color:#f3f4f6;font-weight:bold;}.page-break{page-break-before:always;}.footer{text-align:center;font-size:12px;color:#666;margin-top:10px;}</style></head><body><h1 style="text-align:center; color:#2563eb;">EduAchieve - Master Class List</h1>`;

    let currentClass = "";
    let isFirst = true;

    students.forEach(s => {
        const studentClass = `${s.dept} - Semester ${s.sem}`;
        const proctorName = s.proctorId ? (allFaculty.find(f => f._id === s.proctorId)?.name || "Unknown") : "<span style='color:red'>Unassigned</span>";

        if (studentClass !== currentClass) {
            if (!isFirst) html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div><div class="page-break"></div>`;
            html += `<div class="class-header">${studentClass}</div><table><thead><tr><th width="15%">Roll No</th><th width="45%">Student Name</th><th width="40%">Assigned Proctor</th></tr></thead><tbody>`;
            currentClass = studentClass;
            isFirst = false;
        }
        html += `<tr><td><b>${s.rollNo}</b></td><td>${s.name}</td><td>${proctorName}</td></tr>`;
    });

    html += `</tbody></table><div class="footer">Generated by EduAchieve Admin Console</div></body></html>`;
    printWindow.document.write(html); printWindow.document.close(); printWindow.print();
}

// --- üü© ADMIN ACHIEVEMENT TRACKING (SAFE DATES & FIX CSS) ---
let adminAchs = [];
window.currentFilteredAchs = []; 

async function loadAdminAchievements() {
    adminAchs = await fetch(`${API_URL}/achievements`).then(r => r.json());
    if (allStudents.length === 0) {
        allStudents = await fetch(`${API_URL}/students`).then(r => r.json());
    }
    renderAdminAchievements();
}

function renderAdminAchievements() {
    const search = document.getElementById("achSearch").value.toLowerCase();
    const cat = document.getElementById("achCat").value;
    const dept = document.getElementById("achDept").value;
    const sem = document.getElementById("achSem").value;
    const month = document.getElementById("achMonth").value;
    const year = document.getElementById("achYear").value;

    const grid = document.getElementById("adminAchGrid"); 
    grid.innerHTML = "";
    
    // üü© FLAW FIX: SAFE DATE PARSING
    window.currentFilteredAchs = adminAchs.filter(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll) || {};
        const sDept = stu.dept || "Unknown";
        const sSem = stu.sem || "Unknown";
        
        let aMonth = "0", aYear = "0";
        if (a.completionDate || a.date) {
            const compDate = new Date(a.completionDate || a.date);
            if (!isNaN(compDate.getTime())) {
                aMonth = (compDate.getMonth() + 1).toString();
                aYear = compDate.getFullYear().toString();
            }
        }

        const matchSearch = (a.studentName && a.studentName.toLowerCase().includes(search)) || 
                            (a.studentRoll && a.studentRoll.toLowerCase().includes(search)) || 
                            (a.title && a.title.toLowerCase().includes(search));
        
        const matchCat = cat === "all" || a.category === cat;
        const matchDept = dept === "all" || sDept === dept;
        const matchSem = sem === "all" || String(sSem) === sem;
        const matchMonth = month === "all" || aMonth === month;
        const matchYear = year === "all" || aYear === year;

        return matchSearch && matchCat && matchDept && matchSem && matchMonth && matchYear;
    });

    const studentGroups = {};
    let approvedCount = 0, pendingCount = 0, rejectedCount = 0;

    window.currentFilteredAchs.forEach(a => {
        if(!studentGroups[a.studentRoll]) {
            studentGroups[a.studentRoll] = { name: a.studentName, roll: a.studentRoll, achs: [], approved: 0, pending: 0, rejected: 0 };
        }
        studentGroups[a.studentRoll].achs.push(a);
        if(a.status === 'Approved') { studentGroups[a.studentRoll].approved++; approvedCount++; }
        if(a.status === 'Pending') { studentGroups[a.studentRoll].pending++; pendingCount++; }
        if(a.status === 'Rejected') { studentGroups[a.studentRoll].rejected++; rejectedCount++; }
    });

    document.getElementById("achStats").innerHTML = `<i class="fas fa-filter"></i> Found ${window.currentFilteredAchs.length} documents across ${Object.keys(studentGroups).length} students (‚úÖ ${approvedCount} Approved | ‚è≥ ${pendingCount} Pending | ‚ùå ${rejectedCount} Rejected)`;

    Object.values(studentGroups).forEach(group => {
        const stu = allStudents.find(s => s.rollNo === group.roll);
        const deptSem = stu ? `${stu.dept} | Sem ${stu.sem}` : `<span style="color:#ef4444;">Unknown</span>`;

        grid.innerHTML += `
            <div class="student-card">
                <div>
                    <h4>${group.name}</h4>
                    <p><b>Roll No:</b> ${group.roll}</p>
                    <p><b>Class:</b> ${deptSem}</p>
                    <div style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                        <span class="status-pill status-Approved">${group.approved} Approved</span>
                        <span class="status-pill status-Pending">${group.pending} Pending</span>
                        ${group.rejected > 0 ? `<span class="status-pill status-Rejected">${group.rejected} Rejected</span>` : ''}
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-primary" style="flex:1;" onclick="openStudentAchModal('${group.roll}')"><i class="fas fa-folder-open"></i> View ${group.achs.length} Docs</button>
                </div>
            </div>`;
    });
}

function openStudentAchModal(rollNo) {
    const list = document.getElementById("adminStudentAchList");
    list.innerHTML = "";
    const achs = window.currentFilteredAchs.filter(a => a.studentRoll === rollNo);
    
    achs.forEach(a => {
        const compDate = a.completionDate || a.date || '-';
        list.innerHTML += `
            <tr>
                <td><b>${a.title}</b></td>
                <td>${a.category}</td>
                <td>${compDate}</td>
                <td><span class="status-pill status-${a.status}">${a.status}</span></td>
                <td><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="openProofModal('${a._id}')"><i class="fas fa-eye"></i></button></td>
            </tr>`;
    });
    document.getElementById("adminStudentAchModal").style.display = "flex";
}

function openProofModal(id) {
    const a = adminAchs.find(i => i._id === id);
    const b = document.getElementById('proofBody');
    if(!a.fileData) return alert("No file uploaded.");
    b.innerHTML = a.fileData.includes("pdf") ? `<iframe src="${a.fileData}" width="100%" height="100%" style="border:none;"></iframe>` : `<img src="${a.fileData}" style="max-width:100%; display:block; margin:auto;">`;
    document.getElementById('proofModal').style.display = 'flex';
}

// üü© FLAW FIX: MISSING DATES IN EXPORT
function generateGlobalReport() {
    const dataToExport = window.currentFilteredAchs && window.currentFilteredAchs.length > 0 ? window.currentFilteredAchs : adminAchs;
    if(dataToExport.length === 0) return alert("No achievements found matching your filters.");
    
    let csvContent = "Roll No,Student Name,Department,Semester,Title,Category,Completion Date,Upload Date,Status\n";
    
    dataToExport.forEach(a => {
        const stu = allStudents.find(s => s.rollNo === a.studentRoll);
        const d = stu ? stu.dept : "N/A";
        const sm = stu ? stu.sem : "N/A";
        const comp = a.completionDate || a.date || '-';
        const up = a.uploadDate || '-';

        csvContent += `${a.studentRoll},${a.studentName},${d},${sm},${a.title},${a.category},${comp},${up},${a.status}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Filtered_Achievement_Report.csv";
    link.click();
}

// --- SECURITY ---
async function loadCredentials() {
    const [usersRes, stuRes, facRes] = await Promise.all([
        fetch(`${API_URL}/users`), fetch(`${API_URL}/students`), fetch(`${API_URL}/faculty`)
    ]);
    const users = await usersRes.json();
    const students = await stuRes.json();
    const faculty = await facRes.json();

    const list = document.getElementById("credentialList"); 
    list.innerHTML = "";
    
    users.forEach(u => {
        let isValidUser = false;
        if (u.role === 'admin') isValidUser = true;
        if (u.role === 'student' && students.some(s => s.rollNo === u.username)) isValidUser = true;
        if (u.role === 'faculty' && faculty.some(f => f.name.replace(/\s+/g, '').toLowerCase() === u.username)) isValidUser = true;

        if (isValidUser) {
            list.innerHTML += `<tr>
                <td><b>${u.username}</b></td>
                <td>${u.email || '-'}</td>
                <td><span class="status-pill status-${u.role}">${u.role}</span></td>
                <td><span style="color:#10b981; font-weight:bold;"><i class="fas fa-lock"></i> Encrypted</span></td>
                <td><button class="btn btn-sm btn-primary" onclick="openUserEdit('${u.username}','${u.email}')">Edit</button></td>
            </tr>`;
        }
    });
}
function openUserEdit(u, e) { currentEditUserId = u; document.getElementById("editUserTitle").innerText = u; document.getElementById("editUserEmail").value = (e&&e!=='undefined')?e:''; document.getElementById("userEditModal").style.display="flex"; }
function closeUserEditModal() { document.getElementById("userEditModal").style.display="none"; }
async function saveUserCredentials() {
    const email = document.getElementById("editUserEmail").value; const password = document.getElementById("editUserPwd").value;
    const p = { username: currentEditUserId, email }; if(password) p.password = password;
    await fetch(`${API_URL}/admin/update-user`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(p) });
    closeUserEditModal(); loadCredentials();
}

// --- SMART INACTIVITY NOTIFICATION ---
async function notifyInactiveStudents() {
    if(!confirm("Scan the system and email students who have been inactive for over 30 days?\n\nNote: Students who recently started an Internship will be skipped automatically.")) return;
    
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Scanning...`;
    btn.disabled = true;

    try {
        const res = await fetch(`${API_URL}/admin/notify-inactive`, { method: "POST" });
        const data = await res.json();
        alert("‚úÖ " + data.message);
    } catch(e) {
        alert("‚ùå Error sending notifications. Check server logs.");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// --- HELPERS ---
async function deleteFaculty(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/faculty/${id}`, {method:"DELETE"}); loadFaculty(); }}
async function deleteStudent(id) { if(confirm("Delete?")) { await fetch(`${API_URL}/students/${id}`, {method:"DELETE"}); loadStudents(); }}
function logout() { localStorage.clear(); window.location.href = "login.html"; }
function resetSystem() { if(confirm("Reset System?")) alert("System Reset (Demo)"); }

document.addEventListener("DOMContentLoaded", () => { loadDashboard(); });
</script>

</body>
</html>